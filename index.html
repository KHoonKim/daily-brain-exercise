<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>매일매일 두뇌운동</title>
<link rel="icon" type="image/png" href="favicon.png">
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<meta property="og:image" content="https://littlesunnydays.com/appintos/brain-fit/icon-512.png">
<meta property="og:title" content="매일매일 두뇌운동">
<meta property="og:description" content="38가지 두뇌 훈련 게임으로 매일 두뇌를 운동하세요!">
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<style>
@import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.min.css');

*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;touch-action:manipulation}
:root{
  --p:#3182F6;--p-dark:#1B64DA;--p-light:#EBF3FE;
  --bg:#F7F8FA;--card:#fff;--text:#191F28;--sub:#8B95A1;--border:#E5E8EB;
  --ok:#1FC58E;--ok-bg:#E8FAF0;--no:#F04452;--no-bg:#FEE7E9;
  --combo:#FF8A00;--purple:#8B5CF6;--pink:#EC4899;
  --r12:12px;--r16:16px;--r20:20px;--r-full:9999px;
  --shadow:0 2px 8px rgba(0,0,0,0.06);
  --font:'Pretendard',-apple-system,BlinkMacSystemFont,'Apple SD Gothic Neo',sans-serif;
}
body{font-family:var(--font);background:var(--bg);color:var(--text);overflow-x:hidden;user-select:none;-webkit-user-select:none}
.app{max-width:480px;margin:0 auto;min-height:100vh;min-height:100dvh}

/* Toast */
/* TDS Toast */
.toast{position:fixed;bottom:32px;left:50%;transform:translateX(-50%) translateY(20px);background:rgba(25,31,40,.9);color:#fff;padding:12px 24px;border-radius:12px;font-size:14px;font-weight:600;z-index:999;opacity:0;pointer-events:none;transition:all .3s cubic-bezier(.32,.72,0,1);white-space:nowrap;backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);box-shadow:0 4px 16px rgba(0,0,0,.12)}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
.snackbar{position:fixed;top:0;left:0;right:0;z-index:998;transform:translateY(-100%);transition:transform .35s cubic-bezier(.32,.72,0,1);pointer-events:none}
.snackbar.show{transform:translateY(0)}
.snackbar-inner{display:flex;align-items:center;justify-content:center;gap:8px;padding:14px 20px;padding-top:calc(14px + env(safe-area-inset-top));background:var(--p);color:#fff;font-size:14px;font-weight:700;box-shadow:0 4px 12px rgba(49,130,246,.3)}

/* ===== HOME ===== */
.home{padding:16px 16px 120px;overflow-y:auto;height:100vh;height:100dvh}
.home-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.home-header h1{font-size:22px;font-weight:800}
.home-header-r{display:flex;align-items:center;gap:8px}
.streak{background:var(--p);color:#fff;padding:4px 12px;border-radius:var(--r-full);font-size:13px;font-weight:700}

/* Profile Card */
.profile-card{background:linear-gradient(135deg,#3182F6,#8B5CF6);border-radius:var(--r20);padding:20px;color:#fff;margin-bottom:16px;box-shadow:0 4px 16px rgba(49,130,246,.25);position:relative;overflow:hidden}
.profile-card::after{content:'';position:absolute;top:-40px;right:-40px;width:120px;height:120px;border-radius:50%;background:rgba(255,255,255,.08)}
.pc-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px}
.pc-rank{display:flex;align-items:center;gap:8px}
.pc-rank-badge{width:44px;height:44px;border-radius:50%;background:rgba(255,255,255,.2);display:flex;align-items:center;justify-content:center;font-size:24px}
.pc-rank-info .pc-rank-name{font-size:16px;font-weight:700}
.pc-rank-info .pc-rank-next{font-size:11px;opacity:.7;margin-top:2px}
.pc-score-big{text-align:right}
.pc-score-big .label{font-size:11px;opacity:.7}
.pc-score-big .val{font-size:36px;font-weight:800;line-height:1.1}
/* XP Bar */
/* TDS ProgressBar */
.xp-bar{margin-top:12px}
.xp-bar-label{display:flex;justify-content:space-between;font-size:11px;color:var(--sub);margin-bottom:6px}
.xp-bar-track{height:4px;border-radius:2px;background:rgba(25,31,40,.06);overflow:hidden}
.xp-bar-fill{height:100%;border-radius:2px;background:#3182F6;transition:width .5s cubic-bezier(.32,.72,0,1)}
/* Category mini chart */
.pc-cats{display:flex;gap:6px;margin-top:12px;flex-wrap:wrap}
.pc-cat{background:rgba(255,255,255,.15);padding:3px 8px;border-radius:6px;font-size:10px;display:flex;align-items:center;gap:3px}

/* ===== DAILY MISSIONS ===== */
.section-title{font-size:18px;font-weight:800;margin:20px 0 10px;display:flex;align-items:center;gap:6px}
.section-title .st-sub{font-size:12px;color:var(--sub);font-weight:400;margin-left:auto}

.mission-card{background:var(--card);border-radius:var(--r16);padding:14px;margin-bottom:8px;box-shadow:var(--shadow);display:flex;align-items:center;gap:12px}
.mission-icon{width:40px;height:40px;border-radius:var(--r12);display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0}
.mission-info{flex:1}
.mission-name{font-size:14px;font-weight:600}
.mission-desc{font-size:12px;color:var(--sub);margin-top:1px}
.mission-prog{height:4px;border-radius:2px;background:var(--border);margin-top:6px;overflow:hidden}
.mission-prog-fill{height:100%;border-radius:2px;transition:width .3s}
/* TDS Badge */
.tds-badge{display:inline-flex;align-items:center;justify-content:center;font-weight:700;border-radius:6px;white-space:nowrap;line-height:1}
.tds-badge-xs{font-size:10px;padding:2px 6px;border-radius:4px}
.tds-badge-sm{font-size:11px;padding:3px 8px}
.tds-badge-md{font-size:13px;padding:4px 10px}
.tds-badge-fill-blue{background:#3182F6;color:#fff}
.tds-badge-fill-green{background:#1FC58E;color:#fff}
.tds-badge-fill-red{background:#F04452;color:#fff}
.tds-badge-fill-teal{background:#00B8D9;color:#fff}
.tds-badge-fill-yellow{background:var(--ok);color:#fff}
.tds-badge-weak-blue{background:rgba(49,130,246,.08);color:#3182F6}
.tds-badge-weak-green{background:rgba(31,197,142,.08);color:#1FC58E}
.tds-badge-weak-red{background:rgba(240,68,82,.08);color:#F04452}
.tds-badge-weak-yellow{background:rgba(48,176,110,.08);color:var(--ok)}
.tds-badge-weak-elephant{background:rgba(25,31,40,.06);color:#8B95A1}
.mission-reward{font-size:12px;font-weight:700;color:var(--p);white-space:nowrap}
.mission-check{font-size:20px}

/* ===== STREAK CALENDAR ===== */
.streak-card{background:var(--card);border-radius:var(--r16);padding:14px;margin-bottom:12px;box-shadow:var(--shadow)}
.streak-title{font-size:14px;font-weight:700;margin-bottom:10px;display:flex;align-items:center;gap:6px}
.streak-days{display:flex;gap:4px;justify-content:center}
.streak-day{width:36px;text-align:center}
.streak-day .sd-label{font-size:10px;color:var(--sub);margin-bottom:4px}
.streak-day .sd-dot{width:28px;height:28px;border-radius:50%;margin:0 auto;display:flex;align-items:center;justify-content:center;font-size:14px;background:var(--border)}
.streak-day .sd-dot.done{background:var(--ok);color:#fff}
.streak-day .sd-dot.today{background:var(--p);color:#fff;box-shadow:0 2px 8px rgba(49,130,246,.3)}
.streak-day .sd-dot.bonus{background:var(--ok);color:#fff;box-shadow:0 2px 8px rgba(48,176,110,.3)}
.streak-reward{text-align:center;margin-top:10px;font-size:12px;color:var(--sub)}
.streak-reward b{color:var(--ok)}

/* ===== WEEKLY CHART ===== */
.chart-card{background:var(--card);border-radius:var(--r16);padding:14px;margin-bottom:12px;box-shadow:var(--shadow)}
.chart-bars{display:flex;align-items:flex-end;justify-content:space-between;height:80px;padding:0 8px;gap:4px}
.chart-bar{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px}
.chart-bar .cb-bar{width:100%;border-radius:4px 4px 0 0;background:var(--p-light);min-height:4px;transition:height .5s ease;position:relative}
.chart-bar .cb-bar.today{background:var(--p)}
.chart-bar .cb-val{font-size:10px;font-weight:600;color:var(--p)}
.chart-bar .cb-label{font-size:10px;color:var(--sub)}

/* ===== DAILY PICK ===== */
.daily-pick{background:var(--card);border-radius:var(--r16);padding:14px;margin-bottom:12px;box-shadow:var(--shadow)}
.daily-games{display:flex;gap:10px;overflow-x:auto;scrollbar-width:none}
.daily-games::-webkit-scrollbar{display:none}
.daily-game{flex:0 0 80px;text-align:center;cursor:pointer}
.daily-game:active{transform:scale(.95)}
.daily-game .dg-icon{width:52px;height:52px;border-radius:var(--r16);display:flex;align-items:center;justify-content:center;font-size:26px;margin:0 auto 4px}
.daily-game .dg-name{font-size:11px;font-weight:600}
.daily-game .dg-cat{font-size:10px;color:var(--sub)}

/* ===== GAME GRID ===== */
.game-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.game-card{background:var(--card);border-radius:var(--r16);padding:14px;cursor:pointer;transition:transform .1s;position:relative;box-shadow:var(--shadow)}
.game-card:active{transform:scale(.97)}
.game-card .gc-icon{margin-bottom:8px}.game-card .gc-icon svg{width:100%;height:100%}
.game-card .gc-name{font-size:14px;font-weight:700;margin-bottom:1px}
.game-card .gc-desc{font-size:11px;color:var(--sub);margin-bottom:6px}
.game-card .gc-best{font-size:11px;color:var(--p);font-weight:600}
.game-card .gc-best .tds-badge{margin-right:4px;vertical-align:1px}
.game-card .gc-new{position:absolute;top:8px;right:8px;background:var(--no);color:#fff;font-size:9px;font-weight:700;padding:2px 6px;border-radius:var(--r-full)}
.game-card.locked{opacity:.4;pointer-events:none}
.game-card.locked::after{content:'';position:absolute;top:10px;right:10px;width:14px;height:14px;background:var(--sub);-webkit-mask:url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' fill='currentColor' xmlns='http://www.w3.org/2000/svg'%3E%3Crect x='3' y='11' width='18' height='11' rx='2'/%3E%3Cpath d='M7 11V7a5 5 0 0110 0v4' fill='none' stroke='currentColor' stroke-width='2'/%3E%3C/svg%3E") center/contain no-repeat;mask:url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' fill='currentColor' xmlns='http://www.w3.org/2000/svg'%3E%3Crect x='3' y='11' width='18' height='11' rx='2'/%3E%3Cpath d='M7 11V7a5 5 0 0110 0v4' fill='none' stroke='currentColor' stroke-width='2'/%3E%3C/svg%3E") center/contain no-repeat}
.rank-badge{display:inline-flex;width:32px;height:32px;border-radius:50%;align-items:center;justify-content:center}
.rank-badge svg{width:20px;height:20px}
.game-card .gc-unlock{font-size:10px;color:var(--sub)}

/* ===== GAME COMMON ===== */
.screen{display:none}
.screen.active{display:flex;flex-direction:column;height:100vh;height:100dvh}
.g-hdr{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:var(--card);border-bottom:1px solid var(--border)}
.g-hdr .back{font-size:22px;cursor:pointer;background:none;border:none;padding:4px 8px;color:var(--text)}
.g-hdr .g-title{font-size:16px;font-weight:700}
.g-hdr .g-timer{font-size:16px;font-weight:700;color:#3182F6;min-width:40px;text-align:right}
.g-hdr .g-timer.urgent{color:#F04452}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
.g-body{flex:1;display:flex;flex-direction:column;padding:12px 16px;overflow:hidden;justify-content:center}
.g-score{text-align:center;font-size:18px;font-weight:700;position:sticky;top:0;z-index:2;padding:8px 0;background:var(--bg);flex-shrink:0}
.goal-bar{margin:4px 16px 8px;position:relative}
.goal-bar .gb-track{height:8px;border-radius:4px;background:var(--border);overflow:hidden}
.goal-bar .gb-fill{height:100%;border-radius:4px;background:var(--p);transition:width .3s;width:0}
.goal-bar .gb-fill.hot{background:var(--no)}
.goal-bar .gb-fill.done{background:var(--ok)}
.goal-bar .gb-label{display:flex;justify-content:space-between;font-size:12px;color:var(--sub);padding:4px 2px}
.goal-bar .gb-label .gb-target{font-weight:700;color:var(--p)}

/* ===== RESULT OVERLAY ===== */
.overlay{display:none;position:fixed;inset:0;background:var(--bg);z-index:100;align-items:flex-start;justify-content:center;overflow-y:auto}
.overlay.active{display:flex}
.result-sheet{background:var(--bg);padding:28px 24px max(24px,env(safe-area-inset-bottom));text-align:center;width:100%;max-width:480px;min-height:100vh;min-height:100dvh;animation:fadeIn .3s ease forwards}
@keyframes sheetUp{to{transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.result-sheet .r-handle{display:none}
/* r-emoji removed */
.result-sheet h3{font-size:18px;margin-bottom:2px}
.result-sheet .r-score{font-size:40px;font-weight:800;color:var(--p);margin:6px 0}
.result-sheet .r-record{color:var(--ok);font-weight:700;font-size:14px;margin-bottom:2px}
.result-sheet .r-cat{font-size:13px;color:var(--sub);margin-bottom:4px}
/* XP gain in result */
.r-xp{display:inline-flex;align-items:center;gap:4px;background:var(--p);color:#fff;padding:4px 12px;border-radius:6px;font-size:13px;font-weight:700;margin-bottom:12px;animation:xpPop .4s ease}
@keyframes xpPop{0%{transform:scale(0)}50%{transform:scale(1.15)}100%{transform:scale(1)}}
/* Mission complete in result */
.r-mission{background:var(--ok-bg);border:1px solid var(--ok);border-radius:var(--r12);padding:10px 14px;margin-bottom:12px;font-size:13px;color:var(--ok);font-weight:600;display:flex;align-items:center;gap:6px}
.r-stats{display:flex;gap:10px;justify-content:center;margin-bottom:14px}
.r-stat{background:var(--bg);padding:8px 14px;border-radius:var(--r12);text-align:center}
.r-stat .rs-val{font-size:16px;font-weight:700;color:var(--p)}
.r-stat .rs-label{font-size:10px;color:var(--sub)}
/* TDS Button System */
.btn{width:100%;padding:16px;border:none;border-radius:16px;font-size:16px;font-weight:700;cursor:pointer;margin-bottom:8px;font-family:var(--font);transition:all .2s ease;position:relative;overflow:hidden}
.btn:active{opacity:.8;transform:scale(.98)}
.btn:disabled{opacity:.4;cursor:not-allowed}
.btn:disabled:active{transform:none;opacity:.4}
/* fill + primary (주요 액션) */
.btn-primary{background:var(--p);color:#fff}
.btn-primary:active{background:var(--p-dark)}
/* fill + dark */
.btn-dark{background:var(--text);color:#fff}
/* fill + danger */
.btn-danger{background:var(--no);color:#fff}
/* weak + primary (보조 액션) */
.btn-weak{background:rgba(49,130,246,.08);color:var(--p)}
.btn-weak:active{background:rgba(49,130,246,.15)}
/* weak + dark (홈으로 등) */
.btn-home{background:rgba(25,31,40,.06);color:var(--text)}
.btn-home:active{background:rgba(25,31,40,.12)}
/* weak + danger */
.btn-danger-weak{background:rgba(240,68,82,.08);color:var(--no)}
/* combo (포인트, 보상 등) */
.btn-combo{background:var(--ok);color:#fff}
.btn-combo:active{background:#28965D}
.btn-combo:disabled{background:var(--border);color:var(--sub);opacity:1}

/* ===== LEVEL UP OVERLAY ===== */
.levelup-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:200;align-items:center;justify-content:center}
.levelup-overlay.active{display:flex}
.levelup-card{background:#fff;border-radius:var(--r20);padding:32px;text-align:center;width:85%;max-width:320px;animation:lvlPop .4s cubic-bezier(.32,.72,0,1)}
@keyframes lvlPop{0%{transform:scale(.8);opacity:0}100%{transform:scale(1);opacity:1}}
.levelup-card .lu-badge{font-size:64px;margin-bottom:12px}
.levelup-card .lu-title{font-size:20px;font-weight:800;margin-bottom:4px}
.levelup-card .lu-desc{font-size:14px;color:var(--sub);margin-bottom:16px}
.levelup-card .lu-unlock{background:var(--p-light);border-radius:var(--r12);padding:10px;font-size:13px;color:var(--p);font-weight:600;margin-bottom:16px}

/* ===== GAME CSS (same as before) ===== */
.math-problem{display:flex;align-items:center;justify-content:center;gap:12px;padding:24px;background:var(--card);border-radius:var(--r20);transition:background .15s;margin-bottom:14px;box-shadow:var(--shadow)}
.math-problem.ok{background:var(--ok-bg)}.math-problem.no{background:var(--no-bg)}
.math-problem .m-num{font-size:36px;font-weight:700}
.math-problem .m-op{font-size:28px;color:var(--p)}.math-problem .m-eq{font-size:28px;color:var(--sub)}
.math-problem .m-ans{font-size:36px;font-weight:700;min-width:60px;text-align:center;border-bottom:3px solid var(--p);color:var(--p);padding:2px 8px}
.combo-text{text-align:center;font-size:14px;font-weight:700;color:var(--p);min-height:20px;margin-bottom:8px}
.numpad{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:auto;padding:0 8px 12px;max-width:400px;width:100%;margin-left:auto;margin-right:auto}
.nbtn{padding:18px 0;font-size:24px;font-weight:700;background:var(--card);border:none;border-radius:var(--r12);cursor:pointer;font-family:var(--font);box-shadow:var(--shadow);min-height:56px}
.nbtn:active{background:#E5E8EB;transform:scale(.95)}.nbtn.del{font-size:20px;color:var(--sub)}.nbtn.go{background:var(--p);color:#fff}

.card-grid{display:grid;gap:8px;flex:1;align-content:center}.card-grid.g4{grid-template-columns:repeat(4,1fr)}
.mem-card{aspect-ratio:1;background:var(--p);border-radius:var(--r12);display:flex;align-items:center;justify-content:center;font-size:28px;cursor:pointer;transition:transform .2s,background .3s;box-shadow:var(--shadow)}
.mem-card.flipped,.mem-card.matched{background:var(--card);border:2px solid var(--border)}
.mem-card.matched{background:var(--ok-bg);border-color:var(--ok)}
.mem-card:active{transform:scale(.95)}.mem-card .cf{display:none}.mem-card.flipped .cf,.mem-card.matched .cf{display:block}
.mem-info{text-align:center;padding:8px;font-size:13px;color:var(--sub)}

.seq-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;width:100%;max-width:320px;margin:0 auto;padding:20px 16px}
.seq-cell{aspect-ratio:1;background:var(--card);border:2px solid var(--border);border-radius:var(--r16);display:flex;align-items:center;justify-content:center;font-size:32px;font-weight:800;cursor:pointer;transition:all .2s;box-shadow:var(--shadow);min-height:80px}
.seq-cell.hl{background:var(--p);border-color:var(--p);color:#fff}
.seq-cell.ok{background:var(--ok);border-color:var(--ok);color:#fff}
.seq-cell.no{background:var(--no);border-color:var(--no);color:#fff}
.seq-msg{text-align:center;font-size:15px;font-weight:600;padding:12px;min-height:44px}

.stroop-word{font-size:48px;font-weight:800;text-align:center;padding:28px;margin:12px 0}
.stroop-q{text-align:center;font-size:15px;color:var(--sub);margin-bottom:16px}
.stroop-opts{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.stroop-opt{padding:16px;border-radius:var(--r12);border:2px solid var(--border);background:var(--card);font-size:17px;font-weight:700;cursor:pointer;text-align:center;font-family:var(--font);box-shadow:var(--shadow)}
.stroop-opt:active{transform:scale(.97)}

.react-area{flex:1;display:flex;align-items:center;justify-content:center;margin:16px 0;border-radius:var(--r20);cursor:pointer;transition:background .3s}
.react-area.waiting{background:var(--no)}.react-area.ready{background:var(--ok)}.react-area.result{background:var(--card);box-shadow:var(--shadow)}
.react-msg{font-size:20px;font-weight:700;color:#fff;text-align:center;padding:20px}
.react-area.result .react-msg{color:var(--text)}.react-time{font-size:52px;font-weight:800;color:var(--p)}

.word-board{display:grid;gap:3px;margin:0;padding:8px 0;grid-template-columns:repeat(6,1fr)}
.wc{aspect-ratio:1;background:var(--card);border:2px solid var(--border);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:700;cursor:pointer;transition:all .15s;box-shadow:var(--shadow)}
.wc.selected{background:var(--p-light);border-color:var(--p)}.wc.found{background:var(--ok-bg);border-color:var(--ok);color:var(--ok)}
.word-list{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;padding:8px 0}
.wl-item{padding:4px 12px;border-radius:var(--r-full);font-size:13px;font-weight:600;background:var(--bg);color:var(--sub)}
.wl-item.found{background:var(--ok-bg);color:var(--ok);text-decoration:line-through}

.pat-seq{display:flex;align-items:center;justify-content:center;gap:8px;padding:16px;flex-wrap:wrap}
.pat-item{width:56px;height:56px;border-radius:var(--r12);display:flex;align-items:center;justify-content:center;font-size:28px;background:var(--card);box-shadow:var(--shadow);border:2px solid var(--border)}
.pat-item.q{border:3px dashed var(--p);background:var(--p-light);font-size:24px;color:var(--p)}
.pat-opts{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:auto;padding:8px 0}
.pat-opt{padding:16px;border-radius:var(--r12);background:var(--card);border:2px solid var(--border);font-size:28px;text-align:center;cursor:pointer;box-shadow:var(--shadow);font-family:var(--font)}
.pat-opt:active{transform:scale(.95)}.pat-opt.ok{border-color:var(--ok);background:var(--ok-bg)}.pat-opt.no{border-color:var(--no);background:var(--no-bg)}

.focus-field{flex:1;position:relative;background:var(--card);border-radius:var(--r20);margin:8px 0;overflow:hidden;box-shadow:var(--shadow)}
.focus-target{position:absolute;width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:24px;cursor:pointer;transition:transform .1s;animation:focusPop .2s ease-out}
.focus-target:active{transform:scale(.8)}
.focus-target.good{background:var(--p);box-shadow:0 2px 8px rgba(49,130,246,.3)}
.focus-target.bad{background:var(--p);box-shadow:0 2px 8px rgba(49,130,246,.3)}
.focus-target.bonus{background:var(--p);box-shadow:0 2px 8px rgba(49,130,246,.3);animation:focusPop .2s ease-out,bonusPulse 1s infinite}
@keyframes focusPop{from{transform:scale(0)}to{transform:scale(1)}}
@keyframes bonusPulse{0%,100%{box-shadow:0 2px 8px rgba(255,138,0,.3)}50%{box-shadow:0 2px 16px rgba(255,138,0,.5)}}
.focus-legend{display:flex;gap:16px;justify-content:center;padding:8px;font-size:12px;color:var(--sub);font-weight:600}

/* Number Touch */
.nt-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:5px;margin:8px 0}
.nt-cell{aspect-ratio:1;background:var(--p);color:#fff;border-radius:var(--r12);display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:800;cursor:pointer;transition:all .15s;box-shadow:var(--shadow)}
.nt-cell:active{transform:scale(.9)}.nt-cell.done{background:var(--ok-bg);color:var(--ok);pointer-events:none;font-size:16px}

/* Rhythm */
.rhy-pads{display:grid;grid-template-columns:repeat(2,1fr);gap:14px;margin:auto 0;padding:0 16px}
.rhy-pad{aspect-ratio:1;border-radius:var(--r20);cursor:pointer;background:var(--pc);opacity:.5;box-shadow:var(--shadow);transition:all .2s;border:3px solid rgba(0,0,0,.08)}
.rhy-pad:active{transform:scale(.9)}.rhy-pad.lit{opacity:1;transform:scale(1.05);border-color:rgba(255,255,255,.4);box-shadow:0 0 30px var(--pc)}

/* RPS */
.rps-enemy{font-size:48px;font-weight:900;text-align:center;padding:24px 0;color:var(--p)}
.rps-q{text-align:center;font-size:16px;font-weight:700;color:var(--p);padding:8px}
.rps-opts{display:flex;gap:12px;justify-content:center;padding:16px}
.rps-btn{flex:1;padding:20px;border-radius:var(--r16);border:2px solid var(--border);background:var(--card);font-size:20px;font-weight:800;cursor:pointer;transition:all .15s;box-shadow:var(--shadow)}
.rps-btn:active{transform:scale(.9)}.rps-btn.ok{border-color:var(--ok);background:var(--ok-bg)}.rps-btn.no{border-color:var(--no);background:var(--no-bg)}

/* Odd One */
.odd-grid{display:grid;gap:4px;margin:8px 0}
.odd-cell{aspect-ratio:1;background:var(--card);border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:700;cursor:pointer;box-shadow:var(--shadow);transition:all .15s;border:2px solid var(--border);user-select:none}
.odd-cell:active{transform:scale(.9)}.odd-cell.ok{border-color:var(--ok);background:var(--ok-bg)}.odd-cell.no{border-color:var(--no);background:var(--no-bg)}

/* Compare */
.cmp-nums{display:flex;align-items:center;justify-content:center;gap:20px;padding:30px 0}
.cmp-n{font-size:48px;font-weight:900;color:var(--p);min-width:100px;text-align:center;padding:24px 16px;border-radius:var(--r16);background:var(--card);box-shadow:var(--shadow);border:2px solid var(--border);cursor:pointer;transition:all .2s}.cmp-n:active{transform:scale(.95)}
.cmp-vs{font-size:20px;font-weight:700;color:var(--sub)}
.cmp-opts{display:flex;gap:10px;padding:0 16px}
.cmp-btn{flex:1;padding:16px;border-radius:var(--r12);border:2px solid var(--border);background:var(--card);font-size:16px;font-weight:700;cursor:pointer;box-shadow:var(--shadow)}
.cmp-btn:active{transform:scale(.95)}

/* Bulb */
.bulb-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin:auto 0;padding:0 24px}
.bulb-item{aspect-ratio:1;border-radius:50%;background:var(--card);border:3px solid var(--border);cursor:pointer;transition:all .25s;box-shadow:var(--shadow)}
.bulb-item.on{background:#FBBF24;border-color:#F59E0B;box-shadow:0 0 24px rgba(251,191,36,.6),0 0 48px rgba(251,191,36,.2)}.bulb-item:active{transform:scale(.9)}

/* Color Mix */
.cmx-q{text-align:center;padding:16px;font-size:16px;font-weight:600}
.cmx-opts{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;padding:0 16px}
.cmx-opt{padding:20px;border-radius:var(--r16);border:3px solid var(--border);cursor:pointer;text-align:center;transition:all .15s;box-shadow:var(--shadow)}
.cmx-opt:active{transform:scale(.95)}.cmx-opt.ok{border-color:var(--ok)}.cmx-opt.no{border-color:var(--no)}

/* Word Complete */
.wc-word{text-align:center;font-size:36px;font-weight:800;letter-spacing:8px;padding:24px 0;color:var(--text)}
.wc-hint{text-align:center;font-size:14px;color:var(--sub);padding:0 0 16px}
.wc-opts{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;padding:0 16px}
.wc-opt{padding:16px;border-radius:var(--r12);border:2px solid var(--border);background:var(--card);font-size:20px;font-weight:700;text-align:center;cursor:pointer;box-shadow:var(--shadow)}
.wc-opt:active{transform:scale(.95)}.wc-opt.ok{border-color:var(--ok);background:var(--ok-bg)}.wc-opt.no{border-color:var(--no);background:var(--no-bg)}

/* Timing */
.tm-bar{position:relative;height:60px;background:var(--card);border-radius:var(--r-full);margin:30px 16px;overflow:hidden;box-shadow:var(--shadow);border:2px solid var(--border)}
.tm-target{position:absolute;height:100%;background:var(--ok-bg);border-radius:var(--r-full)}
.tm-cursor{position:absolute;top:0;width:4px;height:100%;background:var(--p);border-radius:2px;transition:none}

/* Match Pair */
.mp-cols{display:flex;gap:12px;padding:8px}
.mp-col{flex:1;display:flex;flex-direction:column;gap:8px}
.mp-item{padding:14px 10px;border-radius:var(--r12);border:2px solid var(--border);background:var(--card);font-size:14px;font-weight:600;text-align:center;cursor:pointer;transition:all .15s;box-shadow:var(--shadow)}
.mp-item:active{transform:scale(.95)}.mp-item.sel{border-color:var(--p);background:var(--p-light)}.mp-item.ok{border-color:var(--ok);background:var(--ok-bg);pointer-events:none}.mp-item.no{border-color:var(--no);background:var(--no-bg)}

/* Head Count */
.hc-stage{position:relative;height:180px;margin:12px 0;overflow:hidden;background:linear-gradient(180deg,#E8F4FD 0%,#F0F4F8 100%);border-radius:var(--r16)}
.hc-bldg{position:absolute;left:50%;bottom:0;transform:translateX(-50%);width:140px;height:150px;z-index:2}
.hc-counter{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);font-size:32px;font-weight:900;color:var(--p);z-index:3;opacity:.12}
.hc-person{position:absolute;bottom:12px;width:36px;height:36px;z-index:4;transition:none}
.hc-person img{width:100%;height:100%}
.hc-person.enter{animation:hcEnter .7s ease forwards}
.hc-person.exit{animation:hcExit .7s ease forwards}
@keyframes hcEnter{0%{left:-40px;opacity:1}60%{left:calc(50% - 18px);opacity:1}100%{left:calc(50% - 18px);opacity:0;transform:scale(.4)}}
@keyframes hcExit{0%{left:calc(50% - 18px);opacity:0;transform:scale(.4)}40%{left:calc(50% - 18px);opacity:1;transform:scale(1)}100%{left:calc(100% + 8px);opacity:1}}
.hc-log{text-align:center;padding:4px;font-size:15px;font-weight:600;min-height:28px;color:var(--sub)}
.hc-opts{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;padding:0 16px}
.hc-opt{padding:14px 0;border-radius:var(--r12);border:2px solid var(--border);background:var(--card);font-size:20px;font-weight:800;text-align:center;cursor:pointer;box-shadow:var(--shadow)}
.hc-opt:active{transform:scale(.95)}.hc-opt.ok{border-color:var(--ok);background:var(--ok-bg)}.hc-opt.no{border-color:var(--no);background:var(--no-bg)}

/* Pyramid */
.pyr-grid{display:flex;flex-direction:column;align-items:center;gap:6px;padding:16px}
.pyr-row{display:flex;gap:6px}
.pyr-cell{width:56px;height:44px;border-radius:var(--r12);display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:800;background:var(--card);border:2px solid var(--border);box-shadow:var(--shadow)}
.pyr-cell.blank{border:2px dashed var(--p);background:var(--p-light);cursor:pointer;color:var(--p)}
.pyr-cell.blank:active{transform:scale(.95)}.pyr-cell.fixed{background:var(--bg)}
.pyr-input{display:flex;gap:6px;justify-content:center;padding:8px;flex-wrap:wrap}
.pyr-btn{width:44px;height:40px;border-radius:var(--r12);border:2px solid var(--border);background:var(--card);font-size:16px;font-weight:700;cursor:pointer}

/* Max Number */
.mx-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin:12px 0}
.mx-cell{padding:16px 0;border-radius:var(--r12);background:var(--card);border:2px solid var(--border);font-size:22px;font-weight:800;text-align:center;cursor:pointer;box-shadow:var(--shadow)}
.mx-cell:active{transform:scale(.95)}.mx-cell.ok{border-color:var(--ok);background:var(--ok-bg)}.mx-cell.no{border-color:var(--no);background:var(--no-bg)}

/* Sign Find */
.sf-eq{text-align:center;font-size:42px;font-weight:900;padding:32px 0;color:var(--text);letter-spacing:4px}
.sf-opts{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;padding:0 16px}
.sf-opt{padding:18px 0;border-radius:var(--r12);border:2px solid var(--border);background:var(--card);font-size:24px;font-weight:800;text-align:center;cursor:pointer;box-shadow:var(--shadow)}
.sf-opt:active{transform:scale(.95)}.sf-opt.ok{border-color:var(--ok);background:var(--ok-bg)}.sf-opt.no{border-color:var(--no);background:var(--no-bg)}

/* Coin Count */
.cc-coins{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;padding:20px 16px;min-height:100px}
.cc-coin{width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:800;color:#fff;box-shadow:inset 0 2px 4px rgba(255,255,255,.3),0 2px 4px rgba(0,0,0,.2)}
.cc-opts{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;padding:0 16px}
.cc-opt{padding:16px;border-radius:var(--r12);border:2px solid var(--border);background:var(--card);font-size:18px;font-weight:700;text-align:center;cursor:pointer;box-shadow:var(--shadow)}
.cc-opt:active{transform:scale(.95)}.cc-opt.ok{border-color:var(--ok);background:var(--ok-bg)}.cc-opt.no{border-color:var(--no);background:var(--no-bg)}

/* Clock */
.clk-opts{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;padding:0 16px}
.clk-opt{padding:14px;border-radius:var(--r12);border:2px solid var(--border);background:var(--card);font-size:18px;font-weight:700;text-align:center;cursor:pointer;box-shadow:var(--shadow)}
.clk-opt:active{transform:scale(.95)}.clk-opt.ok{border-color:var(--ok);background:var(--ok-bg)}.clk-opt.no{border-color:var(--no);background:var(--no-bg)}

/* Word Memory */
.wm-display{text-align:center;padding:16px;min-height:60px}
.wm-word{font-size:32px;font-weight:800;color:var(--p);animation:wmFade .5s ease-out}
@keyframes wmFade{from{opacity:0;transform:scale(.8)}to{opacity:1;transform:scale(1)}}
.wm-opts{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;padding:0 16px}
.wm-opt{padding:16px;border-radius:var(--r12);border:2px solid var(--border);background:var(--card);font-size:16px;font-weight:700;text-align:center;cursor:pointer;box-shadow:var(--shadow)}
.wm-opt:active{transform:scale(.95)}.wm-opt.ok{border-color:var(--ok);background:var(--ok-bg)}.wm-opt.no{border-color:var(--no);background:var(--no-bg)}

/* Block Count */
.bc-opts{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;padding:0 16px}
.bc-opt{padding:14px 0;border-radius:var(--r12);border:2px solid var(--border);background:var(--card);font-size:20px;font-weight:800;text-align:center;cursor:pointer;box-shadow:var(--shadow)}
.bc-opt:active{transform:scale(.95)}.bc-opt.ok{border-color:var(--ok);background:var(--ok-bg)}.bc-opt.no{border-color:var(--no);background:var(--no-bg)}
.focus-legend span{display:flex;align-items:center;gap:4px}.focus-legend .dot{width:12px;height:12px;border-radius:50%}

.rotate-q{text-align:center;padding:8px;margin-bottom:8px;font-size:14px;font-weight:600}
.rotate-original{display:flex;justify-content:center;padding:16px}
.rotate-original canvas{border-radius:var(--r16);box-shadow:var(--shadow);background:var(--card)}
.rotate-opts{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;padding:8px 0;margin-top:auto}
.rotate-opt{display:flex;justify-content:center;padding:12px;border-radius:var(--r16);border:2px solid var(--border);background:var(--card);cursor:pointer;box-shadow:var(--shadow)}
.rotate-opt:active{transform:scale(.97)}.rotate-opt.ok{border-color:var(--ok);background:var(--ok-bg)}.rotate-opt.no{border-color:var(--no);background:var(--no-bg)}
.rotate-opt canvas{border-radius:var(--r12)}

.rev-display{display:flex;justify-content:center;gap:8px;padding:16px;flex-wrap:wrap}
.rev-num{width:48px;height:56px;border-radius:var(--r12);background:var(--p);color:#fff;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:700;box-shadow:0 2px 8px rgba(49,130,246,.2)}
.rev-num.hidden{background:var(--border);color:transparent}
.rev-input{display:flex;justify-content:center;gap:8px;padding:8px;flex-wrap:wrap}
.rev-slot{width:48px;height:56px;border-radius:var(--r12);border:2px dashed var(--border);display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:700;color:var(--p)}
.rev-slot.filled{border-style:solid;border-color:var(--p);background:var(--p-light)}
.rev-slot.ok{border-color:var(--ok);background:var(--ok-bg);color:var(--ok)}
.rev-slot.no{border-color:var(--no);background:var(--no-bg);color:var(--no)}

/* ===== DAILY WORKOUT ===== */
.workout-card{background:var(--card);border-radius:var(--r20);padding:20px;margin-bottom:16px;box-shadow:var(--shadow);border:1px solid var(--border)}
.workout-card.done{border-color:var(--border);background:var(--card)}
.wk-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
.wk-title{font-size:17px;font-weight:800}
.wk-badge{padding:3px 10px;border-radius:var(--r-full);font-size:11px;font-weight:700}
.wk-games{display:flex;gap:8px;margin-bottom:14px}
.wk-game{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;padding:10px 4px;border-radius:var(--r12);background:var(--bg);position:relative}
.wk-game.current{background:rgba(49,130,246,.06);box-shadow:0 0 0 1.5px var(--p)}
.wk-game.done{background:rgba(49,130,246,.04)}
.wk-game .wk-icon{width:24px;height:24px;color:var(--p)}.wk-game .wk-icon svg{width:100%;height:100%}
.wk-game .wk-name{font-size:10px;font-weight:600;text-align:center}
.wk-game .wk-check{position:absolute;top:-4px;right:-4px;width:18px;height:18px;display:flex;align-items:center;justify-content:center}
.wk-progress{height:6px;border-radius:3px;background:var(--border);overflow:hidden;margin-bottom:14px}
.wk-progress-fill{height:100%;border-radius:3px;background:linear-gradient(90deg,var(--p),var(--purple));transition:width .5s ease}
.wk-start{width:100%;padding:14px;border:none;border-radius:var(--r12);font-size:16px;font-weight:700;cursor:pointer;font-family:var(--font);background:var(--p);color:#fff;transition:transform .1s}
.wk-start:active{transform:scale(.97)}
.wk-start.completed{background:var(--ok)}
.wk-bonus{text-align:center;font-size:12px;color:var(--sub);margin-top:8px}
.wk-bonus b{color:var(--ok)}
/* Workout transition screen */
.wk-transition{display:none;position:fixed;inset:0;background:var(--bg);z-index:90;flex-direction:column;align-items:center;justify-content:center;gap:16px}
.wk-transition.active{display:flex}
.wk-transition .wkt-progress{font-size:14px;color:var(--sub);font-weight:600}
.wk-transition .wkt-next{width:48px;height:48px;margin:8px auto}.wk-transition .wkt-next svg{width:100%;height:100%}
.wk-transition .wkt-name{font-size:20px;font-weight:800}
.wk-transition .wkt-desc{font-size:14px;color:var(--sub)}

/* ===== HEART SYSTEM ===== */
.hearts{display:flex;gap:2px;align-items:center}
.heart{color:#F04452;transition:all .2s;display:inline-flex}
.heart.lost{opacity:.2;transform:scale(.8)}
.heart-shake{animation:heartShake .4s ease}
@keyframes heartShake{0%,100%{transform:translateX(0)}20%{transform:translateX(-4px)}40%{transform:translateX(4px)}60%{transform:translateX(-2px)}80%{transform:translateX(2px)}}
.heart-break{animation:heartBreak .5s ease forwards}
@keyframes heartBreak{0%{transform:scale(1);opacity:1}50%{transform:scale(1.3);color:var(--no)}100%{transform:scale(.5);opacity:.2}}
/* Heart refill overlay */
.heart-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:150;align-items:center;justify-content:center}
.heart-overlay.active{display:flex}
.heart-card{background:#fff;border-radius:var(--r20);padding:28px 24px;text-align:center;width:85%;max-width:320px;animation:lvlPop .4s cubic-bezier(.32,.72,0,1)}
.heart-card .hc-hearts{font-size:40px;margin-bottom:12px;letter-spacing:4px}
.heart-card .hc-title{font-size:18px;font-weight:800;margin-bottom:4px}
.heart-card .hc-desc{font-size:14px;color:var(--sub);margin-bottom:16px}
.heart-card .hc-timer{font-size:13px;color:var(--sub);margin-bottom:12px}
.btn-heart{background:linear-gradient(135deg,#F04452,#E91E63);color:#fff}

/* ===== COIN SYSTEM ===== */
.coin-badge{background:linear-gradient(135deg,#FFD700,#FFA000);color:#fff;padding:4px 12px;border-radius:var(--r-full);font-size:13px;font-weight:700;display:flex;align-items:center;gap:4px;box-shadow:0 2px 6px rgba(255,168,0,.25)}
.r-coin{display:flex;align-items:center;justify-content:center;gap:6px;margin-bottom:12px}
.r-coin-amount{font-size:24px;font-weight:800;color:#FFA000;animation:coinBounce .5s ease}
.r-coin-label{font-size:13px;color:var(--sub)}
.r-coin-new{background:linear-gradient(135deg,#FFD700,#FFA000);color:#fff;padding:6px 16px;border-radius:var(--r-full);font-size:14px;font-weight:700;animation:xpPop .4s ease;display:inline-flex;align-items:center;gap:4px;margin-bottom:8px}
@keyframes coinBounce{0%{transform:scale(0)}50%{transform:scale(1.3)}100%{transform:scale(1)}}
.btn-coin{background:linear-gradient(135deg,#FFD700,#FFA000);color:#fff;display:flex;align-items:center;justify-content:center;gap:6px}
.coin-milestones{background:var(--card);border-radius:var(--r16);padding:14px;margin-bottom:12px;box-shadow:var(--shadow)}
.cm-item{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border)}
.cm-item:last-child{border:none}
.cm-icon{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.cm-info{flex:1}
.cm-name{font-size:13px;font-weight:600}
.cm-desc{font-size:11px;color:var(--sub)}
.cm-prog{height:4px;border-radius:2px;background:var(--border);margin-top:4px;overflow:hidden}
.cm-prog-fill{height:100%;border-radius:2px;background:linear-gradient(90deg,#FFD700,#FFA000);transition:width .3s}
.cm-status{font-size:11px;font-weight:700;white-space:nowrap}
.cm-status.done{color:var(--ok)}
.cm-status.locked{color:var(--sub)}
/* Floating coin animation */
.coin-float{position:fixed;font-size:24px;z-index:800;pointer-events:none;animation:coinFly 1s ease-out forwards}
@keyframes coinFly{0%{opacity:1;transform:translateY(0) scale(1)}100%{opacity:0;transform:translateY(-80px) scale(.5)}}

.hide{display:none!important}
</style>
</head>
<body>
<div class="app" id="app">

<div class="toast" id="toast"></div>
<div class="snackbar" id="snackbar"><div class="snackbar-inner" id="snackbar-inner"></div></div>

<!-- ===== HOME ===== -->
<div id="homeScreen" class="home screen active">
  <div class="home-header">
    <h1><img src="icon-192.png" style="width:28px;height:28px;vertical-align:-6px;border-radius:6px"> 매일매일 두뇌운동</h1>
    <div class="home-header-r">
      <div id="streakBadge" style="display:none"></div>
      <span id="pointDisplay" style="display:none"></span>
      <span id="ticketCount" class="tds-badge tds-badge-sm tds-badge-fill-blue" style="display:inline-flex;align-items:center;gap:4px;cursor:pointer" onclick="showTicketShop()"><img src="https://static.toss.im/2d-emojis/svg/u1F39F.svg" style="width:13px;height:13px"><span id="ticketNum"></span></span>
    </div>
  </div>

  <!-- Daily Workout (Primary - TOP) -->
  <div id="dailyWorkout"></div>

  <!-- Point Progress -->
  <div style="background:var(--card);border-radius:var(--r16);padding:16px;margin-bottom:12px;box-shadow:var(--shadow)">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
      <div style="font-size:14px;font-weight:800">두뇌점수 모으기</div>
      <div style="font-size:14px;font-weight:800;color:#3182F6" id="pointProgress">0 / 100점</div>
    </div>
    <div style="height:4px;background:rgba(25,31,40,.06);border-radius:2px;overflow:hidden">
      <div id="pointBar" style="height:100%;background:#3182F6;border-radius:2px;transition:width .5s cubic-bezier(.32,.72,0,1);width:0%"></div>
    </div>
    <div id="streakLabel" style="display:none"></div>
    <div style="font-size:12px;color:var(--sub);margin-top:4px">100점이 모이면 100원으로 교환할 수 있어요</div>
    <button class="btn btn-combo" id="exchangeBtn" onclick="exchangePoints()" disabled style="margin:10px 0 0">100원 받기</button>
  </div>
  <div id="streakDays" style="display:none"></div>

  <!-- Profile Summary (Compact - below workout) -->
  <div style="background:var(--card);border-radius:var(--r16);padding:20px 16px 14px;margin-bottom:12px;box-shadow:var(--shadow)">
    <div style="display:flex;align-items:center;margin-bottom:12px">
      <div style="flex:1;text-align:center">
        <div style="font-size:12px;color:var(--sub);margin-bottom:4px">나의 두뇌 나이</div>
        <div style="font-size:36px;font-weight:900" id="rankName">100세</div>
      </div>
      <div style="width:1px;height:48px;background:var(--border)"></div>
      <div style="flex:1;text-align:center">
        <div style="font-size:12px;color:var(--sub);margin-bottom:4px">종합 순위</div>
        <div style="font-size:36px;font-weight:900;color:var(--purple)" id="overallPct">--%</div>
      </div>
    </div>
    <div class="xp-bar">
      <div class="xp-bar-label"><span id="xpCur">0 XP</span><span id="xpMax">200 XP</span></div>
      <div class="xp-bar-track"><div class="xp-bar-fill" id="xpFill" style="width:0%"></div></div>
    </div>
    <div id="rankNext" style="display:none"></div><div id="rankBadge" style="display:none"></div>
  </div>

  <!-- Missions -->
  <div class="section-title"><img src="https://static.toss.im/2d-emojis/svg/u1F3AF.svg" style="width:16px;height:16px;vertical-align:-3px"> 오늘의 챌린지 <span class="st-sub" id="missionCount">0/5</span></div>
  <div id="missionList"></div>

  <!-- Individual Games (Secondary) -->
  <div class="section-title"><img src="https://static.toss.im/2d-emojis/svg/u1F3AE.svg" style="width:16px;height:16px;vertical-align:-3px"> 자유 훈련</div>
  <div id="gameGrid"></div>

  <div id="pointExchangeVal" style="display:none"></div>

  <!-- (coins removed) -->
</div>

<!-- ===== GAME SCREENS ===== -->
<div class="screen" id="game-math">
  <div class="g-hdr"><button class="back" onclick="goHome()">←</button><span class="g-title">암산</span><div class="hearts" id="math-hearts"></div><span class="g-timer" id="math-timer">60s</span></div>
  <div class="g-body">
    <div class="g-score" id="math-score">0점</div><div class="combo-text" id="math-combo"></div>
    <div class="math-problem" id="math-problem"><span class="m-num" id="math-a">0</span><span class="m-op" id="math-op">+</span><span class="m-num" id="math-b">0</span><span class="m-eq">=</span><span class="m-ans" id="math-ans">?</span></div>
    <div class="numpad">
      <button class="nbtn" onclick="mathPress(1)">1</button><button class="nbtn" onclick="mathPress(2)">2</button><button class="nbtn" onclick="mathPress(3)">3</button><button class="nbtn" onclick="mathPress(4)">4</button>
      <button class="nbtn" onclick="mathPress(5)">5</button><button class="nbtn" onclick="mathPress(6)">6</button><button class="nbtn" onclick="mathPress(7)">7</button><button class="nbtn" onclick="mathPress(8)">8</button>
      <button class="nbtn" onclick="mathPress(9)">9</button><button class="nbtn" onclick="mathPress(0)">0</button><button class="nbtn del" onclick="mathDel()">⌫</button><button class="nbtn go" onclick="mathSubmit()">확인</button>
    </div>
  </div>
</div>

<div class="screen" id="game-memory">
  <div class="g-hdr"><button class="back" onclick="goHome()">←</button><span class="g-title">기억력 카드</span><span class="g-timer" id="mem-timer">60s</span></div>
  <div class="g-body"><div class="g-score" id="mem-score">0점</div><div class="mem-info" id="mem-info">같은 카드 쌍을 찾으세요!</div><div class="card-grid g4" id="mem-grid"></div></div>
</div>

<div class="screen" id="game-sequence">
  <div class="g-hdr"><button class="back" onclick="goHome()">←</button><span class="g-title">순서 기억</span><div class="hearts" id="seq-hearts"></div><span class="g-timer" id="seq-level">Lv.1</span></div>
  <div class="g-body"><div class="g-score" id="seq-score">0점</div><div class="seq-msg" id="seq-msg">순서를 기억하세요!</div><div class="seq-grid" id="seq-grid"></div></div>
</div>

<div class="screen" id="game-stroop">
  <div class="g-hdr"><button class="back" onclick="goHome()">←</button><span class="g-title">색깔</span><div class="hearts" id="stroop-hearts"></div><span class="g-timer" id="stroop-timer">60s</span></div>
  <div class="g-body"><div class="g-score" id="stroop-score">0점</div><div class="stroop-q">글자의 <b>색깔</b>을 맞추세요!</div><div class="stroop-word" id="stroop-word">빨강</div><div class="stroop-opts" id="stroop-opts"></div></div>
</div>

<div class="screen" id="game-reaction">
  <div class="g-hdr"><button class="back" onclick="goHome()">←</button><span class="g-title">반응속도</span><span class="g-timer" id="react-round">1/5</span></div>
  <div class="g-body"><div class="g-score" id="react-score">준비하세요</div><div class="react-area waiting" id="react-area" onclick="reactTap()"><div class="react-msg" id="react-msg">화면이 초록색이 되면<br>최대한 빨리 터치!</div></div></div>
</div>

<div class="screen" id="game-word">
  <div class="g-hdr"><button class="back" onclick="goHome()">←</button><span class="g-title">단어 찾기</span><span class="g-timer" id="word-timer">30s</span></div>
  <div class="g-body"><div class="g-score" id="word-score">0점</div><div id="word-cat" style="text-align:center;font-size:14px;font-weight:600;color:var(--p);padding:4px 0"></div><div class="word-list" id="word-list"></div><div class="word-board" id="word-board"></div><div style="text-align:center;font-size:12px;color:var(--sub);padding:4px">카테고리 힌트를 보고 숨은 단어를 찾으세요</div></div>
</div>

<div class="screen" id="game-pattern">
  <div class="g-hdr"><button class="back" onclick="goHome()">←</button><span class="g-title">패턴</span><div class="hearts" id="pat-hearts"></div><span class="g-timer" id="pat-round">1/10</span></div>
  <div class="g-body"><div class="g-score" id="pat-score">0점</div><div class="seq-msg" id="pat-msg">다음에 올 패턴은?</div><div class="pat-seq" id="pat-seq"></div><div class="pat-opts" id="pat-opts"></div></div>
</div>

<div class="screen" id="game-focus">
  <div class="g-hdr"><button class="back" onclick="goHome()">←</button><span class="g-title">집중력 탭</span><span class="g-timer" id="focus-timer">30s</span></div>
  <div class="g-body"><div class="g-score" id="focus-score">0점</div><div class="focus-legend"><span>○ 터치!</span><span>× 피하기</span><span>◎ 보너스</span></div><div class="focus-field" id="focus-field"></div></div>
</div>

<div class="screen" id="game-rotate">
  <div class="g-hdr"><button class="back" onclick="goHome()">←</button><span class="g-title">도형</span><div class="hearts" id="rot-hearts"></div><span class="g-timer" id="rot-round">1/10</span></div>
  <div class="g-body"><div class="g-score" id="rot-score">0점</div><div class="rotate-q" id="rot-q">회전된 같은 도형을 찾으세요</div><div class="rotate-original" id="rot-original"></div><div class="rotate-opts" id="rot-opts"></div></div>
</div>

<div class="screen" id="game-reverse">
  <div class="g-hdr"><button class="back" onclick="goHome()">←</button><span class="g-title">순서 뒤집기</span><div class="hearts" id="rev-hearts"></div><span class="g-timer" id="rev-level">Lv.1</span></div>
  <div class="g-body"><div class="g-score" id="rev-score">0점</div><div class="seq-msg" id="rev-msg">숫자를 거꾸로 입력하세요!</div><div class="rev-display" id="rev-display"></div><div class="rev-input" id="rev-input"></div>
    <div class="numpad" style="margin-top:auto">
      <button class="nbtn" onclick="revPress(1)">1</button><button class="nbtn" onclick="revPress(2)">2</button><button class="nbtn" onclick="revPress(3)">3</button><button class="nbtn" onclick="revPress(4)">4</button>
      <button class="nbtn" onclick="revPress(5)">5</button><button class="nbtn" onclick="revPress(6)">6</button><button class="nbtn" onclick="revPress(7)">7</button><button class="nbtn" onclick="revPress(8)">8</button>
      <button class="nbtn" onclick="revPress(9)">9</button><button class="nbtn" onclick="revPress(0)">0</button><button class="nbtn del" onclick="revDel()">⌫</button><button class="nbtn go" onclick="revSubmit()">확인</button>
    </div>
  </div>
</div>

<!-- ===== NEW GAMES ===== -->
<div class="screen" id="game-numtouch">
  <div class="g-hdr"><button class="back" onclick="goHome()">←</button><span class="g-title">넘버 터치</span><span class="g-timer" id="nt-timer">0.0s</span></div>
  <div class="g-body"><div class="g-score" id="nt-score">0점</div><div class="seq-msg" id="nt-msg">1부터 순서대로 터치!</div><div class="nt-grid" id="nt-grid"></div></div>
</div>

<div class="screen" id="game-rhythm">
  <div class="g-hdr"><button class="back" onclick="goHome()">←</button><span class="g-title">리듬 기억</span><div class="hearts" id="rhy-hearts"></div><span class="g-timer" id="rhy-level">Lv.1</span></div>
  <div class="g-body"><div class="g-score" id="rhy-score">0점</div><div class="seq-msg" id="rhy-msg">패턴을 기억하세요!</div><div class="rhy-pads" id="rhy-pads"><div class="rhy-pad" data-p="0" onclick="rhyTap(0)" style="--pc:#F04452"></div><div class="rhy-pad" data-p="1" onclick="rhyTap(1)" style="--pc:#3182F6"></div><div class="rhy-pad" data-p="2" onclick="rhyTap(2)" style="--pc:#1FC58E"></div><div class="rhy-pad" data-p="3" onclick="rhyTap(3)" style="--pc:#F59E0B"></div></div></div>
</div>

<div class="screen" id="game-rps">
  <div class="g-hdr"><button class="back" onclick="goHome()">←</button><span class="g-title">두뇌 가위바위보</span><div class="hearts" id="rps-hearts"></div><span class="g-timer" id="rps-timer">30s</span></div>
  <div class="g-body"><div class="g-score" id="rps-score">0점</div><div class="rps-q" id="rps-q">이기는 것을 내세요!</div><div class="rps-enemy" id="rps-enemy">바위</div><div class="rps-opts" id="rps-opts"><button class="rps-btn" onclick="rpsPick(0)">바위</button><button class="rps-btn" onclick="rpsPick(1)">보</button><button class="rps-btn" onclick="rpsPick(2)">가위</button></div></div>
</div>

<div class="screen" id="game-oddone">
  <div class="g-hdr"><button class="back" onclick="goHome()">←</button><span class="g-title">다른 글자 찾기</span><div class="hearts" id="odd-hearts"></div><span class="g-timer" id="odd-timer">30s</span></div>
  <div class="g-body"><div class="g-score" id="odd-score">0점</div><div class="seq-msg">다른 글자를 찾으세요!</div><div style="width:80%;max-width:240px;margin:0 auto 8px;height:4px;border-radius:2px;background:var(--border);overflow:hidden"><div id="odd-qbar" style="height:100%;background:var(--p);border-radius:2px;width:100%"></div></div><div class="odd-grid" id="odd-grid"></div></div>
</div>

<div class="screen" id="game-compare">
  <div class="g-hdr"><button class="back" onclick="goHome()">←</button><span class="g-title">크다작다</span><div class="hearts" id="cmp-hearts"></div><span class="g-timer" id="cmp-timer">30s</span></div>
  <div class="g-body"><div class="g-score" id="cmp-score">0점</div><div class="cmp-q" id="cmp-q" style="text-align:center;font-size:18px;font-weight:800;color:var(--p);padding:8px"></div><div style="width:80%;max-width:240px;margin:0 auto 8px;height:4px;border-radius:2px;background:var(--border);overflow:hidden"><div id="cmp-qbar" style="height:100%;background:var(--p);border-radius:2px;width:100%"></div></div><div class="cmp-nums"><span class="cmp-n" id="cmp-a" onclick="cmpPick('left')" style="cursor:pointer">0</span><span class="cmp-vs">vs</span><span class="cmp-n" id="cmp-b" onclick="cmpPick('right')" style="cursor:pointer">0</span></div><div style="text-align:center;font-size:12px;color:var(--sub);padding:4px">숫자를 터치하세요</div></div>
</div>

<div class="screen" id="game-bulb">
  <div class="g-hdr"><button class="back" onclick="goHome()">←</button><span class="g-title">전구 기억</span><div class="hearts" id="bulb-hearts"></div><span class="g-timer" id="bulb-level">Lv.1</span></div>
  <div class="g-body"><div class="g-score" id="bulb-score">0점</div><div class="seq-msg" id="bulb-msg">전구 순서를 기억하세요!</div><div class="bulb-grid" id="bulb-grid"></div></div>
</div>

<div class="screen" id="game-colormix">
  <div class="g-hdr"><button class="back" onclick="goHome()">←</button><span class="g-title">색깔 조합</span><div class="hearts" id="cmx-hearts"></div><span class="g-timer" id="cmx-round">1/10</span></div>
  <div class="g-body"><div class="g-score" id="cmx-score">0점</div><div class="cmx-q" id="cmx-q"></div><div style="width:80%;max-width:240px;margin:0 auto 8px;height:4px;border-radius:2px;background:var(--border);overflow:hidden"><div id="cmx-qbar" style="height:100%;background:var(--p);border-radius:2px;width:100%"></div></div><div class="cmx-opts" id="cmx-opts"></div></div>
</div>

<div class="screen" id="game-wordcomp">
  <div class="g-hdr"><button class="back" onclick="goHome()">←</button><span class="g-title">단어 완성</span><div class="hearts" id="wc-hearts"></div><span class="g-timer" id="wc-timer">30s</span></div>
  <div class="g-body"><div class="g-score" id="wc-score">0점</div><div class="wc-word" id="wc-word"></div><div class="wc-hint" id="wc-hint"></div><div style="width:80%;max-width:240px;margin:0 auto 8px;height:4px;border-radius:2px;background:var(--border);overflow:hidden"><div id="wc-qbar" style="height:100%;background:var(--p);border-radius:2px;width:100%"></div></div><div class="wc-opts" id="wc-opts"></div></div>
</div>

<div class="screen" id="game-timing">
  <div class="g-hdr"><button class="back" onclick="goHome()">←</button><span class="g-title">타이밍</span><span class="g-timer" id="tm-round">1/10</span></div>
  <div class="g-body"><div class="g-score" id="tm-score">0점</div><div class="seq-msg" id="tm-msg">목표에 맞춰 터치!</div><div class="tm-bar"><div class="tm-target" id="tm-target"></div><div class="tm-cursor" id="tm-cursor"></div></div><button class="btn btn-primary" id="tm-btn" onclick="tmStop()" style="margin-top:20px">STOP!</button></div>
</div>

<div class="screen" id="game-matchpair">
  <div class="g-hdr"><button class="back" onclick="goHome()">←</button><span class="g-title">짝 맞추기</span><span class="g-timer" id="mp-timer">30s</span></div>
  <div class="g-body"><div class="g-score" id="mp-score">0점</div><div class="seq-msg">한자어와 뜻을 연결하세요</div><div class="mp-cols" id="mp-cols"><div class="mp-col" id="mp-left"></div><div class="mp-col" id="mp-right"></div></div></div>
</div>

<!-- ===== NINTENDO-STYLE GAMES ===== -->
<div class="screen" id="game-headcount">
  <div class="g-hdr"><button class="back" onclick="goHome()">←</button><span class="g-title">인원 세기</span><span class="g-timer" id="hc-round">1/10</span></div>
  <div class="g-body"><div class="g-score" id="hc-score">0점</div>
    <div class="hc-stage" id="hc-stage">
      <svg class="hc-bldg" viewBox="0 0 140 150" fill="none">
        <!-- Building body -->
        <rect x="20" y="40" width="100" height="110" rx="6" fill="#fff" stroke="#E5E8EB" stroke-width="2"/>
        <!-- Roof -->
        <path d="M10 44L70 8L130 44" fill="#3182F6" stroke="#1B64DA" stroke-width="2" stroke-linejoin="round"/>
        <!-- Windows row 1 -->
        <rect x="34" y="56" width="20" height="18" rx="3" fill="#EBF3FE" stroke="#B4D5FE" stroke-width="1.5"/>
        <rect x="86" y="56" width="20" height="18" rx="3" fill="#EBF3FE" stroke="#B4D5FE" stroke-width="1.5"/>
        <!-- Windows row 2 -->
        <rect x="34" y="86" width="20" height="18" rx="3" fill="#EBF3FE" stroke="#B4D5FE" stroke-width="1.5"/>
        <rect x="86" y="86" width="20" height="18" rx="3" fill="#EBF3FE" stroke="#B4D5FE" stroke-width="1.5"/>
        <!-- Door -->
        <rect x="55" y="112" width="30" height="38" rx="4" fill="#3182F6" opacity=".15" stroke="#3182F6" stroke-width="2"/>
        <circle cx="79" cy="132" r="2.5" fill="#3182F6"/>
        <!-- Chimney -->
        <rect x="95" y="16" width="14" height="28" rx="2" fill="#8B95A1" opacity=".3"/>
      </svg>
      <div class="hc-counter" id="hc-counter"></div>
    </div>
    <div class="hc-log" id="hc-log"></div>
    <div class="seq-msg" id="hc-msg">집 안에 몇 명?</div>
    <div class="hc-opts" id="hc-opts"></div>
  </div>
</div>

<div class="screen" id="game-pyramid">
  <div class="g-hdr"><button class="back" onclick="goHome()">←</button><span class="g-title">피라미드 연산</span><div class="hearts" id="pyr-hearts"></div><span class="g-timer" id="pyr-round">1/10</span></div>
  <div class="g-body"><div class="g-score" id="pyr-score">0점</div>
    <div class="seq-msg">인접한 수의 합 = 윗칸</div>
    <div class="pyr-grid" id="pyr-grid"></div>
  </div>
</div>

<div class="screen" id="game-maxnum">
  <div class="g-hdr"><button class="back" onclick="goHome()">←</button><span class="g-title">수 찾기</span><div class="hearts" id="mn-hearts"></div><span class="g-timer" id="mx-timer">30s</span></div>
  <div class="g-body"><div class="g-score" id="mx-score">0점</div>
    <div class="seq-msg" id="mx-msg">가장 큰 수를 터치!</div>
    <div style="width:80%;max-width:240px;margin:0 auto 8px;height:4px;border-radius:2px;background:var(--border);overflow:hidden"><div id="mn-qbar" style="height:100%;background:var(--p);border-radius:2px;width:100%"></div></div>
    <div class="mx-grid" id="mx-grid"></div>
  </div>
</div>

<div class="screen" id="game-signfind">
  <div class="g-hdr"><button class="back" onclick="goHome()">←</button><span class="g-title">부호 찾기</span><div class="hearts" id="sf-hearts"></div><span class="g-timer" id="sf-timer">30s</span></div>
  <div class="g-body"><div class="g-score" id="sf-score">0점</div>
    <div class="sf-eq" id="sf-eq"></div>
    <div style="width:80%;max-width:240px;margin:0 auto 8px;height:4px;border-radius:2px;background:var(--border);overflow:hidden"><div id="sf-qbar" style="height:100%;background:var(--p);border-radius:2px;width:100%"></div></div>
    <div class="sf-opts" id="sf-opts"></div>
  </div>
</div>

<div class="screen" id="game-coincount">
  <div class="g-hdr"><button class="back" onclick="goHome()">←</button><span class="g-title">동전 세기</span><div class="hearts" id="cc-hearts"></div><span class="g-timer" id="cc-timer">30s</span></div>
  <div class="g-body"><div class="g-score" id="cc-score">0점</div>
    <div class="seq-msg">동전 합계는?</div>
    <div class="cc-coins" id="cc-coins"></div>
    <div class="cc-opts" id="cc-opts"></div>
  </div>
</div>

<div class="screen" id="game-clock">
  <div class="g-hdr"><button class="back" onclick="goHome()">←</button><span class="g-title">시계 읽기</span><div class="hearts" id="clk-hearts"></div><span class="g-timer" id="clk-round">1/10</span></div>
  <div class="g-body"><div class="g-score" id="clk-score">0점</div>
    <canvas id="clk-canvas" width="240" height="240" style="display:block;margin:16px auto"></canvas>
    <div style="width:80%;max-width:240px;margin:0 auto 8px;height:4px;border-radius:2px;background:var(--border);overflow:hidden"><div id="clk-qbar" style="height:100%;background:var(--p);border-radius:2px;width:100%"></div></div>
    <div class="seq-msg">지금 몇 시 몇 분?</div>
    <div class="clk-opts" id="clk-opts"></div>
  </div>
</div>

<div class="screen" id="game-wordmem">
  <div class="g-hdr"><button class="back" onclick="goHome()">←</button><span class="g-title">단어 암기</span><div class="hearts" id="wm-hearts"></div><span class="g-timer" id="wm-level">Lv.1</span></div>
  <div class="g-body"><div class="g-score" id="wm-score">0점</div>
    <div class="seq-msg" id="wm-msg">단어를 기억하세요!</div>
    <div class="wm-display" id="wm-display"></div>
    <div class="wm-opts" id="wm-opts"></div>
  </div>
</div>

<div class="screen" id="game-blockcount">
  <div class="g-hdr"><button class="back" onclick="goHome()">←</button><span class="g-title">블록 세기</span><div class="hearts" id="bc-hearts"></div><span class="g-timer" id="bc-round">1/10</span></div>
  <div class="g-body"><div class="g-score" id="bc-score">0점</div>
    <canvas id="bc-canvas" width="280" height="240" style="display:block;margin:16px auto"></canvas>
    <div class="seq-msg">블록이 몇 개?</div>
    <div class="bc-opts" id="bc-opts"></div>
  </div>
</div>

<!-- 29. FLANKER -->
<div class="screen" id="game-flanker">
  <div class="g-hdr"><button class="back" onclick="goHome()">←</button><span class="g-title">방향 맞추기</span><div class="hearts" id="fk-hearts"></div><span class="g-timer" id="fk-timer">30s</span></div>
  <div class="g-body"><div class="g-score" id="fk-score">0점</div>
    <div class="seq-msg" id="fk-msg">가운데 큰 화살표의 방향은?</div>
    <div id="fk-display" style="text-align:center;padding:20px 0;user-select:none;display:flex;align-items:center;justify-content:center;gap:4px"></div>
    <div id="fk-btns" style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;padding:16px;max-width:280px;margin:0 auto">
      <div></div><button class="btn btn-weak" onclick="fkPick('up')" style="font-size:28px;padding:14px;width:auto">↑</button><div></div>
      <button class="btn btn-weak" onclick="fkPick('left')" style="font-size:28px;padding:14px;width:auto">←</button><div></div><button class="btn btn-weak" onclick="fkPick('right')" style="font-size:28px;padding:14px;width:auto">→</button>
      <div></div><button class="btn btn-weak" onclick="fkPick('down')" style="font-size:28px;padding:14px;width:auto">↓</button><div></div>
    </div>
  </div>
</div>
<!-- 30. MEMGRID -->
<div class="screen" id="game-memgrid">
  <div class="g-hdr"><button class="back" onclick="goHome()">←</button><span class="g-title">격자 기억</span><div class="hearts" id="mg-hearts"></div><span class="g-timer" id="mg-level">Lv.1</span></div>
  <div class="g-body"><div class="g-score" id="mg-score">0점</div>
    <div class="seq-msg" id="mg-msg">칸을 기억하세요!</div>
    <div id="mg-grid" style="display:grid;gap:6px;margin:16px auto;width:fit-content"></div>
  </div>
</div>
<!-- 31. NBACK -->
<div class="screen" id="game-nback">
  <div class="g-hdr"><button class="back" onclick="goHome()">←</button><span class="g-title">같거나 다르거나</span><span class="g-timer" id="nb-round">1/20</span></div>
  <div class="g-body"><div class="g-score" id="nb-score">0점</div>
    <div class="seq-msg" id="nb-msg">이전 카드와 같으면 O, 다르면 X</div>
    <div id="nb-card" style="width:120px;height:120px;margin:16px auto;border-radius:var(--r16);display:flex;align-items:center;justify-content:center;font-size:48px;font-weight:900;background:var(--card);box-shadow:var(--shadow);border:3px solid var(--border)"></div>
    <div style="display:flex;gap:12px;justify-content:center;padding:16px"><button class="btn btn-primary" onclick="nbPick(true)" style="width:120px;font-size:22px;padding:14px">같다 O</button><button class="btn btn-danger-weak" onclick="nbPick(false)" style="width:120px;font-size:22px;padding:14px">다르다 X</button></div>
  </div>
</div>
<!-- 32. SCRAMBLE -->
<div class="screen" id="game-scramble">
  <div class="g-hdr"><button class="back" onclick="goHome()">←</button><span class="g-title">글자 섞기</span><div class="hearts" id="sc-hearts"></div><span class="g-timer" id="sc-timer">30s</span></div>
  <div class="g-body"><div class="g-score" id="sc-score">0점</div>
    <div class="seq-msg">섞인 글자를 올바른 순서로!</div>
    <div style="width:80%;max-width:240px;margin:0 auto 8px;height:4px;border-radius:2px;background:var(--border);overflow:hidden"><div id="sc-qbar" style="height:100%;background:var(--p);border-radius:2px;width:100%"></div></div>
    <div id="sc-scrambled" style="display:flex;gap:8px;justify-content:center;padding:16px;font-size:32px;font-weight:800"></div>
    <div id="sc-opts" style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;padding:0 16px"></div>
  </div>
</div>
<!-- 33. SERIAL -->
<div class="screen" id="game-serial">
  <div class="g-hdr"><button class="back" onclick="goHome()">←</button><span class="g-title">연속 빼기</span><span class="g-timer" id="sr-timer">30s</span></div>
  <div class="g-body"><div class="g-score" id="sr-score">0점</div>
    <div id="sr-q" style="text-align:center;font-size:16px;font-weight:700;color:var(--p);padding:8px"></div>
    <div id="sr-num" style="text-align:center;font-size:52px;font-weight:900;padding:16px 0"></div>
    <div id="sr-opts" style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;padding:0 16px"></div>
  </div>
</div>
<!-- 34. LEFTRIGHT -->
<div class="screen" id="game-leftright">
  <div class="g-hdr"><button class="back" onclick="goHome()">←</button><span class="g-title">좌우 판단</span><div class="hearts" id="lr-hearts"></div><span class="g-timer" id="lr-timer">30s</span></div>
  <div class="g-body"><div class="g-score" id="lr-score">0점</div>
    <div id="lr-hand" style="font-size:100px;text-align:center;padding:16px 0;user-select:none"></div>
    <div class="seq-msg" id="lr-msg">이 손은?</div>
    <div style="width:80%;max-width:240px;margin:0 auto 8px;height:4px;border-radius:2px;background:var(--border);overflow:hidden"><div id="lr-qbar" style="height:100%;background:var(--p);border-radius:2px;width:100%"></div></div>
    <div style="display:flex;gap:12px;justify-content:center;padding:16px"><button class="btn btn-weak" onclick="lrPick('left')" style="width:120px;font-size:18px;padding:14px">왼손</button><button class="btn btn-weak" onclick="lrPick('right')" style="width:120px;font-size:18px;padding:14px">오른손</button></div>
  </div>
</div>
<!-- 35. CALCCOMP -->
<div class="screen" id="game-calccomp">
  <div class="g-hdr"><button class="back" onclick="goHome()">←</button><span class="g-title">계산 비교</span><div class="hearts" id="cc2-hearts"></div><span class="g-timer" id="cc2-timer">30s</span></div>
  <div class="g-body"><div class="g-score" id="cc2-score">0점</div>
    <div class="seq-msg">더 큰 쪽을 터치!</div>
    <div style="width:80%;max-width:240px;margin:0 auto 8px;height:4px;border-radius:2px;background:var(--border);overflow:hidden"><div id="cc2-qbar" style="height:100%;background:var(--p);border-radius:2px;width:100%"></div></div>
    <div style="display:flex;gap:12px;justify-content:center;align-items:center;padding:20px 16px">
      <div id="cc2-a" onclick="cc2Pick('left')" style="flex:1;padding:24px 8px;text-align:center;font-size:22px;font-weight:800;background:var(--card);border-radius:var(--r16);box-shadow:var(--shadow);cursor:pointer;border:2px solid var(--border)"></div>
      <span style="font-size:18px;font-weight:700;color:var(--sub)">VS</span>
      <div id="cc2-b" onclick="cc2Pick('right')" style="flex:1;padding:24px 8px;text-align:center;font-size:22px;font-weight:800;background:var(--card);border-radius:var(--r16);box-shadow:var(--shadow);cursor:pointer;border:2px solid var(--border)"></div>
    </div>
  </div>
</div>
<!-- 36. FLASH -->
<div class="screen" id="game-flash">
  <div class="g-hdr"><button class="back" onclick="goHome()">←</button><span class="g-title">순간 포착</span><div class="hearts" id="fl-hearts"></div><span class="g-timer" id="fl-level">Lv.1</span></div>
  <div class="g-body"><div class="g-score" id="fl-score">0점</div>
    <div class="seq-msg" id="fl-msg">숫자를 기억하세요!</div>
    <div id="fl-display" style="text-align:center;font-size:56px;font-weight:900;padding:24px 16px;letter-spacing:6px;word-break:break-all;overflow-wrap:break-word"></div>
    <div id="fl-input" style="text-align:center;padding:8px"></div>
  </div>
</div>
<!-- 37. SORT -->
<div class="screen" id="game-sort">
  <div class="g-hdr"><button class="back" onclick="goHome()">←</button><span class="g-title">카테고리 분류</span><span class="g-timer" id="st-timer">30s</span></div>
  <div class="g-body"><div class="g-score" id="st-score">0점</div>
    <div style="display:flex;gap:8px;justify-content:center;padding:8px 16px"><div id="st-cat1" style="flex:1;padding:10px;text-align:center;font-size:14px;font-weight:700;border-radius:var(--r12);background:var(--p);color:#fff"></div><div id="st-cat2" style="flex:1;padding:10px;text-align:center;font-size:14px;font-weight:700;border-radius:var(--r12);background:#F43F5E;color:#fff"></div></div>
    <div id="st-word" style="text-align:center;font-size:36px;font-weight:900;padding:24px 0"></div>
    <div style="display:flex;gap:12px;justify-content:center;padding:16px"><button class="btn btn-weak" id="st-btn1" onclick="stPick(0)" style="width:120px;padding:14px;font-size:16px"></button><button class="btn btn-danger-weak" id="st-btn2" onclick="stPick(1)" style="width:120px;padding:14px;font-size:16px"></button></div>
  </div>
</div>
<!-- 38. MIRROR -->
<div class="screen" id="game-mirror">
  <div class="g-hdr"><button class="back" onclick="goHome()">←</button><span class="g-title">거울 문자</span><div class="hearts" id="mr-hearts"></div><span class="g-timer" id="mr-timer">30s</span></div>
  <div class="g-body"><div class="g-score" id="mr-score">0점</div>
    <div class="seq-msg">뒤집힌 글자를 읽으세요!</div>
    <div id="mr-char" style="text-align:center;font-size:80px;font-weight:900;padding:20px 0;transform:scaleX(-1);user-select:none"></div>
    <div id="mr-opts" style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;padding:0 16px"></div>
  </div>
</div>

<!-- ===== TICKET SHOP ===== -->
<div class="screen" id="ticketShop">
  <div class="g-hdr"><button class="back" onclick="goHome()">←</button><span class="g-title">티켓 충전</span></div>
  <div class="g-body" style="padding:24px 20px;text-align:center">
    <div style="margin:20px 0 16px"><img src="https://static.toss.im/2d-emojis/svg/u1F39F.svg" style="width:72px;height:72px"></div>
    <div style="font-size:14px;color:var(--sub);margin-bottom:4px">보유 티켓</div>
    <div id="ts-count" style="font-size:40px;font-weight:800;color:var(--p);margin-bottom:24px">0장</div>

    <button class="btn btn-primary" onclick="ticketAdRefill()" id="ts-ad-btn" style="width:100%;font-size:16px;padding:16px;margin-bottom:20px">
      <span style="display:flex;align-items:center;justify-content:center;gap:8px"><img src="https://static.toss.im/2d-emojis/svg/u1F3AC.svg" style="width:20px;height:20px">광고 보고 3~5장 받기</span>
    </button>

    <div style="background:var(--card);border-radius:var(--r16);padding:16px 20px;margin-bottom:12px;box-shadow:var(--shadow);display:flex;align-items:center;gap:12px">
      <img src="https://static.toss.im/2d-emojis/svg/u23F0.svg" style="width:32px;height:32px;flex-shrink:0">
      <div style="text-align:left"><div style="font-size:15px;font-weight:700">매일 오전 9시 자동 충전</div><div style="font-size:12px;color:var(--sub);margin-top:2px">5장 미만이면 5장으로 채워져요</div></div>
    </div>
    <div style="font-size:12px;color:var(--sub)">최대 99장까지 보유 가능</div>

    <!-- 배너 광고 영역 -->
    <div id="ts-banner" style="margin-top:24px;min-height:50px;background:var(--border);border-radius:var(--r12);display:flex;align-items:center;justify-content:center;color:var(--sub);font-size:12px">광고 영역</div>
  </div>
</div>

<!-- ===== RESULT ===== -->
<!-- Ticket Modal -->
<div class="overlay" id="ticketModal" style="display:none;z-index:1001">
  <div style="background:var(--card);border-radius:var(--r20);padding:28px 24px;margin:auto;max-width:320px;text-align:center;box-shadow:0 8px 32px rgba(0,0,0,.15)">
    <div style="margin-bottom:12px"><img src="https://static.toss.im/2d-emojis/svg/u1F39F.svg" style="width:48px;height:48px"></div>
    <div style="font-size:18px;font-weight:800;margin-bottom:6px">티켓을 모두 사용했어요</div>
    <div style="font-size:14px;color:var(--sub);margin-bottom:6px">오전 9시에 티켓이 충전됩니다</div>
    <div style="font-size:13px;color:var(--sub);margin-bottom:20px">광고를 보고 바로 시작할 수도 있어요!</div>
    <button class="btn btn-primary" id="ticketAdBtn" style="width:100%;margin-bottom:10px;font-size:16px;padding:14px">잠깐 광고보고 시작하기</button>
    <button class="btn btn-home" onclick="closeTicketModal()" style="width:100%;font-size:14px;padding:12px">돌아가기</button>
  </div>
</div>

<div class="overlay" id="overlay">
  <div class="result-sheet">
    <div class="r-handle"></div>
    <div style="height:20px"></div>
    <div style="background:var(--card);border-radius:var(--r16);padding:24px 20px 16px;margin-bottom:14px;box-shadow:var(--shadow)">
      <h3 id="r-title">훈련 완료!</h3>
      <div class="r-score" id="r-score">0</div>
      <div id="r-bonus" class="hide" style="text-align:center;margin:4px 0;transition:all .5s"></div>
      <div class="r-cat" id="r-cat"></div>
      <div style="display:flex;gap:6px;justify-content:center;flex-wrap:wrap"><div class="r-xp hide" id="r-xp">+0 XP</div><div class="r-xp hide" id="r-pt" style="background:var(--p)">+0 두뇌점수</div></div>
      <div class="r-mission hide" id="r-mission"></div>
      <div class="r-stats" id="r-stats"></div>
    </div>
    <div id="r-percentile" class="hide" style="text-align:center;margin-bottom:14px;padding:12px 16px;background:linear-gradient(135deg,var(--p-light),#F3E8FF);border-radius:var(--r12);border:1px solid var(--border)"><div style="font-size:12px;color:var(--sub);margin-bottom:2px">전체 플레이어 중</div><div id="r-pct-val" style="font-size:24px;font-weight:800;color:var(--purple)">상위 10%</div><div id="r-pct-players" style="font-size:11px;color:var(--sub);margin-top:2px"></div></div>
    <div id="r-science" style="background:var(--card);border-radius:var(--r12);padding:14px 16px;margin-bottom:12px;text-align:left;border:1px solid var(--border)">
      <div style="font-size:13px;font-weight:700;color:var(--p);margin-bottom:4px" id="r-sci-title"></div>
      <div style="font-size:12px;color:var(--sub);line-height:1.5" id="r-sci-desc"></div>
    </div>
    <!-- Brain Age Card -->
    <!-- brain age removed: rank = brain age -->
    <!-- 재도전 (최우선) -->
    <div id="r-retry-msg" class="hide" style="text-align:center;font-size:13px;font-weight:600;color:var(--p);padding:8px 16px;margin-bottom:6px;background:var(--p)10;border-radius:var(--r12)"></div>
    <button class="btn btn-primary" id="r-main-btn" onclick="replayGame()" style="width:100%;font-size:17px;padding:16px;font-weight:800;margin-bottom:12px">광고보고 한 번 더 도전하기</button>

    <!-- Share & Leaderboard -->
    <div style="display:flex;gap:8px;margin-bottom:8px">
      <button class="btn btn-weak" id="r-share-btn" onclick="shareScore()" style="flex:1;margin:0;font-size:13px;font-weight:600;padding:10px;display:flex;align-items:center;justify-content:center;gap:6px"><img src="https://static.toss.im/2d-emojis/svg/u1F4E4.svg" style="width:16px;height:16px">공유</button>
      <button class="btn btn-weak" id="r-lb-btn" onclick="AIT.openLeaderboard()" style="flex:1;margin:0;font-size:13px;font-weight:600;padding:10px;display:flex;align-items:center;justify-content:center;gap:6px"><img src="https://static.toss.im/2d-emojis/svg/u1F3C6.svg" style="width:16px;height:16px">리더보드</button>
      <button class="btn btn-weak" id="r-invite-btn" onclick="inviteFriend()" style="flex:1;margin:0;font-size:13px;font-weight:600;padding:10px;display:flex;align-items:center;justify-content:center;gap:6px"><img src="https://static.toss.im/2d-emojis/svg/u1F44B.svg" style="width:16px;height:16px">초대</button>
    </div>

    <button class="btn btn-home" onclick="goHomeFromResult()" style="margin-top:0">홈으로</button>
  </div>
</div>

<!-- ===== WORKOUT TRANSITION ===== -->
<div class="wk-transition" id="wkTransition">
  <div class="wkt-progress" id="wkt-progress">1 / 3</div>
  <div class="wkt-next" id="wkt-icon">🧮</div>
  <div class="wkt-name" id="wkt-name">암산 챌린지</div>
  <div class="wkt-desc" id="wkt-desc">준비되셨나요?</div>
  <button class="btn btn-primary" onclick="wkStartNext()" style="width:200px;margin-top:12px">시작하기</button>
</div>

<!-- ===== HEART REFILL ===== -->
<!-- Time Extend Overlay -->
<div class="heart-overlay" id="timeExtendOverlay">
  <div class="heart-card">
    <div style="font-size:18px;font-weight:800;line-height:1.5;margin-bottom:20px">시간 종료!<br>광고를 보고 5초 더 도전하세요</div>
    <div style="margin-bottom:24px"><img src="https://static.toss.im/2d-emojis/svg/u23F0.svg" style="width:72px;height:72px"></div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-home" onclick="timeExtendQuit()" style="flex:1;margin:0">그만두기</button>
      <button class="btn btn-primary" onclick="timeExtendAccept()" style="flex:1;margin:0">5초 더 하기</button>
    </div>
  </div>
</div>

<div class="heart-overlay" id="heartOverlay">
  <div class="heart-card">
    <div style="font-size:18px;font-weight:800;line-height:1.5;margin-bottom:20px">잠깐 광고를 보면<br>하트를 하나 더 드려요</div>
    <div style="margin-bottom:24px"><img src="https://static.toss.im/2d-emojis/svg/u2764.svg" style="width:72px;height:72px"></div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-home" onclick="heartQuit()" style="flex:1;margin:0">그만두기</button>
      <button class="btn btn-primary" onclick="refillHearts()" style="flex:1;margin:0">계속하기</button>
    </div>
  </div>
</div>

<!-- ===== LEVEL UP ===== -->
<div class="levelup-overlay" id="levelupOverlay">
  <div class="levelup-card">
    <div class="lu-badge" id="lu-badge" style="font-size:48px"></div>
    <div class="lu-title" id="lu-title">실버 승급!</div>
    <div class="lu-desc" id="lu-desc">두뇌 훈련을 꾸준히 하고 계시네요!</div>
    <div class="lu-unlock hide" id="lu-unlock"></div>
    <button class="btn btn-primary" onclick="closeLevelUp()">확인</button>
  </div>
</div>

</div>

<script>
// ===== APPINTOSS SDK WRAPPER =====
// Detects Toss WebView environment and provides unified API
// When running outside Toss app, falls back to mock/web behavior
const AIT = (() => {
  const isToss = typeof window !== 'undefined' && (window.__granite__ || window.__ait__ || navigator.userAgent.includes('TossApp'));
  let _userHash = null;
  let _adLoaded = { interstitial: false, rewarded: false };

  // ── Config (플레이스홀더 — 콘솔 발급 후 교체) ──
  const CONFIG = {
    AD_INTERSTITIAL_ID: 'ait-ad-test-interstitial-id',  // TODO: 실제 광고 그룹 ID로 교체
    AD_REWARDED_ID: 'ait-ad-test-rewarded-id',           // TODO: 실제 광고 그룹 ID로 교체
    LEADERBOARD_ID: 'PLACEHOLDER_LEADERBOARD_ID',        // TODO: 게임센터 리더보드 ID
    PROMO_CODE: 'PLACEHOLDER_PROMO_CODE',                // TODO: 프로모션 코드 (레거시)
    PROMO_AMOUNT: 100,
    // 4 Promotions (IDs filled after approval)
    PROMO_FIRST_LOGIN: 'PLACEHOLDER_PROMO_FIRST_LOGIN',
    PROMO_BRAIN_AGE_50: 'PLACEHOLDER_PROMO_BRAIN_AGE_50',
    PROMO_POINT_100: 'PLACEHOLDER_PROMO_POINT_100',
    PROMO_FIRST_WORKOUT: 'PLACEHOLDER_PROMO_FIRST_WORKOUT',
    SHARE_MODULE_ID: 'PLACEHOLDER_SHARE_MODULE_ID',      // TODO: 공유 리워드 모듈 ID
  };

  // ── User Key ──
  async function getUserHash() {
    if (_userHash) return _userHash;
    if (!isToss) { _userHash = 'web_' + (localStorage.getItem('bf-uid') || (() => { const id = crypto.randomUUID(); localStorage.setItem('bf-uid', id); return id; })()); return _userHash; }
    try {
      // @apps-in-toss/web-framework의 getUserKeyForGame() 호출
      const result = await window.__granite__?.getUserKeyForGame?.();
      if (result?.type === 'HASH') { _userHash = result.hash; return _userHash; }
    } catch (e) { console.warn('AIT getUserKeyForGame failed:', e); }
    _userHash = 'toss_anonymous';
    return _userHash;
  }

  // ── Ads ──
  function preloadAd(type) {
    if (!isToss) return;
    const id = type === 'rewarded' ? CONFIG.AD_REWARDED_ID : CONFIG.AD_INTERSTITIAL_ID;
    try {
      window.__granite__?.loadAppsInTossAdMob?.({
        options: { adGroupId: id },
        onEvent: (e) => { if (e === 'adLoaded') _adLoaded[type] = true; },
        onError: () => { _adLoaded[type] = false; }
      });
    } catch (e) { console.warn('AIT ad preload failed:', e); }
  }

  async function showAd(type) {
    if (!isToss) { console.log(`[Mock] ${type} ad shown`); return { success: true, mock: true }; }
    const id = type === 'rewarded' ? CONFIG.AD_REWARDED_ID : CONFIG.AD_INTERSTITIAL_ID;
    return new Promise((resolve) => {
      try {
        window.__granite__?.showAppsInTossAdMob?.({
          options: { adUnitId: id },
          onEvent: (event) => {
            if (event === 'userEarnedReward' || event === 'adDismissed') {
              _adLoaded[type] = false;
              preloadAd(type); // 다음 광고 미리 로드
              resolve({ success: true, event });
            }
          },
          onError: (err) => { resolve({ success: false, error: err }); }
        });
      } catch (e) { resolve({ success: false, error: e }); }
    });
  }

  // ── Game Center ──
  async function submitScore(score) {
    if (!isToss) return { mock: true };
    try {
      return await window.__granite__?.submitGameCenterLeaderBoardScore?.({ score: String(score) });
    } catch (e) { return { error: e }; }
  }

  async function openLeaderboard() {
    if (!isToss) return;
    try { await window.__granite__?.openGameCenterLeaderboard?.(); } catch (e) { console.warn('AIT leaderboard failed:', e); }
  }

  async function getProfile() {
    if (!isToss) return null;
    try { return await window.__granite__?.getGameCenterGameProfile?.(); } catch (e) { return null; }
  }

  // ── Storage (Toss native or localStorage fallback) ──
  async function storageGet(key) {
    if (!isToss) return localStorage.getItem(key);
    try { return await window.__granite__?.getItem?.(key); } catch (e) { return localStorage.getItem(key); }
  }

  async function storageSet(key, value) {
    if (!isToss) { localStorage.setItem(key, value); return; }
    try { await window.__granite__?.setItem?.(key, value); } catch (e) { localStorage.setItem(key, value); }
  }

  // ── Haptic ──
  function haptic(type = 'light') {
    if (!isToss) return;
    try { window.__granite__?.generateHapticFeedback?.({ type }); } catch (e) {}
  }

  // ── Promotion Reward ──
  async function grantPromoReward(code, amount) {
    if (!isToss) return { mock: true };
    try {
      return await window.__granite__?.grantPromotionRewardForGame?.({ params: { promotionCode: code || CONFIG.PROMO_CODE, amount: amount || CONFIG.PROMO_AMOUNT } });
    } catch (e) { return { error: e }; }
  }

  // ── Share (친구초대/공유) ──
  function shareInvite(moduleId) {
    if (!isToss) { console.log('[Mock] share invite'); return () => {}; }
    try {
      return window.__granite__?.contactsViral?.({
        options: { moduleId: moduleId || CONFIG.SHARE_MODULE_ID },
        onEvent: (e) => { console.log('AIT share event:', e); },
        onError: (e) => { console.warn('AIT share error:', e); }
      }) || (() => {});
    } catch (e) { return () => {}; }
  }

  // ── Simple Share ──
  async function shareMessage(msg) {
    if (!isToss) { if (navigator.share) await navigator.share({ text: msg }); return; }
    try { await window.__granite__?.share?.({ message: msg }); } catch (e) {}
  }

  // ── Event Log (분석) ──
  async function log(name, params = {}) {
    if (!isToss) { console.log(`[AIT Log] ${name}`, params); return; }
    try { await window.__granite__?.eventLog?.({ log_name: name, params }); } catch (e) {}
  }

  // ── Screen Awake (게임 중 화면 꺼짐 방지) ──
  async function setScreenAwake(enabled) {
    if (!isToss) return;
    try { await window.__granite__?.setScreenAwakeMode?.({ enabled }); } catch (e) {}
  }

  // ── Close View (미니앱 닫기) ──
  async function close() {
    if (!isToss) { window.close(); return; }
    try { await window.__granite__?.closeView?.(); } catch (e) {}
  }

  // ── Device Info ──
  function getDeviceId() {
    if (!isToss) return 'web_device';
    try { return window.__granite__?.getDeviceId?.() || 'unknown'; } catch (e) { return 'unknown'; }
  }

  function getPlatform() {
    if (!isToss) return 'web';
    try { return window.__granite__?.getPlatformOS?.() || 'unknown'; } catch (e) { return 'unknown'; }
  }

  function getEnv() {
    if (!isToss) return 'web';
    try { return window.__granite__?.getOperationalEnvironment?.() || 'web'; } catch (e) { return 'web'; }
  }

  // ── Toss Login ──
  let _loginData = null;
  async function login() {
    if (!isToss) { console.log('[Mock] Toss login'); return { mock: true, userHash: await getUserHash() }; }
    try {
      const { authorizationCode, referrer } = await window.__granite__?.appLogin?.() || {};
      if (!authorizationCode) return { error: 'no_auth_code' };
      const resp = await fetch('/api/score/toss/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ authorizationCode, referrer })
      });
      const data = await resp.json();
      if (data.status === 'ok') {
        _userHash = data.userHash;
        _loginData = data;
        await storageSet('toss_userKey', data.userKey);
        await storageSet('toss_name', data.name || '');
        log('toss_login', { userKey: data.userKey });
        checkPromoFirstLogin();
      }
      return data;
    } catch (e) { console.error('AIT login failed:', e); return { error: e.message }; }
  }

  function getLoginData() { return _loginData; }

  // ── Promotion (중복 방지 + SDK 호출) ──
  const _promoGranted = {};
  let _promoLock = {};
  async function triggerPromo(promoType, promoCode, amount) {
    // 1회성 프로모션 메모리 중복 방지
    if (promoType !== 'POINT_100' && _promoGranted[promoType]) return;
    // 동시 호출 잠금
    if (_promoLock[promoType]) return;
    _promoLock[promoType] = true;
    try {
      const uh = await getUserHash();
      // 서버에서 이미 지급했는지 확인 (POINT_100은 반복 가능이므로 스킵)
      if (promoType !== 'POINT_100') {
        try {
          const chk = await fetch(`/api/score/promo/check/${uh}/${promoType}`).then(r=>r.json());
          if (chk.granted) { _promoGranted[promoType] = true; return; }
        } catch(e) { return; } // 서버 오류 시 안전하게 중단
      }
      // SDK 호출 (토스 환경)
      if (isToss) {
        await grantPromoReward(promoCode, amount);
        log('promo_granted', { type: promoType, amount });
      }
      // 서버에 기록 (1회성만)
      if (promoType !== 'POINT_100') {
        await fetch('/api/score/promo/record', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userHash: uh, promoType, promoCode, amount })
        });
        _promoGranted[promoType] = true;
      }
    } finally {
      _promoLock[promoType] = false;
    }
  }

  // 프로모션 1: 첫 로그인
  async function checkPromoFirstLogin() {
    triggerPromo('FIRST_LOGIN', CONFIG.PROMO_FIRST_LOGIN, 10);
  }
  // 프로모션 2: 두뇌나이 50세 달성 (called from addXP outside AIT scope)
  async function checkPromoBrainAge50(xp) {
    // RANKS is defined outside AIT, check after DOM ready
    if (typeof RANKS === 'undefined') return;
    const rank = RANKS.reduce((a,r) => xp >= r.minXp ? r : a, RANKS[0]);
    if (rank && rank.age <= 50) {
      triggerPromo('BRAIN_AGE_50', CONFIG.PROMO_BRAIN_AGE_50, 50);
    }
  }
  // 프로모션 3: 두뇌점수 100점 교환
  async function checkPromoPoint100() {
    triggerPromo('POINT_100', CONFIG.PROMO_POINT_100, 100);
  }
  // 프로모션 4: 첫 두뇌운동 완료
  async function checkPromoFirstWorkout() {
    triggerPromo('FIRST_WORKOUT', CONFIG.PROMO_FIRST_WORKOUT, 10);
  }

  // ── Init ──
  async function init() {
    await getUserHash();
    if (isToss) {
      preloadAd('interstitial');
      preloadAd('rewarded');
      setScreenAwake(true);
      log('app_open', { version: 'v57' });
      // 자동 로그인 시도
      login().catch(e => console.warn('Auto login failed:', e));
    }
  }

  return {
    isToss, CONFIG, getUserHash, login, getLoginData, triggerPromo,
    checkPromoFirstLogin, checkPromoBrainAge50, checkPromoPoint100, checkPromoFirstWorkout,
    showAd, preloadAd,
    submitScore, openLeaderboard, getProfile,
    storageGet, storageSet, haptic,
    grantPromoReward, shareInvite, shareMessage,
    log, setScreenAwake, close, getDeviceId, getPlatform, getEnv,
    init, get userHash() { return _userHash; }
  };
})();

// Initialize SDK on load
AIT.init();

// ===== GAME DATA =====
const GI={
math:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>`,
memory:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="3" y="3" rx="2" width="7" height="7"/><rect x="14" y="3" rx="2" width="7" height="7"/><rect x="3" y="14" rx="2" width="7" height="7"/><rect x="14" y="14" rx="2" width="7" height="7"/></svg>`,
reaction:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>`,
stroop:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="3"/><circle cx="7" cy="7" r="2"/><circle cx="17" cy="7" r="2"/><circle cx="7" cy="17" r="2"/><circle cx="17" cy="17" r="2"/></svg>`,
sequence:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="4" y1="6" x2="4" y2="6.01"/><line x1="4" y1="12" x2="4" y2="12.01"/><line x1="4" y1="18" x2="4" y2="18.01"/><line x1="8" y1="6" x2="20" y2="6"/><line x1="8" y1="12" x2="20" y2="12"/><line x1="8" y1="18" x2="20" y2="18"/></svg>`,
word:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="11" cy="11" r="7"/><line x1="16.5" y1="16.5" x2="21" y2="21"/><line x1="8" y1="11" x2="14" y2="11"/></svg>`,
pattern:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>`,
focus:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="3"/><circle cx="12" cy="12" r="8"/><line x1="12" y1="2" x2="12" y2="4"/><line x1="12" y1="20" x2="12" y2="22"/><line x1="2" y1="12" x2="4" y2="12"/><line x1="20" y1="12" x2="22" y2="12"/></svg>`,
rotate:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 11-3-6.7"/><polyline points="21 3 21 9 15 9"/></svg>`,
reverse:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"/><polyline points="23 20 23 14 17 14"/><path d="M20.49 9A9 9 0 005.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 013.51 15"/></svg>`,
numtouch:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="3" y="3" rx="2" width="18" height="18"/><text x="7" y="11" font-size="6" font-weight="bold" fill="currentColor" stroke="none">1</text><text x="13" y="11" font-size="6" font-weight="bold" fill="currentColor" stroke="none">2</text><text x="7" y="18" font-size="6" font-weight="bold" fill="currentColor" stroke="none">3</text><text x="13" y="18" font-size="6" font-weight="bold" fill="currentColor" stroke="none">4</text></svg>`,
rhythm:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3" fill="currentColor"/><circle cx="18" cy="16" r="3" fill="currentColor"/></svg>`,
rps:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="6" cy="18" r="4"/><circle cx="18" cy="18" r="4"/><line x1="6" y1="14" x2="6" y2="4"/><line x1="18" y1="14" x2="18" y2="4"/><path d="M6 4l6 4 6-4"/></svg>`,
oddone:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="7" cy="7" r="3"/><circle cx="17" cy="7" r="3"/><circle cx="7" cy="17" r="3"/><circle cx="17" cy="17" r="3" stroke-dasharray="3 2"/></svg>`,
compare:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="7 4 2 12 7 20"/><polyline points="17 4 22 12 17 20"/></svg>`,
bulb:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M9 21h6"/><path d="M10 17h4"/><path d="M12 3a6 6 0 014 10.5V17H8v-3.5A6 6 0 0112 3z"/></svg>`,
colormix:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="9" r="5" opacity=".7"/><circle cx="15" cy="9" r="5" opacity=".7"/><circle cx="12" cy="14" r="5" opacity=".7"/></svg>`,
wordcomp:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="4" y1="7" x2="20" y2="7"/><line x1="4" y1="12" x2="16" y2="12"/><line x1="4" y1="17" x2="12" y2="17"/><rect x="14" y="14" width="6" height="6" rx="1" stroke-dasharray="3 2"/></svg>`,
timing:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="13" r="8"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="13" x2="15" y2="15"/><line x1="10" y1="2" x2="14" y2="2"/><line x1="12" y1="2" x2="12" y2="5"/></svg>`,
matchpair:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg>`,
headcount:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M3 21V7l9-4 9 4v14"/><rect x="9" y="13" width="6" height="8"/><line x1="12" y1="7" x2="12" y2="7.01" stroke-width="3"/></svg>`,
pyramid:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 3 22 21 2 21"/><line x1="7" y1="21" x2="12" y2="12"/><line x1="17" y1="21" x2="12" y2="12"/></svg>`,
maxnum:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M8 16V8l4 4 4-4v8"/></svg>`,
signfind:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="5" y1="12" x2="19" y2="12"/><line x1="12" y1="5" x2="12" y2="19"/><circle cx="12" cy="12" r="10" stroke-width="2"/></svg>`,
coincount:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="8"/><circle cx="12" cy="12" r="4"/><text x="12" y="14" text-anchor="middle" font-size="6" font-weight="bold" fill="currentColor" stroke="none">₩</text></svg>`,
clock:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="6" x2="12" y2="12"/><line x1="12" y1="12" x2="16" y2="16"/></svg>`,
wordmem:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M4 4.5A2.5 2.5 0 016.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15z"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="8" y1="10" x2="14" y2="10"/></svg>`,
blockcount:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"><path d="M12 2l8 4.5v11L12 22l-8-4.5v-11L12 2z"/><path d="M12 22V11"/><path d="M20 6.5L12 11 4 6.5"/><path d="M12 2v4.5"/></svg>`,
flanker:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/><polyline points="20 18 14 12 20 6"/><polyline points="10 18 4 12 10 6"/></svg>`,
memgrid:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1" fill="currentColor" opacity=".3"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1" fill="currentColor" opacity=".3"/></svg>`,
nback:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="3" y="5" width="8" height="14" rx="2"/><rect x="13" y="5" width="8" height="14" rx="2"/><path d="M7 15V9" stroke-width="2.5"/><path d="M17 15V9" stroke-width="2.5"/><line x1="7" y1="12" x2="17" y2="12" stroke-dasharray="2 2"/></svg>`,
scramble:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="2" y="8" width="6" height="8" rx="1"/><rect x="9" y="8" width="6" height="8" rx="1"/><rect x="16" y="8" width="6" height="8" rx="1"/><path d="M5 5l3 3M19 5l-3 3" stroke-dasharray="2 1"/></svg>`,
serial:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="4" y1="8" x2="12" y2="8"/><line x1="4" y1="12" x2="10" y2="12"/><line x1="4" y1="16" x2="8" y2="16"/><polyline points="17 7 17 17"/><polyline points="14 14 17 17 20 14"/></svg>`,
leftright:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M18 11V6a2 2 0 00-4 0v5"/><path d="M14 11V4a2 2 0 00-4 0v7"/><path d="M10 10V6a2 2 0 00-4 0v8c0 4.4 3.6 8 8 8h1a5 5 0 005-5v-4a2 2 0 00-4 0"/></svg>`,
calccomp:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="2" y="4" width="9" height="16" rx="2"/><line x1="4" y1="10" x2="9" y2="10"/><line x1="6.5" y1="7.5" x2="6.5" y2="12.5"/><rect x="13" y="4" width="9" height="16" rx="2"/><line x1="15" y1="10" x2="20" y2="10"/><polyline points="9 18 12 21 15 18" stroke-width="1.5"/></svg>`,
flash:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>`,
sort:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="3" y="3" width="8" height="8" rx="2"/><rect x="13" y="3" width="8" height="8" rx="2"/><path d="M12 16v4m-3-2h6"/><polyline points="7 20 7 16"/><polyline points="17 20 17 16"/></svg>`,
mirror:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="12" y1="2" x2="12" y2="22" stroke-dasharray="3 2"/><text x="6" y="15" font-size="12" font-weight="bold" fill="currentColor" stroke="none" transform="scale(-1,1) translate(-12,0)">R</text><text x="16" y="15" font-size="12" font-weight="bold" fill="currentColor" stroke="none">R</text></svg>`,
};
const GAMES=[
  {id:'math',name:'암산 챌린지',cat:'연산',desc:'빠른 사칙연산',color:'#3182F6',unlockXp:0},
  {id:'memory',name:'기억력 카드',cat:'기억력',desc:'같은 카드 쌍 찾기',color:'#8B5CF6',unlockXp:0},
  {id:'reaction',name:'반응속도',cat:'반응',desc:'빨리 터치!',color:'#10B981',unlockXp:0},
  {id:'stroop',name:'색깔 맞추기',cat:'유연성',desc:'스트룹 테스트',color:'#F59E0B',unlockXp:0},
  {id:'sequence',name:'순서 기억',cat:'기억력',desc:'순서 따라하기',color:'#EC4899',unlockXp:0},
  {id:'word',name:'단어 찾기',cat:'언어',desc:'숨은 단어 찾기',color:'#6366F1',unlockXp:0},
  {id:'pattern',name:'패턴 완성',cat:'논리',desc:'규칙을 찾으세요',color:'#EF4444',unlockXp:0},
  {id:'focus',name:'집중력 탭',cat:'반응',desc:'타겟만 빠르게',color:'#14B8A6',unlockXp:0},
  {id:'rotate',name:'도형 회전',cat:'공간',desc:'같은 도형 찾기',color:'#8B5CF6',unlockXp:0},
  {id:'reverse',name:'순서 뒤집기',cat:'유연성',desc:'거꾸로 기억하기',color:'#F97316',unlockXp:0},
  {id:'numtouch',name:'넘버 터치',cat:'반응',desc:'1~25 순서대로 터치',color:'#0EA5E9',unlockXp:0},
  {id:'rhythm',name:'리듬 기억',cat:'기억력',desc:'박자 패턴 따라하기',color:'#D946EF',unlockXp:0},
  {id:'rps',name:'두뇌 가위바위보',cat:'유연성',desc:'조건에 맞게 선택',color:'#F43F5E',unlockXp:0},
  {id:'oddone',name:'다른 글자 찾기',cat:'반응',desc:'다른 글자 하나를 찾으세요',color:'#06B6D4',unlockXp:0},
  {id:'compare',name:'크다작다',cat:'연산',desc:'빠른 수 비교 판단',color:'#84CC16',unlockXp:0},
  {id:'bulb',name:'전구 기억',cat:'기억력',desc:'켜지는 순서 기억',color:'#FBBF24',unlockXp:0},
  {id:'colormix',name:'색깔 조합',cat:'논리',desc:'색 혼합 결과 맞추기',color:'#A855F7',unlockXp:0},
  {id:'wordcomp',name:'단어 완성',cat:'언어',desc:'빈칸 글자 맞추기',color:'#22D3EE',unlockXp:0},
  {id:'timing',name:'타이밍',cat:'반응',desc:'정확한 타이밍에 멈추기',color:'#FB923C',unlockXp:0},
  {id:'matchpair',name:'짝 맞추기',cat:'언어',desc:'한자어와 뜻 연결',color:'#4ADE80',unlockXp:0},
  {id:'headcount',name:'인원 세기',cat:'집중',desc:'몇 명이 남았을까?',color:'#F87171',unlockXp:0},
  {id:'pyramid',name:'피라미드 연산',cat:'연산',desc:'합으로 피라미드 완성',color:'#FB923C',unlockXp:0},
  {id:'maxnum',name:'수 찾기',cat:'집중',desc:'가장 큰/작은 수를 터치',color:'#38BDF8',unlockXp:0},
  {id:'signfind',name:'부호 찾기',cat:'연산',desc:'빠진 연산자 맞추기',color:'#A78BFA',unlockXp:0},
  {id:'coincount',name:'동전 세기',cat:'연산',desc:'동전 총액 빠르게 계산',color:'#FCD34D',unlockXp:0},
  {id:'clock',name:'시계 읽기',cat:'반응',desc:'아날로그 시계 읽기',color:'#2DD4BF',unlockXp:0},
  {id:'wordmem',name:'단어 암기',cat:'기억력',desc:'단어 외우고 기억하기',color:'#C084FC',unlockXp:0},
  {id:'blockcount',name:'블록 세기',cat:'공간',desc:'쌓인 블록 개수 세기',color:'#64748B',unlockXp:0},
  {id:'flanker',name:'방향 맞추기',cat:'반응',desc:'가운데 화살표 방향은?',color:'#6366F1',unlockXp:0},
  {id:'memgrid',name:'격자 기억',cat:'기억력',desc:'켜진 칸을 기억하세요',color:'#F472B6',unlockXp:0},
  {id:'nback',name:'같거나 다르거나',cat:'집중',desc:'이전과 같은지 순간 판단',color:'#34D399',unlockXp:0},
  {id:'scramble',name:'글자 섞기',cat:'언어',desc:'섞인 글자로 단어 만들기',color:'#FB7185',unlockXp:0},
  {id:'serial',name:'연속 빼기',cat:'연산',desc:'계속 빼 나가세요',color:'#818CF8',unlockXp:0},
  {id:'leftright',name:'좌우 판단',cat:'유연성',desc:'왼손? 오른손?',color:'#F9A8D4',unlockXp:0},
  {id:'calccomp',name:'계산 비교',cat:'연산',desc:'어느 식이 더 큰가',color:'#FBBF24',unlockXp:0},
  {id:'flash',name:'순간 포착',cat:'기억력',desc:'잠깐 보고 기억하기',color:'#F59E0B',unlockXp:0},
  {id:'sort',name:'카테고리 분류',cat:'반응',desc:'빠르게 분류하세요',color:'#2DD4BF',unlockXp:0},
  {id:'mirror',name:'거울 문자',cat:'공간',desc:'뒤집힌 글자 읽기',color:'#A78BFA',unlockXp:0},
];

// ===== RANK SYSTEM =====
const RANK_SVG=`<img src="https://static.toss.im/2d-emojis/svg/u2B50.svg" style="width:1em;height:1em;vertical-align:-2px">`;
const RANKS=[
  {name:'100세',minXp:0,color:'#CD7F32',label:'100',age:100},
  {name:'90세',minXp:500,color:'#C0C0C0',label:'90',age:90},
  {name:'80세',minXp:2000,color:'#9E9E9E',label:'80',age:80},
  {name:'70세',minXp:5000,color:'#FFD700',label:'70',age:70},
  {name:'60세',minXp:10000,color:'#FFA726',label:'60',age:60},
  {name:'50세',minXp:18000,color:'#66BB6A',label:'50',age:50},
  {name:'40세',minXp:30000,color:'#4DD0E1',label:'40',age:40},
  {name:'30세',minXp:50000,color:'#42A5F5',label:'30',age:30},
  {name:'20세',minXp:80000,color:'#E040FB',label:'20',age:20},
];

// ===== STATE =====
let curGame=null,curTimer=null,curScore=0,replayCount=0;
// 오전 9시(KST) 기준 날짜 키 반환
function getDayKey(){
  const now=new Date();
  const kst=new Date(now.getTime()+9*60*60*1000);
  if(kst.getUTCHours()<9) kst.setUTCDate(kst.getUTCDate()-1);
  return kst.toISOString().slice(0,10);
}
const LS={
  get:(k,d=0)=>{const v=localStorage.getItem('bf-'+k);return v!==null?(isNaN(+v)?v:+v):d},
  set:(k,v)=>localStorage.setItem('bf-'+k,String(v)),
  getJSON:(k,d)=>{try{return JSON.parse(localStorage.getItem('bf-'+k))||d}catch{return d}},
  setJSON:(k,v)=>localStorage.setItem('bf-'+k,JSON.stringify(v)),
};

function getXP(){return LS.get('xp',0)}
function addXP(n){const xp=getXP()+n;LS.set('xp',xp);if(AIT.checkPromoBrainAge50)AIT.checkPromoBrainAge50(xp);return xp}
function getRank(xp){let r=RANKS[0];for(const rank of RANKS)if(xp>=rank.minXp)r=rank;return r}
function getNextRank(xp){for(const r of RANKS)if(xp<r.minXp)return r;return null}

// ===== DAILY WORKOUT =====
const WK_SIZE=3;
let wkActive=false,wkGames=[],wkIdx=0,wkScores=[];

function getTodayWorkout(){
  const today=getDayKey();
  let wk=LS.getJSON('workout-'+today,null);
  if(!wk){
    // Pick 3 random unlocked games
    const xp=getXP();
    const unlocked=GAMES.filter(g=>xp>=g.unlockXp);
    const picked=[...unlocked].sort(()=>Math.random()-.5).slice(0,WK_SIZE);
    wk={games:picked.map(g=>g.id),done:[],scores:{},completed:false};
    LS.setJSON('workout-'+today,wk);
  }
  return wk;
}

function saveWorkout(wk){
  const today=getDayKey();
  LS.setJSON('workout-'+today,wk);
}

function renderWorkout(){
  const wk=getTodayWorkout();
  // Auto-complete if all games done but flag missing
  if(!wk.completed&&wk.done.length>=WK_SIZE){
    wk.completed=true;saveWorkout(wk);
    addCoins(30);addXP(50);addPoints(1);if(AIT.checkPromoFirstWorkout)AIT.checkPromoFirstWorkout();
  }
  const el=document.getElementById('dailyWorkout');
  const allDone=wk.completed;
  const doneCount=wk.done.length;
  const pct=allDone?100:Math.round(doneCount/WK_SIZE*100);
  const nextIdx=wk.games.findIndex(id=>!wk.done.includes(id));
  const nextGame=nextIdx>=0?GAMES.find(x=>x.id===wk.games[nextIdx]):null;

  el.innerHTML=allDone?`
    <div class="workout-card done">
      <div style="text-align:center;padding:8px 0">
        <div style="margin-bottom:12px"><img src="https://static.toss.im/2d-emojis/svg/u2705.svg" style="width:48px;height:48px"></div>
        <div style="font-size:18px;font-weight:800;margin-bottom:4px">오늘의 두뇌운동 완료!</div>
        <div style="font-size:13px;color:var(--sub)">내일도 잊지 말고 운동하러 오세요!</div>
      </div>
      <div class="wk-games" style="margin:14px 0 0">
        ${wk.games.map(id=>{const g=GAMES.find(x=>x.id===id);return`<div class="wk-game done"><div class="wk-check"><img src="https://static.toss.im/2d-emojis/svg/u2705.svg" style="width:14px;height:14px"></div><div class="wk-icon">${GI[g.id]||''}</div><div class="wk-name">${g.name}</div><div style="font-size:10px;color:var(--p);font-weight:700">${wk.scores[id]||0}점</div></div>`}).join('')}
      </div>
    </div>`:`
    <div class="workout-card">
      <div style="text-align:center;padding:4px 0 12px">
        <div style="font-size:13px;color:var(--sub);margin-bottom:4px">${doneCount===0?'오늘의 뇌를 깨워볼까요?':'좋아요! 계속 가볼까요?'}</div>
        <div style="font-size:20px;font-weight:800">오늘의 두뇌 운동</div>
      </div>
      <div class="wk-games">
        ${wk.games.map((id,i)=>{
          const g=GAMES.find(x=>x.id===id);
          const done=wk.done.includes(id);
          const current=i===nextIdx;
          return`<div class="wk-game${done?' done':''}${current?' current':''}">
            ${done?'<div class="wk-check"><img src="https://static.toss.im/2d-emojis/svg/u2705.svg" style="width:14px;height:14px"></div>':''}
            <div class="wk-icon">${GI[g.id]||''}</div>
            <div class="wk-name">${g.name}</div>
            ${done?`<div style="font-size:10px;color:var(--ok);font-weight:700">${wk.scores[id]||0}점</div>`:''}
          </div>`}).join('')}
      </div>
      <div class="wk-progress" style="margin:12px 0"><div class="wk-progress-fill" style="width:${pct}%"></div></div>
      <button class="wk-start" onclick="startWorkout()" style="margin-top:4px">
        ${doneCount===0?'지금 바로 시작하기':nextGame?'다음: '+nextGame.name:'운동 시작하기'}
      </button>
      <div class="wk-bonus">완료 보너스 <span class="tds-badge tds-badge-xs tds-badge-fill-yellow">+50 XP</span> <span class="tds-badge tds-badge-xs tds-badge-fill-blue">+1점</span></div>
    </div>`;
}

function startWorkout(){
  const wk=getTodayWorkout();
  wkActive=true;
  wkGames=wk.games.filter(id=>!wk.done.includes(id));
  wkIdx=0;wkScores=[];
  showWkTransition();
}

function showWkTransition(){
  if(wkIdx>=wkGames.length){finishWorkout();return}
  const g=GAMES.find(x=>x.id===wkGames[wkIdx]);
  const wk=getTodayWorkout();
  const totalDone=wk.done.length+wkIdx+1;
  document.getElementById('wkt-progress').textContent=totalDone+' / '+WK_SIZE;
  document.getElementById('wkt-icon').innerHTML=GI[g.id]||'';document.getElementById('wkt-icon').style.color=g.color;
  document.getElementById('wkt-name').textContent=g.name;
  const best=LS.get(g.id+'-best',0);
  const target=best>0?Math.ceil(best*0.9):10;
  document.getElementById('wkt-desc').textContent=`목표 ${target}점 · 최고 ${best}점`;
  document.getElementById('wkTransition').classList.add('active');
}

function wkStartNext(){
  document.getElementById('wkTransition').classList.remove('active');
  startGame(wkGames[wkIdx]);
}

function wkOnGameEnd(gameId,score){
  // Called from showResult when workout is active
  const wk=getTodayWorkout();
  if(!wk.done.includes(gameId))wk.done.push(gameId);
  wk.scores[gameId]=score;
  saveWorkout(wk);
  wkIdx++;
}

function wkContinue(){
  // Called when user clicks "다음 운동" or closes result during workout
  if(wkIdx<wkGames.length){
    // Ad between games
    showAd(()=>showWkTransition());
  }else{
    finishWorkout();
  }
}

function finishWorkout(){
  const wk=getTodayWorkout();
  if(!wk.completed&&wk.done.length>=WK_SIZE){
    wk.completed=true;saveWorkout(wk);
    addCoins(30);addXP(50);addPoints(1);if(AIT.checkPromoFirstWorkout)AIT.checkPromoFirstWorkout();
    addXP(50);toast('오늘의 운동 완료! +50 XP +1점');
  }
  wkActive=false;
  goHome();
}

// ===== HEART SYSTEM =====
const MAX_HEARTS=3;
let hearts=MAX_HEARTS;
let heartRefillUsed=false;
let heartGameId=null; // which game's hearts

function initHearts(gameId){
  hearts=MAX_HEARTS;heartRefillUsed=false;heartGameId=gameId;
  renderHearts(gameId);
}
function renderHearts(gameId){
  const el=document.getElementById(gameId+'-hearts');
  if(!el)return;
  el.innerHTML='';
  for(let i=0;i<MAX_HEARTS;i++){
    const h=document.createElement('span');
    h.className='heart'+(i>=hearts?' lost':'');
    h.innerHTML='<svg viewBox="0 0 24 24" fill="currentColor" style="width:16px;height:16px"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>';h.id=gameId+'-heart-'+i;
    el.appendChild(h);
  }
}
function loseHeart(gameId){
  hearts--;
  const el=document.getElementById(gameId+'-heart-'+hearts);
  if(el){el.classList.add('heart-break');setTimeout(()=>el.classList.add('lost'),500)}
  // Shake remaining hearts
  const container=document.getElementById(gameId+'-hearts');
  if(container){container.classList.add('heart-shake');setTimeout(()=>container.classList.remove('heart-shake'),400)}
  if(navigator.vibrate)navigator.vibrate([50,30,50]);
  if(hearts<=0){
    // Pause all timers
    clearInterval(curTimer);
    [typeof cmpQTimer!='undefined'&&cmpQTimer,typeof scQTimer!='undefined'&&scQTimer,typeof clkQTimer!='undefined'&&clkQTimer,typeof sfQTimer!='undefined'&&sfQTimer,typeof oddQTimer!='undefined'&&oddQTimer,typeof mxQTimer!='undefined'&&mxQTimer,typeof cmxQTimer!='undefined'&&cmxQTimer,typeof wcQTimer!='undefined'&&wcQTimer,typeof lrQTimer!='undefined'&&lrQTimer,typeof cc2QTimer!='undefined'&&cc2QTimer].forEach(t=>t&&clearInterval(t));
    setTimeout(()=>{
      if(heartRefillUsed){
        // 이미 1회 사용 → 바로 결과
        const gameName=GAMES.find(g=>g.id===curGame)?.name||'';
        showResult(curScore,gameName);
        return;
      }
      document.getElementById('heartOverlay').classList.add('active');
    },600);
    return true; // game should stop
  }
  return false;
}
function refillHearts(){
  showAd(()=>{
    heartRefillUsed=true;
    hearts=1;
    document.getElementById('heartOverlay').classList.remove('active');
    renderHearts(heartGameId);
    toast('마지막 기회!');
    resumeAfterHeart();
  });
}
function heartQuit(){
  document.getElementById('heartOverlay').classList.remove('active');
  const gameName=GAMES.find(g=>g.id===curGame)?.name||'';
  showResult(curScore,gameName);
}
// ===== TIME EXTEND (타이머 게임 +5초) =====
let timeExtendUsed=false;
let _timeExtendCallback=null;
function showTimeExtend(callback){
  if(timeExtendUsed){callback();return}
  _timeExtendCallback=callback;
  document.getElementById('timeExtendOverlay').classList.add('active');
}
function timeExtendQuit(){
  document.getElementById('timeExtendOverlay').classList.remove('active');
  if(_timeExtendCallback)_timeExtendCallback();
}
function timeExtendAccept(){
  document.getElementById('timeExtendOverlay').classList.remove('active');
  showAd(()=>{
    timeExtendUsed=true;
    toast('+5초!');
    // 현재 게임의 시간 변수에 5초 추가하고 타이머 재개
    resumeWithExtraTime(5);
  });
}
function resumeWithExtraTime(sec){
  const g=curGame;
  if(g==='math'){mathTime+=sec;mathUpdateT();curTimer=setInterval(()=>{mathTime--;mathUpdateT();if(mathTime<=0){clearInterval(curTimer);showResult(mathScore,'암산 챌린지',[{val:mathTotal,label:'문제 수'},{val:mathMaxCombo+'x',label:'최대 콤보'}],{combo:mathMaxCombo})}},1000)}
  else if(g==='stroop'){stroopTime+=sec;document.getElementById('stroop-timer').textContent=stroopTime+'s';curTimer=setInterval(()=>{stroopTime--;document.getElementById('stroop-timer').textContent=stroopTime+'s';if(stroopTime<=10)document.getElementById('stroop-timer').className='g-timer urgent';if(stroopTime<=0){clearInterval(curTimer);showResult(stroopScore,'색깔 맞추기',[{val:stroopTotal,label:'문제 수'}])}},1000)}
  else if(g==='focus'){focusTime+=sec;document.getElementById('focus-timer').textContent=focusTime+'s';curTimer=setInterval(()=>{focusTime--;document.getElementById('focus-timer').textContent=focusTime+'s';if(focusTime<=10)document.getElementById('focus-timer').className='g-timer urgent';if(focusTime<=0){clearInterval(curTimer);showResult(focusScore,'집중력',[{val:focusHit,label:'정확'},{val:focusMiss,label:'놓침'}])}},1000)}
  else if(g==='rps'){rpsTime+=sec;document.getElementById('rps-timer').textContent=rpsTime+'s';curTimer=setInterval(()=>{rpsTime--;document.getElementById('rps-timer').textContent=rpsTime+'s';if(rpsTime<=10)document.getElementById('rps-timer').className='g-timer urgent';if(rpsTime<=0){clearInterval(curTimer);showResult(rpsScore,'가위바위보',[{val:rpsWins,label:'승'}])}},1000)}
  else if(g==='compare'){cmpTime+=sec;document.getElementById('cmp-timer').textContent=cmpTime+'s';curTimer=setInterval(()=>{cmpTime--;document.getElementById('cmp-timer').textContent=cmpTime+'s';if(cmpTime<=10)document.getElementById('cmp-timer').className='g-timer urgent';if(cmpTime<=0){clearInterval(curTimer);showResult(cmpScore,'크다작다',[])}},1000)}
  else if(g==='leftright'){lrTime+=sec;document.getElementById('lr-timer').textContent=lrTime+'s';curTimer=setInterval(()=>{lrTime--;document.getElementById('lr-timer').textContent=lrTime+'s';if(lrTime<=10)document.getElementById('lr-timer').className='g-timer urgent';if(lrTime<=0){clearInterval(curTimer);showResult(lrScore,'좌우 판단',[])}},1000)}
  else if(g==='scramble'){scTime+=sec;document.getElementById('sc-timer').textContent=scTime+'s';curTimer=setInterval(()=>{scTime--;document.getElementById('sc-timer').textContent=scTime+'s';if(scTime<=10)document.getElementById('sc-timer').className='g-timer urgent';if(scTime<=0){clearInterval(curTimer);clearInterval(scQTimer);showResult(scScore,'글자 섞기',[])}},1000);scGen()}
}

function resumeAfterHeart(){
  // 현재 게임의 init를 다시 호출하지 않고, 타이머만 재개 + 다음 문제 생성
  const g=curGame;
  const timerMap={
    math:()=>{curTimer=setInterval(()=>{mathTime--;mathUpdateT();if(mathTime<=0){clearInterval(curTimer);showResult(mathScore,'암산 챌린지',[{val:mathTotal,label:'문제 수'},{val:mathMaxCombo+'x',label:'최대 콤보'}],{combo:mathMaxCombo})}},1000);mathGen()},
    stroop:()=>{curTimer=setInterval(()=>{stroopTime--;document.getElementById('stroop-timer').textContent=stroopTime+'s';if(stroopTime<=10)document.getElementById('stroop-timer').className='g-timer urgent';if(stroopTime<=0){clearInterval(curTimer);showResult(stroopScore,'색깔 맞추기',[{val:stroopTotal,label:'문제 수'}])}},1000);stroopGen()},
    pattern:()=>{curTimer=setInterval(()=>{patTime--;document.getElementById('pat-timer').textContent=patTime+'s';if(patTime<=10)document.getElementById('pat-timer').className='g-timer urgent';if(patTime<=0){clearInterval(curTimer);showResult(patScore,'패턴',[])}},1000);patGen()},
    focus:()=>{curTimer=setInterval(()=>{focusTime--;document.getElementById('focus-timer').textContent=focusTime+'s';if(focusTime<=10)document.getElementById('focus-timer').className='g-timer urgent';if(focusTime<=0){clearInterval(curTimer);showResult(focusScore,'집중력',[{val:focusHit,label:'정확'},{val:focusMiss,label:'놓침'}])}},1000)},
    rotate:()=>{curTimer=setInterval(()=>{rotTime--;document.getElementById('rot-timer').textContent=rotTime+'s';if(rotTime<=10)document.getElementById('rot-timer').className='g-timer urgent';if(rotTime<=0){clearInterval(curTimer);showResult(rotScore,'회전',[])}},1000);rotGen()},
    rps:()=>{curTimer=setInterval(()=>{rpsTime--;document.getElementById('rps-timer').textContent=rpsTime+'s';if(rpsTime<=10)document.getElementById('rps-timer').className='g-timer urgent';if(rpsTime<=0){clearInterval(curTimer);showResult(rpsScore,'가위바위보',[{val:rpsWins,label:'승'}])}},1000);rpsGen()},
    compare:()=>{curTimer=setInterval(()=>{cmpTime--;document.getElementById('cmp-timer').textContent=cmpTime+'s';if(cmpTime<=10)document.getElementById('cmp-timer').className='g-timer urgent';if(cmpTime<=0){clearInterval(curTimer);clearInterval(cmpQTimer);showResult(cmpScore,'크다작다',[])}},1000);cmpGen()},
    colormix:()=>{curTimer=setInterval(()=>{cmxTime--;document.getElementById('cmx-timer').textContent=cmxTime+'s';if(cmxTime<=10)document.getElementById('cmx-timer').className='g-timer urgent';if(cmxTime<=0){clearInterval(curTimer);showResult(cmxScore,'색 조합',[])}},1000);cmxGen()},
    wordcomp:()=>{curTimer=setInterval(()=>{wcTime--;document.getElementById('wc-timer').textContent=wcTime+'s';if(wcTime<=10)document.getElementById('wc-timer').className='g-timer urgent';if(wcTime<=0){clearInterval(curTimer);showResult(wcScore,'단어 비교',[])}},1000);wcGen()},
    leftright:()=>{curTimer=setInterval(()=>{lrTime--;document.getElementById('lr-timer').textContent=lrTime+'s';if(lrTime<=10)document.getElementById('lr-timer').className='g-timer urgent';if(lrTime<=0){clearInterval(curTimer);showResult(lrScore,'좌우 판단',[])}},1000);lrGen()},
    oddone:()=>{curTimer=setInterval(()=>{oddTime--;document.getElementById('odd-timer').textContent=oddTime+'s';if(oddTime<=10)document.getElementById('odd-timer').className='g-timer urgent';if(oddTime<=0){clearInterval(curTimer);showResult(oddScore,'다른 하나',[])}},1000);oddGen()},
    signfind:()=>{curTimer=setInterval(()=>{sfTime--;document.getElementById('sf-timer').textContent=sfTime+'s';if(sfTime<=10)document.getElementById('sf-timer').className='g-timer urgent';if(sfTime<=0){clearInterval(curTimer);showResult(sfScore,'부호 찾기',[])}},1000);sfGen()},
    coincount:()=>{curTimer=setInterval(()=>{ccTime--;document.getElementById('cc-timer').textContent=ccTime+'s';if(ccTime<=10)document.getElementById('cc-timer').className='g-timer urgent';if(ccTime<=0){clearInterval(curTimer);showResult(ccScore,'동전 세기',[])}},1000);ccGen()},
    headcount:()=>{curTimer=setInterval(()=>{hcTime--;document.getElementById('hc-timer').textContent=hcTime+'s';if(hcTime<=10)document.getElementById('hc-timer').className='g-timer urgent';if(hcTime<=0){clearInterval(curTimer);showResult(hcScore,'인원 세기',[])}},1000);hcNext()},
    pyramid:()=>{curTimer=setInterval(()=>{pyrTime--;document.getElementById('pyr-timer').textContent=pyrTime+'s';if(pyrTime<=10)document.getElementById('pyr-timer').className='g-timer urgent';if(pyrTime<=0){clearInterval(curTimer);showResult(pyrScore,'피라미드',[])}},1000);pyrGen()},
    blockcount:()=>{curTimer=setInterval(()=>{bcTime--;document.getElementById('bc-timer').textContent=bcTime+'s';if(bcTime<=10)document.getElementById('bc-timer').className='g-timer urgent';if(bcTime<=0){clearInterval(curTimer);showResult(bcScore,'블록 세기',[])}},1000);bcGen()},
    flanker:()=>{curTimer=setInterval(()=>{flTime--;document.getElementById('fl-timer').textContent=flTime+'s';if(flTime<=10)document.getElementById('fl-timer').className='g-timer urgent';if(flTime<=0){clearInterval(curTimer);showResult(flScore,'플랭커',[])}},1000);flGen()},
    nback:()=>{curTimer=setInterval(()=>{nbTime--;document.getElementById('nb-timer').textContent=nbTime+'s';if(nbTime<=10)document.getElementById('nb-timer').className='g-timer urgent';if(nbTime<=0){clearInterval(curTimer);showResult(nbScore,'같거나 다르거나',[])}},1000)},
    sort:()=>{curTimer=setInterval(()=>{sortTime--;document.getElementById('sort-timer').textContent=sortTime+'s';if(sortTime<=10)document.getElementById('sort-timer').className='g-timer urgent';if(sortTime<=0){clearInterval(curTimer);showResult(sortScore,'정렬',[])}},1000);sortGen()},
    calccomp:()=>{curTimer=setInterval(()=>{cc2Time--;document.getElementById('cc2-timer').textContent=cc2Time+'s';if(cc2Time<=10)document.getElementById('cc2-timer').className='g-timer urgent';if(cc2Time<=0){clearInterval(curTimer);showResult(cc2Score,'계산 비교',[])}},1000);cc2Gen()},
    serial:()=>{curTimer=setInterval(()=>{serTime--;document.getElementById('ser-timer').textContent=serTime+'s';if(serTime<=10)document.getElementById('ser-timer').className='g-timer urgent';if(serTime<=0){clearInterval(curTimer);showResult(serScore,'연속 계산',[])}},1000)},
    matchpair:()=>{curTimer=setInterval(()=>{mpTime--;document.getElementById('mp-timer').textContent=mpTime+'s';if(mpTime<=10)document.getElementById('mp-timer').className='g-timer urgent';if(mpTime<=0){clearInterval(curTimer);showResult(mpScore,'매치 페어',[])}},1000)},
    mirror:()=>{curTimer=setInterval(()=>{mirTime--;document.getElementById('mir-timer').textContent=mirTime+'s';if(mirTime<=10)document.getElementById('mir-timer').className='g-timer urgent';if(mirTime<=0){clearInterval(curTimer);showResult(mirScore,'거울',[])}},1000);mirGen()},
    maxnum:()=>{curTimer=setInterval(()=>{mnTime--;document.getElementById('mn-timer').textContent=mnTime+'s';if(mnTime<=10)document.getElementById('mn-timer').className='g-timer urgent';if(mnTime<=0){clearInterval(curTimer);showResult(mnScore,'최대값',[])}},1000);mnGen()},
    clock:()=>{curTimer=setInterval(()=>{clkTime--;document.getElementById('clk-round').textContent=clkTime+'s';if(clkTime<=10)document.getElementById('clk-round').className='g-timer urgent';if(clkTime<=0){clearInterval(curTimer);clearInterval(clkQTimer);showResult(clkScore,'시계 읽기',[])}},1000);clkNext()},
    scramble:()=>{curTimer=setInterval(()=>{scTime--;document.getElementById('sc-timer').textContent=scTime+'s';if(scTime<=10)document.getElementById('sc-timer').className='g-timer urgent';if(scTime<=0){clearInterval(curTimer);clearInterval(scQTimer);showResult(scScore,'글자 섞기',[])}},1000);scGen()},
  };
  if(timerMap[g])timerMap[g]();
}

// ===== COIN SYSTEM =====
const MILESTONES=[
  {id:'first',name:'첫 걸음',desc:'첫 번째 게임 완료',coins:10,icon:'●',bg:'#3182F6',check:()=>LS.get('totalPlays',0)>=1},
  {id:'record3',name:'기록 파괴자',desc:'3가지 게임에서 신기록',coins:30,icon:'★',bg:'#FFD700',check:()=>{let c=0;GAMES.forEach(g=>{if(LS.get(g.id+'-best',0)>0)c++});return c>=3}},
  {id:'coin100',name:'코인 수집가',desc:'100 코인 달성',coins:20,icon:'+',bg:'#FFA000',check:()=>getCoins()>=100},
  {id:'streak7',name:'일주일 연속',desc:'7일 연속 출석',coins:50,icon:'◆',bg:'#FF8A00',check:()=>getStreak().streak>=7},
  {id:'master1',name:'장인의 길',desc:'아무 게임 40점 이상',coins:40,icon:'◆',bg:'#E040FB',check:()=>GAMES.some(g=>LS.get(g.id+'-best',0)>=40)},
  {id:'allplay',name:'올라운더',desc:'10개 게임 모두 플레이',coins:80,icon:'★',bg:'#10B981',check:()=>{let c=0;GAMES.forEach(g=>{if(LS.get(g.id+'-best',0)>0)c++});return c>=10}},
  {id:'coin500',name:'부자 두뇌',desc:'500 코인 달성',coins:100,icon:'◇',bg:'#00BCD4',check:()=>getCoins()>=500},
];

function getCoins(){return LS.get('coins',0)}
function addCoins(n){const c=getCoins()+n;LS.set('coins',c);return c}

// ===== POINT SYSTEM (토스포인트 교환용) =====
function getPoints(){return LS.get('points',0)}
function addPoints(n){
  const p=getPoints()+n;LS.set('points',p);
  toast('+'+n+'점 적립!');
  return p;
}
let _lastRenderedPoints=null;
function renderPoints(animate=false){
  const p=getPoints();
  const el=document.getElementById('pointDisplay');
  if(el) el.textContent=p+'점';
  const el2=document.getElementById('pointExchangeVal');
  if(el2) el2.textContent=p+'점';
  const prog=document.getElementById('pointProgress');
  const bar=document.getElementById('pointBar');
  const btn=document.getElementById('exchangeBtn');

  if(animate&&_lastRenderedPoints!==null&&p>_lastRenderedPoints){
    animatePointsFrom(_lastRenderedPoints);
  } else {
    if(prog) prog.textContent=p+' / 100점';
    if(bar) bar.style.width=Math.min(100,p)+'%';
  }
  _lastRenderedPoints=p;
  if(btn) btn.disabled=p<100;
}
let _exchangeLock=false;
async function exchangePoints(){
  const p=getPoints();
  if(p<100){toast('100점 이상부터 교환 가능합니다');return}
  if(!AIT.isToss){toast('토스 앱에서만 교환 가능합니다');return}
  // 동시 클릭 방지
  if(_exchangeLock){return}
  _exchangeLock=true;
  const btn=document.getElementById('exchangeBtn');
  if(btn){btn.disabled=true;btn.textContent='교환 중...'}
  try {
    // 1단계: 서버에 교환 요청 (포인트 차감 기록)
    const uh=await AIT.getUserHash();
    const serverRes=await fetch('/api/score/promo/exchange',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({userHash:uh,points:p})
    }).then(r=>r.json());
    if(serverRes.error){throw new Error(serverRes.error)}
    // 2단계: SDK로 토스포인트 지급
    await AIT.triggerPromo('POINT_100',AIT.CONFIG.PROMO_POINT_100,100);
    // 3단계: 성공 → 로컬 포인트 초기화
    LS.set('points',0);renderPoints();
    toast('100원 교환 완료!');
    AIT.log('point_exchange',{amount:p,userHash:uh});
  } catch(e) {
    console.error('Exchange failed:',e);
    toast('교환에 실패했습니다. 다시 시도해주세요.');
  } finally {
    _exchangeLock=false;
    if(btn){btn.disabled=getPoints()<100;btn.textContent='100원 받기'}
  }
}

// Calculate coins earned from a game result
function calcCoins(score,isNewRecord){
  let coins=0;
  // Base: 1 coin per 5 points
  coins+=Math.floor(score/5);
  // New record bonus
  if(isNewRecord&&score>0)coins+=10;
  // Score milestones
  if(score>=40)coins+=5;
  if(score>=25)coins+=3;
  return Math.max(coins,1); // minimum 1 coin
}

let pendingCoins=0; // for double coins ad
function checkMilestones(){
  const claimed=LS.getJSON('claimedMilestones',[]);
  let newClaimed=[];
  MILESTONES.forEach(m=>{
    if(!claimed.includes(m.id)&&m.check()){
      claimed.push(m.id);
      addCoins(m.coins);
      newClaimed.push(m);
    }
  });
  LS.setJSON('claimedMilestones',claimed);
  return newClaimed;
}

function renderMilestones(){
  const claimed=LS.getJSON('claimedMilestones',[]);
  const coins=getCoins();
  document.getElementById('coinBadge').textContent=''+coins.toLocaleString();
  document.getElementById('coinTotal').textContent=coins.toLocaleString()+' 코인';
  document.getElementById('coinMilestones').innerHTML=MILESTONES.map(m=>{
    const done=claimed.includes(m.id);
    const progress=m.check();
    return `<div class="cm-item">
      <div class="cm-icon" style="background:${m.bg}18">${m.icon}</div>
      <div class="cm-info">
        <div class="cm-name">${m.name}</div>
        <div class="cm-desc">${m.desc}</div>
      </div>
      <div class="cm-status ${done?'done':'locked'}">${done?'✓ +'+m.coins:''+m.coins}</div>
    </div>`}).join('');
}

function floatCoin(x,y){
  const el=document.createElement('div');el.className='coin-float';el.textContent='+';
  el.style.left=x+'px';el.style.top=y+'px';
  document.body.appendChild(el);setTimeout(()=>el.remove(),1000);
}

// brain age = rank age (removed separate calc)

function doubleCoins(){
  if(!pendingCoins)return;
  showAd(()=>{
    addCoins(pendingCoins); // add same amount again = 2x
    document.getElementById('r-coin-new').textContent='+'+pendingCoins*2+' (2배!)';
    toast('코인 2배! +'+pendingCoins*2);
    // Float coins animation
    for(let i=0;i<5;i++){setTimeout(()=>floatCoin(window.innerWidth/2-12+Math.random()*40-20,window.innerHeight/2),i*100)}
    pendingCoins=0;
  });
}

// ===== TOAST =====
let toastT;
function toast(msg){const el=document.getElementById('toast');el.textContent=msg;el.classList.add('show');clearTimeout(toastT);toastT=setTimeout(()=>el.classList.remove('show'),2000)}
let snackT;function snackbar(html,dur=2500){const el=document.getElementById('snackbar');document.getElementById('snackbar-inner').innerHTML=html;el.classList.add('show');clearTimeout(snackT);snackT=setTimeout(()=>el.classList.remove('show'),dur)}

// ===== STREAK =====
function getStreak(){
  const hist=LS.getJSON('playDates',[]);
  const today=getDayKey();
  if(!hist.length)return{streak:0,playedToday:false};
  let streak=0;
  const now=new Date();const kst=new Date(now.getTime()+9*60*60*1000);
  if(kst.getUTCHours()<9)kst.setUTCDate(kst.getUTCDate()-1);
  for(let i=0;i<30;i++){
    const ds=kst.toISOString().slice(0,10);
    if(hist.includes(ds)){streak++;kst.setUTCDate(kst.getUTCDate()-1)}else break;
  }
  return{streak,playedToday:hist.includes(today)};
}
function recordPlay(){
  const today=getDayKey();
  const hist=LS.getJSON('playDates',[]);
  if(!hist.includes(today)){hist.push(today);LS.setJSON('playDates',hist)}
}

// ===== DAILY MISSIONS =====
function getTodayMissions(){
  const today=getDayKey();
  let missions=LS.getJSON('missions-'+today,null);
  // Force regen if stale targets (all 10)
  if(missions&&(missions.length!==5||missions.every(m=>m.target<=10)||!missions[0].gameId||missions[0].type)){missions=null;localStorage.removeItem('bf-missions-'+today)}
  if(!missions){
    // Generate game-specific challenges based on best scores
    const gameMissions=GAMES.map(g=>{
      const best=LS.get(g.id+'-best',0);
      const defaults={math:80,memory:60,reaction:200,stroop:80,sequence:50,word:60,pattern:60,focus:80,rotate:60,reverse:50,numtouch:200,rhythm:40,rps:80,oddone:80,compare:80,bulb:50,colormix:60,wordcomp:60,timing:60,matchpair:100,headcount:60,pyramid:60,maxnum:80,signfind:80,coincount:60,clock:60,wordmem:60,blockcount:60,flanker:80,memgrid:50,nback:80,scramble:60,serial:80,leftright:80,calccomp:60,flash:40,sort:60,mirror:50};
      const target=best>0?Math.round(best*1.05):(defaults[g.id]||50);
      return {id:'goal-'+g.id,gameId:g.id,name:g.name,desc:`${target}점 이상 달성`,target,best,xp:20,icon:'●',bg:g.color,progress:0,done:false};
    });
    // 5 game-specific score missions
    const shuffled=[...gameMissions].sort(()=>Math.random()-.5);
    missions=shuffled.slice(0,5);
    LS.setJSON('missions-'+today,missions);
  }
  return missions;
}
function updateMission(gameId,score,extra={}){
  const today=getDayKey();
  const missions=LS.getJSON('missions-'+today,[]);
  let completed=[];
  missions.forEach(m=>{
    if(m.done)return;
    if(m.gameId===gameId&&score>=m.target){m.progress=score;m.done=true;completed.push(m);addPoints(1)}
  });
  LS.setJSON('missions-'+today,missions);
  // 5개 모두 완료 시 보너스
  const allDone=missions.every(m=>m.done);
  const bonusKey='mission-bonus-'+today;
  if(allDone&&!LS.get(bonusKey)){LS.set(bonusKey,1);addPoints(2);toast('챌린지 올클리어 보너스 +2점!')}
  return completed;
}

// ===== DAILY SCORE HISTORY =====
function recordDailyScore(score){
  const today=getDayKey();
  const hist=LS.getJSON('scoreHist',{});
  hist[today]=Math.max(hist[today]||0,score);
  LS.setJSON('scoreHist',hist);
}

// ===== HOME RENDERING =====
function show(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id)?.classList.add('active')}

function renderHome(){
  const xp=getXP();const rank=getRank(xp);const next=getNextRank(xp);
  const{streak,playedToday}=getStreak();

  // Streak badge
  document.getElementById('streakLabel').textContent=(streak||0)>0?(streak+'일 연속 출석중'):'오늘 첫 출석을 해보세요!';

  // Rank card
  document.getElementById('rankName').textContent=rank.name;
  document.getElementById('rankName').style.color=rank.color;
  document.getElementById('rankNext').textContent=next?`다음 목표: ${next.name}`:'최고로 젊은 두뇌!';
  document.getElementById('xpCur').textContent=xp+' XP';
  document.getElementById('xpMax').textContent=(next?.minXp||xp)+' XP';
  const progress=next?((xp-rank.minXp)/(next.minXp-rank.minXp)*100):100;
  document.getElementById('xpFill').style.width=progress+'%';

  // Overall percentile (average of all game percentiles)
  function estimatedPercentile(gid,s){
    const E={math:[180,80],memory:[100,40],reaction:[350,120],stroop:[160,70],sequence:[100,50],word:[80,35],pattern:[120,55],focus:[180,70],rotate:[90,40],reverse:[80,40],numtouch:[100,50],rhythm:[100,55],rps:[140,55],oddone:[200,80],compare:[160,60],bulb:[100,55],colormix:[90,40],wordcomp:[110,45],timing:[90,45],matchpair:[180,70],headcount:[90,40],pyramid:[70,35],maxnum:[160,65],signfind:[110,45],coincount:[90,40],clock:[70,35],wordmem:[90,45],blockcount:[90,40],flanker:[140,55],memgrid:[80,40],nback:[100,45],scramble:[90,40],serial:[120,50],leftright:[140,55],calccomp:[110,45],flash:[90,45],sort:[140,55],mirror:[90,40]};
    const[m,sd]=E[gid]||[50,20];const z=(s-m)/sd;
    const t=1/(1+.2316419*Math.abs(z)),d=.3989422804,p=d*t*(-.3193815+t*(-.3565638+t*(1.781478+t*(-1.821256+t*1.3302744))));
    return Math.max(1,Math.min(99,Math.round((z>0?1-p:p)*100)));
  }
  let total=0,count=0;
  const catScores={};
  let pctSum=0,pctCount=0;
  GAMES.forEach(g=>{const b=LS.get(g.id+'-best',0);if(b>0){total+=b;count++;catScores[g.cat]=(catScores[g.cat]||0)+b;pctSum+=estimatedPercentile(g.id,b);pctCount++}});
  const avg=count>0?Math.round(total/count):0;
  const overallPct=pctCount>0?Math.round(pctSum/pctCount):0;
  document.getElementById('overallPct').textContent=overallPct>0?('상위 '+(101-overallPct)+'%'):'--';
  recordDailyScore(avg);

  // Missions
  const missions=getTodayMissions();
  const doneCount=missions.filter(m=>m.done).length;
  document.getElementById('missionCount').textContent=doneCount+'/'+missions.length;
  document.getElementById('missionList').innerHTML=missions.map(m=>{
    const pct=Math.min(100,m.target>0?(m.progress/m.target*100):0);
    const best=LS.get(m.gameId+'-best',0);
    return `<div class="mission-card" onclick="startGame('${m.gameId}')" style="cursor:pointer">
      <div class="mission-icon" style="background:rgba(49,130,246,.08);color:var(--p)">${GI[m.gameId]?`<div style="width:18px;height:18px">${GI[m.gameId]}</div>`:'●'}</div>
      <div class="mission-info">
        <div class="mission-name">${m.name} <span style="font-size:11px;color:var(--sub);font-weight:400">목표 ${m.target}점 · 최고 ${best}점</span></div>
        <div class="mission-desc">${m.desc}</div>
        ${m.done?'':`<div class="mission-prog"><div class="mission-prog-fill" style="width:${pct}%;background:var(--p)"></div></div>`}
      </div>
      ${m.done?'<div class="mission-check"><img src="https://static.toss.im/2d-emojis/svg/u2705.svg" style="width:20px;height:20px"></div>':`<div class="mission-reward" style="text-align:right;display:flex;flex-direction:column;gap:4px;align-items:flex-end"><span class="tds-badge tds-badge-xs tds-badge-weak-yellow">+${m.xp}XP</span><span class="tds-badge tds-badge-xs tds-badge-weak-blue">+1점</span></div>`}
    </div>`}).join('');

  // Streak calendar (7 days)
  const playDates=LS.getJSON('playDates',[]);
  const streakCount=Math.max(streak,0);
  let calHTML='';
  for(let i=0;i<7;i++){
    const dayNum=i+1;
    const checked=i<streakCount;
    const isNext=i===streakCount;
    const dotClass=checked?'done':isNext?'today':'';
    const label=dayNum+'일';
    calHTML+=`<div class="streak-day"><div class="sd-label">${label}</div><div class="sd-dot ${dotClass}">${checked?'✓':isNext?'·':''}</div></div>`;
  }
  document.getElementById('streakDays').innerHTML=calHTML;
  // Streak rewards
  const nextBonus=[3,7,14,30].find(n=>n>streak)||30;
  const srEl=document.getElementById('streakReward');
  if(srEl)srEl.innerHTML=`${streak}일 연속 출석 중! <b>${nextBonus}일 보너스까지 ${nextBonus-streak}일</b>`;

  // Daily Workout (primary)
  renderWorkout();
  renderTicketCount();
  renderPoints(true);

  // (milestones removed)

  // Total plays tracking
  LS.set('totalPlays',(LS.get('totalPlays',0)));

  // Game grid grouped by category
  const CAT_META={
    '기억력':{icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" style="width:16px;height:16px;vertical-align:-3px"><path d="M12 2a7 7 0 017 7c0 3-2 5-4 7l-3 4-3-4c-2-2-4-4-4-7a7 7 0 017-7z"/></svg>',desc:'정보를 저장하고 떠올리는 능력'},
    '집중':{icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" style="width:16px;height:16px;vertical-align:-3px"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2" fill="currentColor"/></svg>',desc:'주의를 유지하고 선택적으로 집중하는 능력'},
    '연산':{icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" style="width:16px;height:16px;vertical-align:-3px"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>',desc:'수를 빠르고 정확하게 처리하는 능력'},
    '유연성':{icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" style="width:16px;height:16px;vertical-align:-3px"><polyline points="16 3 21 3 21 8"/><line x1="4" y1="20" x2="21" y2="3"/><polyline points="21 16 21 21 16 21"/><line x1="15" y1="15" x2="21" y2="21"/><line x1="4" y1="4" x2="9" y2="9"/></svg>',desc:'사고를 전환하고 적응하는 능력'},
    '언어':{icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" style="width:16px;height:16px;vertical-align:-3px"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>',desc:'단어와 언어를 처리하는 능력'},
    '논리':{icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" style="width:16px;height:16px;vertical-align:-3px"><path d="M9.5 2A2.5 2.5 0 0112 4.5V5h2.5A2.5 2.5 0 0117 7.5V10h.5a2.5 2.5 0 010 5H17v2.5a2.5 2.5 0 01-2.5 2.5H12v.5a2.5 2.5 0 01-5 0V20H4.5A2.5 2.5 0 012 17.5V15h.5a2.5 2.5 0 010-5H2V7.5A2.5 2.5 0 014.5 5H7v-.5A2.5 2.5 0 019.5 2z"/></svg>',desc:'규칙을 파악하고 논리적으로 추론하는 능력'},
    '공간':{icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:16px;height:16px;vertical-align:-3px"><path d="M12 2l10 6v8l-10 6-10-6V8z"/></svg>',desc:'공간과 도형을 인식하고 조작하는 능력'},
    '반응':{icon:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" style="width:16px;height:16px;vertical-align:-3px"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>',desc:'빠르고 정확하게 반응하는 능력'}
  };
  const cats=['기억력','집중','연산','유연성','언어','논리','공간','반응'];
  let gridHtml='';
  cats.forEach(cat=>{
    const games=GAMES.filter(g=>g.cat===cat);if(!games.length)return;
    const m=CAT_META[cat]||{icon:'',desc:''};
    gridHtml+=`<div style="margin-top:16px;margin-bottom:8px"><div style="font-size:13px;font-weight:700;display:flex;align-items:center;gap:6px;color:var(--sub)">${m.icon} ${cat}</div><div style="font-size:11px;color:var(--sub);margin-top:1px">${m.desc}</div></div>`;
    gridHtml+=`<div class="game-grid">${games.map(g=>`<div class="game-card" onclick="startGame('${g.id}')">
      <div class="gc-icon" style="width:36px;height:36px;border-radius:10px;background:${g.color}18;color:${g.color};display:flex;align-items:center;justify-content:center;padding:7px">${GI[g.id]||''}</div>
      <div class="gc-name">${g.name}</div>
      <div class="gc-desc">${g.desc}</div>
      <div class="gc-best">${(()=>{const b=LS.get(g.id+'-best',0);if(b>0){const p=101-estimatedPercentile(g.id,b);return'<span class="tds-badge tds-badge-xs tds-badge-weak-blue">'+b+'점</span> 상위 '+p+'%'}return'<span style="color:var(--sub)">도전해보세요!</span>'})()}</div>
    </div>`).join('')}</div>`;
  });
  document.getElementById('gameGrid').innerHTML=gridHtml;
}

function goHome(){clearInterval(curTimer);clearTimeout(curTimer);show('homeScreen');document.getElementById('overlay').classList.remove('active');renderHome()}
function debugAddPoint(){const prev=getPoints();addPoints(1);animatePointsFrom(prev);}
function animatePointsFrom(from){
  const to=getPoints(),diff=to-from,dur=600,prog=document.getElementById('pointProgress'),bar=document.getElementById('pointBar');
  if(!prog||diff<=0)return;
  const card=prog.closest('div[style*="background:var(--card)"]');
  // Phase 1: Flash blue with "+N점" overlay
  if(card){
    // Save original content, replace with centered "+N점"
    const origHTML=card.innerHTML;
    card.style.transition='background .3s, box-shadow .3s';
    card.style.background='var(--p)';card.style.boxShadow='0 4px 16px rgba(49,130,246,.3)';
    card.innerHTML=`<div style="text-align:center;padding:20px 0;color:#fff;font-size:28px;font-weight:800">+${diff}점</div>`;
    // Restore after 1.2s
    setTimeout(()=>{
      card.style.background='var(--card)';card.style.boxShadow='var(--shadow)';
      card.innerHTML=origHTML;
      // Re-grab elements after restore
      const p2=document.getElementById('pointProgress'),b2=document.getElementById('pointBar');
      const start=performance.now();
      function tick(now){const t=Math.min(1,(now-start)/dur);const ease=1-Math.pow(1-t,3);const cur=Math.round(from+(to-from)*ease);
        if(p2)p2.textContent=cur+' / 100점';if(b2)b2.style.width=Math.min(100,cur)+'%';if(t<1)requestAnimationFrame(tick);
        else{const btn=document.getElementById('exchangeBtn');if(btn)btn.disabled=to<100}}
      requestAnimationFrame(tick);
    },1200);
  }
}

let curGoal=0,goalReached=false;
function initGoalBar(id){
  const best=LS.get(id+'-best',0);
  const defaults={math:200,memory:120,reaction:400,stroop:150,sequence:100,word:120,pattern:120,focus:200,
    rotate:120,reverse:80,numtouch:100,rhythm:80,rps:120,oddone:150,compare:120,bulb:80,colormix:100,
    wordcomp:120,timing:100,matchpair:120,headcount:120,pyramid:120,maxnum:150,signfind:120,coincount:120,
    clock:100,wordmem:80,blockcount:120,flanker:120,memgrid:80,nback:150,scramble:120,serial:150,
    leftright:120,calccomp:120,flash:80,sort:150,mirror:120};
  curGoal=best>0?Math.ceil(best*0.9):(defaults[id]||60);goalReached=false;
  const scoreEl=document.querySelector('#game-'+id+' .g-score');
  if(!scoreEl)return;
  let bar=scoreEl.parentElement.querySelector('.goal-bar');
  if(!bar){bar=document.createElement('div');bar.className='goal-bar';
    bar.innerHTML='<div class="gb-label"><span class="gb-cur">0점</span><span class="gb-target">목표 0점</span></div><div class="gb-track"><div class="gb-fill"></div></div>';
    scoreEl.after(bar)}
  bar.querySelector('.gb-target').textContent='목표 '+curGoal+'점';
  bar.querySelector('.gb-cur').textContent='0점';
  bar.querySelector('.gb-fill').style.width='0';
  bar.querySelector('.gb-fill').className='gb-fill';
}
function setScore(elId,score){document.getElementById(elId).textContent=score+'점';updateGoal(score,curGame)}
function updateGoal(score,gameId){
  const bar=document.querySelector('#game-'+gameId+' .goal-bar');if(!bar)return;
  const pct=Math.min(100,Math.round(score/curGoal*100));
  bar.querySelector('.gb-cur').textContent=score+'점';
  const fill=bar.querySelector('.gb-fill');fill.style.width=pct+'%';
  if(!goalReached&&score>=curGoal){goalReached=true;fill.className='gb-fill done';toast('목표 달성!')}
  else if(pct>=80)fill.className='gb-fill hot';
}
// ===== TICKET SYSTEM =====
const MAX_TICKETS=5;
function getTickets(){
  const today=getDayKey();
  const saved=LS.getJSON('tickets',null);
  if(!saved||saved.day!==today){
    const prev=saved?saved.count:0;
    const count=prev>=MAX_TICKETS?prev:MAX_TICKETS;
    const t={day:today,count};LS.setJSON('tickets',t);return t;
  }
  return saved;
}
function useTicket(){
  const t=getTickets();
  t.count=Math.max(0,t.count-1);
  LS.setJSON('tickets',t);
  return t.count;
}
function renderTicketCount(){
  const el=document.getElementById('ticketNum');
  if(el) el.textContent=getTickets().count;
}
let _pendingTicketGame=null;
function showTicketModal(gameId){
  _pendingTicketGame=gameId;
  document.getElementById('ticketModal').style.display='flex';
  document.getElementById('ticketAdBtn').onclick=()=>{
    closeTicketModal();
    AIT.showAd('interstitial').then(()=>{
      wkActive=false;
      curGame=gameId;curScore=0;
      LS.set('totalPlays',LS.get('totalPlays',0)+1);
      show('game-'+gameId);initGoalBar(gameId);
      ({math:initMath,memory:initMemory,sequence:initSequence,stroop:initStroop,reaction:initReaction,
        word:initWord,pattern:initPattern,focus:initFocus,rotate:initRotate,reverse:initReverse,
        numtouch:initNumtouch,rhythm:initRhythm,rps:initRps,oddone:initOddone,compare:initCompare,
        bulb:initBulb,colormix:initColormix,wordcomp:initWordcomp,timing:initTiming,matchpair:initMatchpair,
        headcount:initHeadcount,pyramid:initPyramid,maxnum:initMaxnum,signfind:initSignfind,
        coincount:initCoincount,clock:initClock,wordmem:initWordmem,blockcount:initBlockcount,
        flanker:initFlanker,memgrid:initMemgrid,nback:initNback,scramble:initScramble,serial:initSerial,
        leftright:initLeftright,calccomp:initCalccomp,flash:initFlash,sort:initSort,mirror:initMirror})[gameId]();
      AIT.log('game_start',{game:gameId,source:'ticket_ad'});
    });
  };
}
function showTicketShop(){
  const t=getTickets();
  document.getElementById('ts-count').textContent=t.count+'장';
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById('ticketShop').classList.add('active');
}
function ticketAdRefill(){
  showAd(()=>{
    const bonus=3+~~(Math.random()*3); // 3~5장
    const t=getTickets();
    t.count=Math.min(99,t.count+bonus);
    LS.setJSON('tickets',t);
    renderTickets();
    document.getElementById('ts-count').textContent=t.count+'장';
    snackbar(`<img src="https://static.toss.im/2d-emojis/svg/u1F39F.svg" style="width:16px;height:16px">티켓 ${bonus}장 충전 완료!`);
  });
}
function closeTicketModal(){
  document.getElementById('ticketModal').style.display='none';
  _pendingTicketGame=null;
}

let _skipTicket=false;
function startGame(id){
  // 운동 모드가 아닌 자유 훈련일 때 티켓 체크
  if(!wkActive&&!_skipTicket){
    const t=getTickets();
    if(t.count<=0){
      showTicketModal(id);
      return;
    }
    const remaining=useTicket();
    snackbar(`<img src="https://static.toss.im/2d-emojis/svg/u1F39F.svg" style="width:16px;height:16px">티켓 사용 · 남은 티켓 ${remaining}장`);
    renderTicketCount();
  }
  _skipTicket=false;curGame=id;curScore=0;timeExtendUsed=false;
  LS.set('totalPlays',LS.get('totalPlays',0)+1);
  show('game-'+id);initGoalBar(id);
  ({math:initMath,memory:initMemory,sequence:initSequence,stroop:initStroop,reaction:initReaction,
    word:initWord,pattern:initPattern,focus:initFocus,rotate:initRotate,reverse:initReverse,
    numtouch:initNumtouch,rhythm:initRhythm,rps:initRps,oddone:initOddone,compare:initCompare,
    bulb:initBulb,colormix:initColormix,wordcomp:initWordcomp,timing:initTiming,matchpair:initMatchpair,
    headcount:initHeadcount,pyramid:initPyramid,maxnum:initMaxnum,signfind:initSignfind,
    coincount:initCoincount,clock:initClock,wordmem:initWordmem,blockcount:initBlockcount,
    flanker:initFlanker,memgrid:initMemgrid,nback:initNback,scramble:initScramble,serial:initSerial,
    leftright:initLeftright,calccomp:initCalccomp,flash:initFlash,sort:initSort,mirror:initMirror})[id]();
  AIT.log('game_start',{game:id,totalPlays:LS.get('totalPlays',0)});
}

// ===== RESULT =====
function getRetryMotivation(gameId,score,best,isNew){
  const g=GAMES.find(x=>x.id===gameId);
  // Level-based games (hearts + no timer = survival games)
  const levelGames=['sequence','reverse','rhythm','bulb','flash','wordmem','memgrid','headcount'];
  const isLevel=levelGames.includes(gameId);

  const btn='광고보고 한 번 더 도전하기';
  if(isNew&&score>0){
    if(isLevel)return{msg:'새 기록 달성! 집중력이 올라왔을 때 더 높이!',btn};
    return{msg:'컨디션 최고! 이 기세로 더 높은 점수를!',btn};
  }
  if(best>0&&score>=best*0.8){
    const gap=best-score;
    return{msg:`최고기록까지 단 ${gap}점! 충분히 깰 수 있어요`,btn};
  }
  if(best>0&&score>=best*0.5){
    return{msg:`최고기록 ${best}점, 워밍업 끝! 실력 발휘할 차례`,btn};
  }
  if(best>0){
    return{msg:'한 판 더 하면 감이 올 거예요!',btn};
  }
  return{msg:'첫 기록이 세워졌어요! 더 높은 점수에 도전?',btn};
}
let _showResultArgs=null;
function showResult(score,name,stats,extra={}){
  // 타이머 게임 첫 종료 시 +5초 제안
  const timerGames=['math','stroop','pattern','focus','rps','compare','oddone','maxnum','signfind','coincount','sort','flanker','nback','leftright','rotate','colormix','wordcomp','headcount','pyramid','clock','blockcount','calccomp','serial','matchpair','mirror'];
  // 시간 변수 매핑
  const timeVars={math:()=>mathTime,stroop:()=>stroopTime,pattern:()=>patTime,focus:()=>focusTime,rps:()=>rpsTime,compare:()=>cmpTime,oddone:()=>oddTime,maxnum:()=>mnTime,signfind:()=>sfTime,coincount:()=>ccTime,sort:()=>sortTime,flanker:()=>flTime,nback:()=>nbTime,leftright:()=>lrTime,rotate:()=>rotTime,colormix:()=>cmxTime,wordcomp:()=>wcTime,headcount:()=>hcTime,pyramid:()=>pyrTime,clock:()=>clkTime,blockcount:()=>bcTime,calccomp:()=>cc2Time,serial:()=>serTime,matchpair:()=>mpTime,mirror:()=>mrTime};
  const isTimerEnd=timeVars[curGame]?timeVars[curGame]()<=0:false;
  if(!timeExtendUsed&&timerGames.includes(curGame)&&!extra._fromTimeExtend&&isTimerEnd){
    _showResultArgs=[score,name,stats,extra];
    showTimeExtend(()=>{
      const a=_showResultArgs;
      a[3]._fromTimeExtend=true;
      showResult(...a);
    });
    return;
  }
  curScore=score;
  const best=LS.get(curGame+'-best',0),isNew=score>best;
  if(isNew)LS.set(curGame+'-best',score);
  recordPlay();

  // XP calculation: base + score bonus + new record bonus
  let xpGain=10+Math.floor(score/5);
  if(isNew&&score>0)xpGain+=15;
  const oldXP=getXP();const oldRank=getRank(oldXP);
  const newXP=addXP(xpGain);const newRank=getRank(newXP);

  // Mission check
  const completed=updateMission(curGame,score,extra);
  completed.forEach(m=>addXP(m.xp));

  // UI
  // emoji removed
  document.getElementById('r-title').textContent=name+' 완료!';
  const bonusEl=document.getElementById('r-bonus');
  if(extra.timeBonus){
    const tb=extra.timeBonus,ts=extra.timeLeft;
    const baseScore=score-tb;
    setScore('r-score',baseScore);
    bonusEl.innerHTML=`<div style="font-size:14px;color:var(--sub);margin:2px 0">남은 시간 ${ts}초 × 5</div><div style="font-size:20px;font-weight:800;color:var(--ok)">+${tb}점</div>`;
    bonusEl.classList.remove('hide');
    setTimeout(()=>{setScore('r-score',score);bonusEl.querySelector('div:last-child').style.opacity='0.5'},1500);
  }else{
    setScore('r-score',score);
    bonusEl.classList.add('hide');
  }
  const bestNow=LS.get(curGame+'-best',0);
  if(isNew&&score>0){document.getElementById('r-cat').textContent='새로운 최고기록!';document.getElementById('r-cat').style.color='var(--ok)'}
  else if(bestNow>0){const pct=Math.round(score/bestNow*100);
    if(pct>=100){document.getElementById('r-cat').textContent=`최고기록 달성!`;document.getElementById('r-cat').style.color='var(--ok)'}
    else if(pct>=90){document.getElementById('r-cat').textContent=`최고기록의 ${pct}% — 거의 다 왔어요!`;document.getElementById('r-cat').style.color='var(--p)'}
    else if(pct>=70){document.getElementById('r-cat').textContent=`최고기록의 ${pct}% — 조금만 더!`;document.getElementById('r-cat').style.color='var(--p)'}
    else{document.getElementById('r-cat').textContent=`최고기록 ${bestNow}점 대비 ${pct}%`;document.getElementById('r-cat').style.color='var(--sub)'}
  }else{document.getElementById('r-cat').textContent='첫 기록!';document.getElementById('r-cat').style.color='var(--p)'}

  // XP display
  const xpEl=document.getElementById('r-xp');
  xpEl.textContent=`+${xpGain} XP`;
  xpEl.classList.remove('hide');

  // Point display
  let ptGain=0;
  if(completed.length)ptGain+=completed.length; // +1 per mission
  const ptEl=document.getElementById('r-pt');
  if(ptGain>0){ptEl.textContent=`+${ptGain} 두뇌점수`;ptEl.classList.remove('hide')}
  else{ptEl.classList.add('hide')}

  // Mission display
  const mEl=document.getElementById('r-mission');
  if(completed.length){
    mEl.innerHTML=''+completed.map(m=>`${m.name} 완료! (+${m.xp}XP)`).join(' / ');
    mEl.classList.remove('hide');
  }else{mEl.classList.add('hide')}

  // Stats
  const statsEl=document.getElementById('r-stats');
  if(stats?.length){statsEl.innerHTML=stats.map(s=>`<div class="r-stat"><div class="rs-val">${s.val}</div><div class="rs-label">${s.label}</div></div>`).join('');statsEl.classList.remove('hide')}
  else{statsEl.classList.add('hide')}

  // Event logging & Game Center
  AIT.log('game_complete',{game:curGame,score,best:LS.get(curGame+'-best',0),isNew,xp:xpGain});
  if(score>0 && AIT.isToss) AIT.submitScore(score).catch(()=>{});

  // Percentile (async)
  const pctEl=document.getElementById('r-percentile');
  pctEl.classList.add('hide');
  if(score>0){AIT.getUserHash().then(uh=>fetch('/api/score',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({game:curGame,score,userHash:uh})})).then(r=>r.json()).then(d=>{
    const top=100-d.percentile;
    document.getElementById('r-pct-val').textContent=top<=1?'상위 1%':`상위 ${top}%`;
    document.getElementById('r-pct-val').style.color=top<=10?'var(--ok)':top<=30?'var(--purple)':'var(--p)';
    document.getElementById('r-pct-players').textContent=d.totalPlayers>=100?`${d.totalPlayers.toLocaleString()}명 참여`:'';
    pctEl.classList.remove('hide');
  }).catch(()=>{})}

  // Science card
  const SCIENCE={
    math:{t:'암산이 두뇌에 미치는 효과',d:'암산은 전두엽의 작업 기억과 처리 속도를 활성화합니다. 도호쿠 대학 연구에 따르면 빠른 계산 훈련이 전두전피질 혈류를 증가시켜 인지 기능 저하를 예방합니다.'},
    memory:{t:'기억력 카드와 작업 기억',d:'카드 매칭은 시각적 작업 기억(Visual Working Memory)을 훈련합니다. 해마와 전두엽이 협력하여 단기 정보를 저장하고 비교하는 능력이 향상됩니다.'},
    reaction:{t:'반응속도와 신경 전달',d:'반응속도 훈련은 신경 전달 속도와 운동 피질의 효율성을 높입니다. 규칙적인 훈련으로 평균 반응시간이 10-15% 개선될 수 있습니다.'},
    stroop:{t:'스트룹 효과와 인지 억제',d:'글자 색상과 의미가 충돌할 때 전두엽의 억제 제어(Inhibitory Control)가 작동합니다. 이 능력은 충동 조절과 의사결정에 핵심적입니다.'},
    sequence:{t:'순서 기억과 작업 기억 용량',d:'숫자 순서 기억은 작업 기억 용량(Working Memory Span)을 측정하고 훈련합니다. 일반 성인의 기억 폭은 7±2개이며, 훈련으로 확장 가능합니다.'},
    word:{t:'단어 찾기와 언어 처리',d:'단어 검색은 좌측 측두엽의 언어 네트워크를 활성화합니다. 시각 탐색과 어휘 인출을 동시에 수행하여 멀티태스킹 능력을 강화합니다.'},
    pattern:{t:'패턴 인식과 유동 지능',d:'패턴 완성은 유동 지능(Fluid Intelligence)의 핵심 요소입니다. 규칙을 추론하는 능력은 새로운 문제 해결과 학습 속도에 직결됩니다.'},
    focus:{t:'선택적 주의력 훈련',d:'타겟만 빠르게 터치하는 과제는 선택적 주의력(Selective Attention)을 훈련합니다. 불필요한 자극을 걸러내는 이 능력은 일상의 집중력과 직결됩니다.'},
    rotate:{t:'심적 회전과 공간 인지',d:'도형 회전은 두정엽의 심적 회전(Mental Rotation) 능력을 사용합니다. 이 능력은 길 찾기, 주차, 물건 조립 등 실생활 공간 능력의 기반입니다.'},
    reverse:{t:'역순 기억과 실행 기능',d:'숫자를 거꾸로 기억하는 과제는 작업 기억의 조작 능력을 훈련합니다. 단순 저장이 아닌 정보 변환이 필요하여 전두엽 실행 기능을 강화합니다.'},
    numtouch:{t:'시각 탐색과 처리 속도',d:'1부터 25까지 순서대로 찾는 과제는 시각 탐색 속도와 주의 전환을 훈련합니다. TMT(Trail Making Test)와 유사한 신경심리검사 원리입니다.'},
    rhythm:{t:'리듬 기억과 절차적 기억',d:'리듬 패턴 기억은 절차적 기억(Procedural Memory)과 청각 작업 기억을 활용합니다. 음악적 패턴 인식 능력은 언어 학습과도 관련됩니다.'},
    rps:{t:'인지 유연성과 반응 억제',d:'조건에 맞게 선택하는 과제는 자동 반응을 억제하고 규칙을 전환하는 인지 유연성을 훈련합니다. 전두엽의 실행 제어 네트워크가 핵심입니다.'},
    oddone:{t:'시각 변별력과 주의력',d:'다른 글자를 찾는 과제는 시각 변별력(Visual Discrimination)을 훈련합니다. 미세한 차이를 빠르게 감지하는 능력은 두정엽과 시각 피질의 협력으로 이루어집니다.'},
    compare:{t:'수 감각과 비교 판단',d:'두 수의 크기를 빠르게 비교하는 능력은 두정엽 내측 고랑(IPS)에서 처리됩니다. 수 감각(Number Sense)은 수학적 사고의 기초 능력입니다.'},
    bulb:{t:'시각적 순서 기억',d:'전구 순서 기억은 시공간 작업 기억(Visuospatial Sketchpad)을 훈련합니다. Corsi 블록 과제와 동일한 원리로 공간적 순서 기억 용량을 확장합니다.'},
    colormix:{t:'색채 인지와 논리 추론',d:'색 혼합 결과를 추론하는 과제는 시각 처리와 논리적 추론을 결합합니다. 색채 정보 처리는 V4 영역에서, 추론은 전두엽에서 담당합니다.'},
    wordcomp:{t:'어휘 인출과 언어 지식',d:'빈칸에 맞는 글자를 찾는 과제는 장기 기억에서 어휘를 인출하는 능력을 훈련합니다. 브로카 영역과 측두엽의 의미 네트워크가 활성화됩니다.'},
    timing:{t:'시간 지각과 운동 제어',d:'정확한 타이밍에 멈추는 과제는 소뇌와 기저핵의 시간 지각(Time Perception) 능력을 훈련합니다. 이 능력은 운동 조절과 리듬감의 기초입니다.'},
    matchpair:{t:'의미 연결과 연상 기억',d:'한자어와 뜻을 연결하는 과제는 연상 기억(Associative Memory)을 훈련합니다. 해마의 관계 결합(Relational Binding) 기능이 핵심입니다.'},
    headcount:{t:'추적 주의력과 수 세기',d:'인원 세기는 다중 물체 추적(MOT) 능력을 활용합니다. 여러 대상을 동시에 주시하는 이 능력은 운전, 스포츠 등 실생활에서 중요합니다.'},
    pyramid:{t:'역산과 문제 해결',d:'피라미드 연산은 역방향 추론(Backward Reasoning)을 훈련합니다. 결과에서 원인을 역추적하는 이 능력은 수학적 사고력의 핵심입니다.'},
    maxnum:{t:'시각 탐색과 수 비교',d:'숫자 배열에서 최대/최소를 찾는 과제는 병렬 시각 탐색(Parallel Visual Search)과 수 비교를 동시에 훈련합니다.'},
    signfind:{t:'연산 추론과 역사고',d:'빠진 연산자를 찾는 과제는 역방향 수학적 추론을 필요로 합니다. 결과를 보고 과정을 추론하는 이 능력은 문제 해결의 핵심입니다.'},
    coincount:{t:'수량 감각과 암산',d:'동전 합산은 실생활 수량 감각(Numeracy)을 훈련합니다. 여러 단위를 빠르게 합산하는 능력은 두정엽의 수 처리 네트워크를 강화합니다.'},
    clock:{t:'시각적 해석과 각도 인지',d:'아날로그 시계 읽기는 시각적 각도 해석과 수 변환을 결합합니다. 시계 읽기 능력은 신경심리 검사에서 시공간 인지의 지표로 사용됩니다.'},
    wordmem:{t:'부호화와 인출 전략',d:'단어 암기는 기억의 3단계(부호화-저장-인출)를 모두 훈련합니다. 효과적인 기억 전략(청킹, 연상)을 사용할수록 성적이 향상됩니다.'},
    blockcount:{t:'공간 추론과 시각화',d:'블록 세기는 3차원 공간 추론 능력을 훈련합니다. 보이지 않는 블록을 상상하는 시각화(Visualization) 능력은 공학적 사고의 기반입니다.'},
    flanker:{t:'플랭커 과제와 주의 집중',d:'방향 맞추기는 에릭슨 플랭커 과제(Eriksen Flanker Task)에 기반합니다. 방해 자극을 무시하고 목표에 집중하는 간섭 제어(Interference Control) 능력을 훈련합니다.'},
    memgrid:{t:'공간 작업 기억',d:'격자 기억은 시공간 잡기장(Visuospatial Sketchpad)의 용량을 훈련합니다. Corsi 블록 과제의 2D 버전으로, 공간적 단기 기억의 핵심 지표입니다.'},
    nback:{t:'N-back과 작업 기억 갱신',d:'이전과 현재를 비교하는 N-back 과제는 작업 기억의 갱신(Updating) 능력을 훈련합니다. 연구에 따르면 N-back 훈련이 유동 지능 향상과 관련됩니다.'},
    scramble:{t:'철자 재배열과 어휘 접근',d:'섞인 글자에서 단어를 찾는 과제는 심성 어휘집(Mental Lexicon) 접근 속도를 훈련합니다. 글자 패턴 인식과 어휘 인출의 협력이 필요합니다.'},
    serial:{t:'연속 빼기와 집중 지속',d:'연속 빼기(Serial Subtraction)는 신경심리 검사에서 주의력과 작업 기억을 평가하는 표준 도구입니다. 연속적인 계산은 지속적 주의력을 요구합니다.'},
    leftright:{t:'좌우 판별과 신체 도식',d:'손의 좌우를 판별하는 과제는 두정엽의 신체 도식(Body Schema) 처리를 훈련합니다. 심적 회전을 통한 좌우 판단은 공간 인지의 기초 능력입니다.'},
    calccomp:{t:'수식 비교와 추정 능력',d:'두 수식의 크기를 비교하는 과제는 근사 수 체계(ANS)와 정확한 계산을 동시에 사용합니다. 빠른 추정 능력은 일상의 수학적 판단에 핵심적입니다.'},
    flash:{t:'순간 기억과 아이코닉 메모리',d:'짧게 보여주는 숫자를 기억하는 과제는 아이코닉 메모리(Iconic Memory)에서 작업 기억으로의 전이를 훈련합니다. 정보 처리의 첫 단계를 강화합니다.'},
    sort:{t:'범주화와 인지 전환',d:'카테고리 분류는 개념의 범주화(Categorization)와 빠른 인지 전환을 훈련합니다. 위스콘신 카드 분류 검사(WCST)와 유사한 원리로 전두엽 기능을 활성화합니다.'},
    mirror:{t:'거울 읽기와 시각 변환',d:'뒤집힌 글자를 읽는 과제는 시각적 변환(Visual Transformation) 능력을 훈련합니다. 익숙한 패턴을 다른 관점에서 인식하는 이 능력은 인지적 유연성의 지표입니다.'}
  };
  const sci=SCIENCE[curGame];
  if(sci){document.getElementById('r-sci-title').textContent=sci.t;document.getElementById('r-sci-desc').textContent=sci.d;document.getElementById('r-science').classList.remove('hide')}
  else{document.getElementById('r-science').classList.add('hide')}

  // Workout mode
  if(wkActive){
    document.getElementById('r-retry-msg').classList.add('hide');
    wkOnGameEnd(curGame,score);
    const btn=document.getElementById('r-main-btn');
    if(wkIdx<wkGames.length){
      btn.textContent='다음 운동 ('+( getTodayWorkout().done.length)+'/'+WK_SIZE+')';
      btn.onclick=()=>{document.getElementById('overlay').classList.remove('active');wkContinue()};
    }else{
      btn.textContent='운동 완료! 보상 받기';
      btn.onclick=()=>{document.getElementById('overlay').classList.remove('active');finishWorkout()};
    }
  }else{
    const btn=document.getElementById('r-main-btn');
    const retryMsg=getRetryMotivation(curGame,score,best,isNew);
    document.getElementById('r-retry-msg').textContent=retryMsg.msg;
    document.getElementById('r-retry-msg').classList.remove('hide');
    btn.textContent=retryMsg.btn;
    btn.onclick=replayGame;
  }

  // challenge btn removed

  // Reset brain age card
  // brain age section removed

  document.getElementById('overlay').classList.add('active');

  // Level up check (delayed)
  if(newRank!==oldRank){
    setTimeout(()=>showLevelUp(newRank,newXP),600);
  }
}

function showLevelUp(rank,xp){
  document.getElementById('lu-badge').innerHTML=RANK_SVG;document.getElementById('lu-badge').style.color=rank.color;
  document.getElementById('lu-title').textContent='두뇌 나이 '+rank.name+'로 젊어졌어요!';
  document.getElementById('lu-desc').textContent='꾸준한 훈련으로 두뇌가 젊어지고 있어요!';
  // Check if new games unlocked
  const newGames=GAMES.filter(g=>g.unlockXp<=xp&&g.unlockXp>0).filter(g=>{
    const prevRank=RANKS.filter(r=>r.minXp<rank.minXp).pop();
    return prevRank?g.unlockXp>prevRank.minXp:true;
  });
  const ulEl=document.getElementById('lu-unlock');
  if(newGames.length){
    ulEl.innerHTML='⊕ 새 게임 해금: '+newGames.map(g=>g.name).join(', ');
    ulEl.classList.remove('hide');
  }else{ulEl.classList.add('hide')}
  document.getElementById('levelupOverlay').classList.add('active');
}
function closeLevelUp(){document.getElementById('levelupOverlay').classList.remove('active')}

function replayGame(){
  replayCount++;document.getElementById('overlay').classList.remove('active');
  AIT.log('ad_retry',{game:curGame,replayCount});
  _skipTicket=true;showAd(()=>startGame(curGame))
}
function goHomeFromResult(){document.getElementById('overlay').classList.remove('active');AIT.setScreenAwake(false);goHome()}

function shareScore(){
  const gName=GAMES.find(g=>g.id===curGame)?.name||curGame;
  const best=LS.get(curGame+'-best',0);
  const msg=`매일매일 두뇌운동에서 ${gName} ${curScore}점 달성! (최고기록 ${best}점) 나와 두뇌 대결하자!`;
  AIT.shareMessage(msg);
  AIT.log('share_score',{game:curGame,score:curScore});
}

function inviteFriend(){
  const cleanup=AIT.shareInvite();
  AIT.log('invite_friend',{game:curGame});
  // cleanup은 토스 내에서 자동 처리
}

function showAd(cb, type='interstitial'){
  if(AIT.isToss){
    // Real Toss ad
    AIT.showAd(type).then(r=>{cb?.()}).catch(()=>{cb?.()});
    return;
  }
  // Web fallback: mock ad overlay
  const o=document.createElement('div');
  o.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:9999;display:flex;align-items:center;justify-content:center;color:#fff;font:600 17px var(--font);flex-direction:column;gap:12px';
  o.innerHTML='<div style="color:var(--sub)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:32px;height:32px"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg></div><div>광고 로딩 중...</div>';
  document.body.appendChild(o);setTimeout(()=>{o.remove();cb?.()},1500);
}

// ================================================================
// ===== ALL 10 GAME IMPLEMENTATIONS (preserved from before) =====
// ================================================================

// ===== GAME 1: MATH =====
let mathScore,mathCombo,mathTime,mathAnswer,mathInput,mathTotal,mathMaxCombo;
function initMath(){
  mathScore=0;mathCombo=0;mathTime=30;mathInput='';mathTotal=0;mathMaxCombo=0;
  document.getElementById('math-score').textContent='0점';document.getElementById('math-combo').textContent='';
  initHearts('math');mathGen();clearInterval(curTimer);mathUpdateT();
  curTimer=setInterval(()=>{mathTime--;mathUpdateT();if(mathTime<=0){clearInterval(curTimer);showResult(mathScore,'암산 챌린지',[{val:mathTotal,label:'문제 수'},{val:mathMaxCombo+'x',label:'최대 콤보'}],{combo:mathMaxCombo})}},1000);
}
function mathUpdateT(){const el=document.getElementById('math-timer');el.textContent=mathTime+'s';el.className=mathTime<=10?'g-timer urgent':'g-timer'}
function mathGen(){
  const mx=Math.min(10+Math.floor(mathScore/3)*5,99);
  const ops=mathScore<5?['+','-']:['+','-','×'];
  const op=ops[~~(Math.random()*ops.length)];let a,b;
  if(op==='×'){a=~~(Math.random()*12)+2;b=~~(Math.random()*12)+2;mathAnswer=a*b}
  else if(op==='-'){a=~~(Math.random()*mx)+1;b=~~(Math.random()*a)+1;mathAnswer=a-b}
  else{a=~~(Math.random()*mx)+1;b=~~(Math.random()*mx)+1;mathAnswer=a+b}
  document.getElementById('math-a').textContent=a;document.getElementById('math-b').textContent=b;
  document.getElementById('math-op').textContent=op;mathInput='';document.getElementById('math-ans').textContent='?';
}
function mathPress(n){mathInput+=n;document.getElementById('math-ans').textContent=mathInput}
function mathDel(){mathInput=mathInput.slice(0,-1);document.getElementById('math-ans').textContent=mathInput||'?'}
function mathSubmit(){
  if(!mathInput)return;mathTotal++;const p=document.getElementById('math-problem');
  if(parseInt(mathInput)===mathAnswer){mathScore+=(mathCombo>=5?30:mathCombo>=3?20:10);mathCombo++;mathMaxCombo=Math.max(mathMaxCombo,mathCombo);p.classList.add('ok');if(mathCombo%5===0){mathTime=Math.min(mathTime+3,99);const te=document.getElementById('math-timer');te.textContent='+3초!';te.style.cssText='color:#10B981;font-size:22px;font-weight:900;transform:scale(1.3)';setTimeout(()=>{te.style.cssText='';mathUpdateT()},800)}}
  else{mathCombo=0;p.classList.add('no');curScore=mathScore;if(loseHeart('math'))return}
  setScore('math-score',mathScore);
  const mc=document.getElementById('math-combo');
  if(mathCombo>=2){mc.textContent=mathCombo+'콤보!'+(mathCombo>=5?' ×3':mathCombo>=3?' ×2':'');mc.style.cssText='transform:scale(1.4);transition:transform .15s';setTimeout(()=>mc.style.cssText='transition:transform .2s',150)}
  else{mc.textContent='';mc.style.cssText=''}
  if(mathCombo>0&&mathCombo%5===0){mc.textContent=mathCombo+'콤보! +3초 보너스!';mc.style.cssText='transform:scale(1.5);color:#10B981;font-size:18px;transition:transform .15s';setTimeout(()=>mc.style.cssText='transition:transform .3s',300)}
  setTimeout(()=>p.classList.remove('ok','no'),200);mathGen();
}

// ===== GAME 2: MEMORY =====
let memScore,memTime,memCards,memFlipped,memMatched,memLocked,memPairs;
const EMOJIS=['🐶','🐱','🐭','🐹','🐰','🦊','🐻','🐼','🐨','🐯','🦁','🐸','🐵','🐧','🐦','🦋'];
function initMemory(){
  memScore=0;memTime=30;memFlipped=[];memMatched=[];memLocked=false;memPairs=0;
  document.getElementById('mem-score').textContent='0점';
  const picked=EMOJIS.sort(()=>Math.random()-.5).slice(0,6);memCards=[...picked,...picked].sort(()=>Math.random()-.5);
  document.getElementById('mem-grid').innerHTML=memCards.map((e,i)=>`<div class="mem-card" data-i="${i}" onclick="memFlip(${i})"><span class="cf">${e}</span></div>`).join('');
  clearInterval(curTimer);document.getElementById('mem-timer').textContent='30s';document.getElementById('mem-timer').className='g-timer';
  curTimer=setInterval(()=>{memTime--;document.getElementById('mem-timer').textContent=memTime+'s';if(memTime<=10)document.getElementById('mem-timer').className='g-timer urgent';if(memTime<=0){clearInterval(curTimer);showResult(memScore,'기억력 카드',[{val:memPairs,label:'찾은 쌍'}])}},1000);
}
function memFlip(i){
  if(memLocked||memFlipped.includes(i)||memMatched.includes(i))return;
  document.querySelector(`.mem-card[data-i="${i}"]`).classList.add('flipped');memFlipped.push(i);
  if(memFlipped.length===2){memLocked=true;const[a,b]=memFlipped;
    if(memCards[a]===memCards[b]){memMatched.push(a,b);memPairs++;document.querySelector(`.mem-card[data-i="${a}"]`).classList.add('matched');document.querySelector(`.mem-card[data-i="${b}"]`).classList.add('matched');memScore+=10;setScore('mem-score',memScore);memFlipped=[];memLocked=false;
      if(memMatched.length===memCards.length){clearInterval(curTimer);const bonus=Math.max(0,memTime*5);memScore+=bonus;setScore('mem-score',memScore);setTimeout(()=>showResult(memScore,'기억력 카드',[{val:memPairs,label:'찾은 쌍'}],{timeBonus:bonus,timeLeft:memTime}),800)}
    }else{setTimeout(()=>{document.querySelector(`.mem-card[data-i="${a}"]`).classList.remove('flipped');document.querySelector(`.mem-card[data-i="${b}"]`).classList.remove('flipped');memFlipped=[];memLocked=false},600)}}
}

// ===== GAME 3: SEQUENCE =====
let seqLv,seqSeq,seqIdx,seqShowing,seqScore;
function initSequence(){seqLv=1;seqScore=0;document.getElementById('seq-score').textContent='0점';document.getElementById('seq-level').textContent='Lv.1';initHearts('seq');const g=document.getElementById('seq-grid');g.innerHTML='';for(let i=1;i<=9;i++){const d=document.createElement('div');d.className='seq-cell';d.textContent=i;d.dataset.n=i;d.onclick=()=>seqTap(i);g.appendChild(d)}seqNewRound()}
function seqNewRound(){seqShowing=true;seqIdx=0;const len=seqLv+2;seqSeq=[];while(seqSeq.length<len){const n=~~(Math.random()*9)+1;if(seqSeq[seqSeq.length-1]!==n)seqSeq.push(n)}document.getElementById('seq-msg').textContent='순서를 기억하세요!';let i=0;const iv=setInterval(()=>{document.querySelectorAll('.seq-cell').forEach(c=>c.classList.remove('hl'));if(i<seqSeq.length){document.querySelector(`.seq-cell[data-n="${seqSeq[i]}"]`).classList.add('hl');i++}else{clearInterval(iv);document.querySelectorAll('.seq-cell').forEach(c=>c.classList.remove('hl'));seqShowing=false;document.getElementById('seq-msg').textContent='같은 순서로 눌러주세요!'}},600)}
function seqTap(n){if(seqShowing)return;const c=document.querySelector(`.seq-cell[data-n="${n}"]`);if(n===seqSeq[seqIdx]){c.classList.add('ok');setTimeout(()=>c.classList.remove('ok'),300);seqIdx++;if(seqIdx===seqSeq.length){seqLv++;seqScore+=seqLv*5;setScore('seq-score',seqScore);document.getElementById('seq-level').textContent='Lv.'+seqLv;setTimeout(seqNewRound,500)}}else{c.classList.add('no');setTimeout(()=>c.classList.remove('no'),300);curScore=seqScore;if(loseHeart('seq'))return;setTimeout(seqNewRound,800)}}

// ===== GAME 4: STROOP =====
let stroopScore,stroopTime,stroopTotal,stroopCombo;
const COLORS=[{name:'빨강',hex:'#F04452'},{name:'파랑',hex:'#3182F6'},{name:'초록',hex:'#1FC58E'},{name:'노랑',hex:'#F59E0B'},{name:'보라',hex:'#8B5CF6'}];
function initStroop(){stroopScore=0;stroopTime=30;stroopTotal=0;stroopCombo=0;document.getElementById('stroop-score').textContent='0점';clearInterval(curTimer);initHearts('stroop');document.getElementById('stroop-timer').textContent='30s';document.getElementById('stroop-timer').className='g-timer';curTimer=setInterval(()=>{stroopTime--;document.getElementById('stroop-timer').textContent=stroopTime+'s';if(stroopTime<=10)document.getElementById('stroop-timer').className='g-timer urgent';if(stroopTime<=0){clearInterval(curTimer);showResult(stroopScore,'색깔 맞추기',[{val:stroopTotal,label:'문제 수'},{val:stroopCombo+'x',label:'최대 콤보'}])}},1000);stroopGen()}
function stroopGen(){const wc=COLORS[~~(Math.random()*COLORS.length)];let dc;do{dc=COLORS[~~(Math.random()*COLORS.length)]}while(dc===wc&&Math.random()>.3);document.getElementById('stroop-word').textContent=wc.name;document.getElementById('stroop-word').style.color=dc.hex;let opts=[dc];while(opts.length<4){const c=COLORS[~~(Math.random()*COLORS.length)];if(!opts.includes(c))opts.push(c)}opts.sort(()=>Math.random()-.5);document.getElementById('stroop-opts').innerHTML=opts.map(o=>`<button class="stroop-opt" style="color:${o.hex}" onclick="stroopPick('${o.name}','${dc.name}')">${o.name}</button>`).join('')}
function stroopPick(p,c){stroopTotal++;if(p===c){stroopCombo++;const bonus=stroopCombo>=10?3:stroopCombo>=5?2:1;stroopScore+=10*bonus;
setScore('stroop-score',stroopScore);if(stroopCombo>=5){stroopTime=Math.min(stroopTime+2,99);toast(stroopCombo+'콤보! +2초')}}
else{stroopCombo=0;curScore=stroopScore;if(loseHeart('stroop'))return}stroopGen()}

// ===== GAME 5: REACTION =====
let reactRound,reactTimes,reactState,reactTimeout,reactStart;
function initReaction(){reactRound=0;reactTimes=[];reactState='idle';document.getElementById('react-round').textContent='0/5';document.getElementById('react-score').textContent='준비하세요';reactNext()}
function reactNext(){reactRound++;if(reactRound>5){const avg=Math.round(reactTimes.reduce((a,b)=>a+b,0)/reactTimes.length);let score=0;reactTimes.forEach(ms=>{score+=Math.max(5,Math.round((1000-ms)/10))});showResult(score,'반응속도',[{val:avg+'ms',label:'평균'},{val:Math.min(...reactTimes)+'ms',label:'최고'}],{avg});return}document.getElementById('react-round').textContent=reactRound+'/5';const area=document.getElementById('react-area');area.className='react-area waiting';document.getElementById('react-msg').innerHTML='기다리세요...';reactState='waiting';reactTimeout=setTimeout(()=>{area.className='react-area ready';document.getElementById('react-msg').innerHTML='지금! 터치!';reactState='go';reactStart=Date.now()},1500+Math.random()*3000)}
function reactTap(){if(reactState==='waiting'){clearTimeout(reactTimeout);document.getElementById('react-msg').innerHTML='너무 빨라요!';reactState='idle';setTimeout(reactNext,800)}else if(reactState==='go'){const ms=Date.now()-reactStart;reactTimes.push(ms);document.getElementById('react-area').className='react-area result';document.getElementById('react-msg').innerHTML='<div class="react-time">'+ms+'ms</div>';document.getElementById('react-score').textContent='평균: '+Math.round(reactTimes.reduce((a,b)=>a+b,0)/reactTimes.length)+'ms';reactState='idle';setTimeout(reactNext,1000)}}

// ===== GAME 6: WORD =====
let wordScore,wordTime,wordWords,wordFound,wordSel,wordDragging,wordGridData;
const WORD_CATS=[
  {name:'🍎 과일',words:['사과','포도','수박','딸기','참외','감귤','복숭아','자두','앵두','키위']},
  {name:'🌊 자연',words:['바다','하늘','구름','태양','달빛','별빛','노을','안개','번개','폭풍']},
  {name:'💖 감정',words:['사랑','행복','희망','용기','자유','평화','진실','믿음','지혜','열정']},
  {name:'🐯 동물',words:['호랑이','토끼','사슴','고래','거북','여우','늑대','다람쥐','펭귄','독수리']},
  {name:'🎨 예술',words:['노래','음악','그림','연극','영화','소설','무용','조각','시인','작곡']},
  {name:'🏙️ 도시',words:['서울','부산','대구','인천','광주','대전','제주','울산','수원','춘천']},
  {name:'👨‍⚕️ 직업',words:['의사','교사','화가','작가','군인','경찰','기사','판사','약사','목사']},
  {name:'🎵 악기',words:['피아노','기타','드럼','첼로','하프','비올라','오보에','플루트','호른','벨']},
  {name:'🌸 계절',words:['여름','가을','겨울','장마','폭설','서리','이슬','태풍','벚꽃','단풍']},
  {name:'🐱 반려',words:['고양이','강아지','햄스터','앵무새','금붕어','거미','개미','나비','매미','두꺼비']}
];
const FILLER='가나다라마바사아자차카타파하거너더러머버서어저커터퍼허고노도로모보소오조코토포호구누두루무부수우주쿠투푸후기니디리미비시이지키티피히갈날달말발살알잘칼탈팔할감남담람밤삼암잠참탐팜함'.split('');
function genWordGrid(){const sz=6,grid=Array(sz*sz).fill(''),dirs=[[0,1],[1,0],[1,1],[-1,1],[0,-1],[-1,0]];
const cat=WORD_CATS[~~(Math.random()*WORD_CATS.length)];
const pool=[...cat.words].filter(w=>w.length<=sz).sort(()=>Math.random()-.5),placed=[];
for(const w of pool){if(placed.length>=5)break;const chars=w.split(''),len=chars.length;
let ok=false;for(let t=0;t<60&&!ok;t++){const d=dirs[~~(Math.random()*dirs.length)];
const minR=Math.max(0,d[0]<0?len-1:0),maxR=Math.min(sz-1,d[0]>0?sz-len:sz-1);
const minC=Math.max(0,d[1]<0?len-1:0),maxC=Math.min(sz-1,d[1]>0?sz-len:sz-1);
if(minR>maxR||minC>maxC)continue;
const r0=minR+~~(Math.random()*(maxR-minR+1)),c0=minC+~~(Math.random()*(maxC-minC+1));
let fit=true;for(let i=0;i<len;i++){const r=r0+d[0]*i,c=c0+d[1]*i;if(r<0||r>=sz||c<0||c>=sz){fit=false;break}const idx=r*sz+c;if(grid[idx]!==''&&grid[idx]!==chars[i]){fit=false;break}}
if(fit){for(let i=0;i<len;i++){grid[(r0+d[0]*i)*sz+(c0+d[1]*i)]=chars[i]}placed.push(w);ok=true}}
}
for(let i=0;i<grid.length;i++)if(grid[i]==='')grid[i]=FILLER[~~(Math.random()*FILLER.length)];
return{words:placed,grid,catName:cat.name}}
function initWord(){wordScore=0;wordTime=30;wordFound=[];wordSel=[];wordDragging=false;document.getElementById('word-score').textContent='0점';document.getElementById('word-timer').textContent='30s';document.getElementById('word-timer').className='g-timer';const set=genWordGrid();wordWords=[...set.words];wordGridData=[...set.grid];document.getElementById('word-cat').textContent=set.catName+' — '+wordWords.length+'개 숨김';renderWordBoard();renderWordList();clearInterval(curTimer);curTimer=setInterval(()=>{wordTime--;document.getElementById('word-timer').textContent=wordTime+'s';if(wordTime<=10)document.getElementById('word-timer').className='g-timer urgent';if(wordTime<=0){clearInterval(curTimer);showResult(wordScore,'단어 찾기',[{val:wordFound.length+'/'+wordWords.length,label:'찾은 단어'}])}},1000)}
function renderWordBoard(){document.getElementById('word-board').innerHTML=wordGridData.map((ch,i)=>`<div class="wc" data-i="${i}" ontouchstart="wordTS(${i},event)" ontouchmove="wordTM(event)" ontouchend="wordTE()" onmousedown="wordMD(${i})" onmouseover="wordMO(${i})" onmouseup="wordMU()">${ch}</div>`).join('')}
function renderWordList(){document.getElementById('word-list').innerHTML=wordWords.map(w=>{if(wordFound.includes(w))return`<span class="wl-item found">${w}</span>`;return`<span class="wl-item" style="color:transparent;background:var(--border);border-radius:6px">${'●'.repeat(w.length)}</span>`}).join('')}
function wordTS(i,e){e.preventDefault();wordDragging=true;wordSel=[i];updWS()}function wordTM(e){if(!wordDragging)return;e.preventDefault();const t=e.touches[0];const el=document.elementFromPoint(t.clientX,t.clientY);if(el?.dataset.i!==undefined){const i=+el.dataset.i;if(!wordSel.includes(i)){wordSel.push(i);updWS()}}}function wordTE(){wordDragging=false;chkW()}function wordMD(i){wordDragging=true;wordSel=[i];updWS()}function wordMO(i){if(wordDragging&&!wordSel.includes(i)){wordSel.push(i);updWS()}}function wordMU(){wordDragging=false;chkW()}
function updWS(){document.querySelectorAll('.wc').forEach(c=>c.classList.remove('selected'));wordSel.forEach(i=>document.querySelector(`.wc[data-i="${i}"]`)?.classList.add('selected'))}
function chkW(){const fwd=wordSel.map(i=>wordGridData[i]).join('');const rev=wordSel.slice().reverse().map(i=>wordGridData[i]).join('');const word=wordWords.includes(fwd)?fwd:wordWords.includes(rev)?rev:null;if(word&&!wordFound.includes(word)){wordFound.push(word);wordScore+=20;setScore('word-score',wordScore);wordSel.forEach(i=>document.querySelector(`.wc[data-i="${i}"]`)?.classList.add('found'));renderWordList();toast('✓ '+word);if(wordFound.length===wordWords.length){wordScore+=Math.max(0,wordTime*2);clearInterval(curTimer);setTimeout(()=>showResult(wordScore,'단어 찾기',[{val:wordFound.length+'/'+wordWords.length,label:'찾은 단어'}]),500)}}wordSel=[];updWS()}

// ===== GAME 7: PATTERN =====
let patScore,patRound,patMaxCombo,patCombo;
const PAT_TYPES=[()=>{const s=~~(Math.random()*5)+1,st=~~(Math.random()*3)+1,seq=[];for(let i=0;i<5;i++)seq.push(s+st*i);const a=seq.pop();return{seq:seq.map(String),answer:String(a),opts:genOpts(a,4).map(String),explain:'등차수열: +'+st+'씩 증가'}},()=>{const e=['A','B','C','D','E'],a=e[~~(Math.random()*5)];let b;do{b=e[~~(Math.random()*5)]}while(b===a);return{seq:[a,b,a,b],answer:a,opts:[a,b,e[~~(Math.random()*5)]].filter((v,i,ar)=>ar.indexOf(v)===i).concat(e[~~(Math.random()*5)]).slice(0,4).sort(()=>Math.random()-.5),explain:'반복 패턴: '+a+', '+b+' 교대 반복'}},()=>{const a=~~(Math.random()*3)+1,b=~~(Math.random()*3)+2;return{seq:[a,b,a+b,b+a+b].map(String),answer:String(a+b+b+a+b),opts:genOpts(a+b+b+a+b,4).map(String),explain:'피보나치: 앞 두 수의 합 ('+b+'+'+(a+b)+'='+(a+b+b)+', '+(a+b)+'+'+(b+a+b)+'='+(a+b+b+a+b)+')'}},()=>({seq:['1','4','9','16'],answer:'25',opts:genOpts(25,4).map(String),explain:'제곱수: 1², 2², 3², 4², 5²=25'}),()=>{const s=~~(Math.random()*3)+1;return{seq:[s,s*2,s*4,s*8].map(String),answer:String(s*16),opts:genOpts(s*16,4).map(String),explain:'×2 패턴: 매번 2배씩 증가'}},()=>({seq:['○','●','○','●'],answer:'○',opts:['○','●','◇','◆'].sort(()=>Math.random()-.5),explain:'교대 패턴: ○● 반복'}),()=>({seq:['R','O','Y','G'],answer:'B',opts:['B','V','K','W'].sort(()=>Math.random()-.5),explain:'무지개 순서: R→O→Y→G→B(lue)'})];
function genOpts(a,c){const o=[a];while(o.length<c){const v=a+~~(Math.random()*10)-5;if(v!==a&&v>0&&!o.includes(v))o.push(v)}return o.sort(()=>Math.random()-.5)}
let patTime;
function initPattern(){patScore=0;patRound=0;patCombo=0;patMaxCombo=0;patTime=30;document.getElementById('pat-score').textContent='0점';initHearts('pat');
document.getElementById('pat-round').textContent='30s';
clearInterval(curTimer);curTimer=setInterval(()=>{patTime--;document.getElementById('pat-round').textContent=patTime+'s';
if(patTime<=10)document.getElementById('pat-round').className='g-timer urgent';
if(patTime<=0){clearInterval(curTimer);showResult(patScore,'패턴 완성',[{val:patMaxCombo+'x',label:'최대 콤보'}])}},1000);patNext()}
let patExplain='';
function patNext(){patRound++;const g=PAT_TYPES[~~(Math.random()*PAT_TYPES.length)]();patExplain=g.explain||'';document.getElementById('pat-seq').innerHTML=g.seq.map(s=>`<div class="pat-item">${s}</div>`).join('')+'<div class="pat-item q">?</div>';document.getElementById('pat-opts').innerHTML=g.opts.map(o=>`<div class="pat-opt" onclick="patPick(this,'${o}','${g.answer}')">${o}</div>`).join('')}
function patPick(el,p,a){if(el.classList.contains('ok')||el.classList.contains('no'))return;document.querySelector('.pat-item.q').textContent=a;document.querySelector('.pat-item.q').classList.remove('q');if(p===a){el.classList.add('ok');patCombo++;patMaxCombo=Math.max(patMaxCombo,patCombo);patScore+=10*(1+~~(patCombo/3));setScore('pat-score',patScore);toast(patCombo>=3?''+patCombo+'콤보! — '+patExplain:'✓ '+patExplain)}else{el.classList.add('no');patCombo=0;document.querySelectorAll('.pat-opt').forEach(o=>{if(o.textContent===a)o.classList.add('ok')});toast('→ '+patExplain);curScore=patScore;if(loseHeart('pat'))return}setTimeout(patNext,1200)}

// ===== GAME 8: FOCUS =====
let focusScore,focusTime,focusHit,focusMiss,focusSpawnTimer;
function initFocus(){focusScore=0;focusTime=30;focusHit=0;focusMiss=0;document.getElementById('focus-score').textContent='0점';document.getElementById('focus-timer').textContent='30s';document.getElementById('focus-timer').className='g-timer';document.getElementById('focus-field').innerHTML='';clearInterval(curTimer);clearInterval(focusSpawnTimer);curTimer=setInterval(()=>{focusTime--;document.getElementById('focus-timer').textContent=focusTime+'s';if(focusTime<=10)document.getElementById('focus-timer').className='g-timer urgent';if(focusTime<=0){clearInterval(curTimer);clearInterval(focusSpawnTimer);showResult(focusScore,'집중력 탭',[{val:focusHit,label:'명중'},{val:focusMiss,label:'실수'}])}},1000);focusSpawnTimer=setInterval(spawnTarget,800);spawnTarget();spawnTarget()}
function spawnTarget(){const f=document.getElementById('focus-field'),r=f.getBoundingClientRect();if(!r.width)return;
const elapsed=30-focusTime;const difficulty=Math.min(elapsed/30,1);
const el=document.createElement('div');const rnd=Math.random(),type=rnd<.55?'good':rnd<(.55+.3+difficulty*.1)?'bad':'bonus';
el.className='focus-target '+type;
// Same color, different symbols - harder to distinguish
const symbols={good:'○',bad:'×',bonus:'◎'};
el.textContent=symbols[type];el.style.color='#fff';el.style.fontSize='20px';
// Shrink size as difficulty increases
const size=48-~~(difficulty*12);el.style.width=size+'px';el.style.height=size+'px';
el.style.left=~~(Math.random()*(r.width-size-8))+'px';el.style.top=~~(Math.random()*(r.height-size-8))+'px';
el.onclick=()=>{if(type==='good'){focusScore+=10;focusHit++}else if(type==='bonus'){focusScore+=30;focusHit++;toast('◎ 보너스!')}else{focusScore=Math.max(0,focusScore-5);focusMiss++}el.style.transform='scale(0)';setTimeout(()=>el.remove(),150);setScore('focus-score',focusScore)};
f.appendChild(el);
// Disappear faster as time progresses
const lifespan=type==='bonus'?1200:(2200-~~(difficulty*1000));
setTimeout(()=>{if(el.parentNode){if(type==='good')focusMiss++;el.style.opacity='0';setTimeout(()=>el.remove(),200)}},lifespan);
// Speed up spawn rate
clearInterval(focusSpawnTimer);focusSpawnTimer=setInterval(spawnTarget,Math.max(400,750-~~(difficulty*350)))}

// ===== GAME 9: ROTATE =====
let rotScore,rotRound;
let rotTime;
function initRotate(){rotScore=0;rotRound=0;rotTime=30;initHearts('rot');
document.getElementById('rot-round').textContent='30s';
clearInterval(curTimer);curTimer=setInterval(()=>{rotTime--;document.getElementById('rot-round').textContent=rotTime+'s';
if(rotTime<=10)document.getElementById('rot-round').className='g-timer urgent';
if(rotTime<=0){clearInterval(curTimer);showResult(rotScore,'도형 회전',[])}},1000);rotNext()}
function rotNext(){rotRound++;setScore('rot-score',rotScore);const shape=[],bc=~~(Math.random()*3)+3;while(shape.length<bc){const x=~~(Math.random()*4),y=~~(Math.random()*4);if(!shape.some(b=>b.x===x&&b.y===y))shape.push({x,y})}const colors=['#3182F6','#8B5CF6','#EC4899','#F59E0B','#10B981'],color=colors[~~(Math.random()*colors.length)];document.getElementById('rot-original').innerHTML='';document.getElementById('rot-original').appendChild(drawShape(shape,color,100));const rots=[0,90,180,270],cr=rots[~~(Math.random()*3)+1],cs=rotShape(shape,cr),ms=shape.map(b=>({x:3-b.x,y:b.y}));let opts=[{shape:cs,correct:true},{shape:rotShape(ms,cr),correct:false}];const or=rots.filter(r=>r!==cr&&r!==0)[0]||90;opts.push({shape:rotShape(shape,or===cr?180:or),correct:false},{shape:rotShape(ms,or),correct:false});opts=opts.slice(0,4).sort(()=>Math.random()-.5);const od=document.getElementById('rot-opts');od.innerHTML='';opts.forEach(o=>{const w=document.createElement('div');w.className='rotate-opt';w.appendChild(drawShape(o.shape,color,70));w.onclick=()=>{if(w.classList.contains('ok')||w.classList.contains('no'))return;if(o.correct){w.classList.add('ok');rotScore+=10;setScore('rot-score',rotScore)}else{w.classList.add('no');od.querySelectorAll('.rotate-opt').forEach((el,j)=>{if(opts[j].correct)el.classList.add('ok')});curScore=rotScore;if(loseHeart('rot'))return}setTimeout(rotNext,800)};od.appendChild(w)});document.getElementById('rot-q').textContent=`이 도형을 ${cr}° 회전하면?`}
function drawShape(bl,c,s){const cv=document.createElement('canvas');cv.width=s;cv.height=s;const ctx=cv.getContext('2d'),bs=s/4;bl.forEach(b=>{ctx.fillStyle=c;ctx.beginPath();ctx.roundRect(b.x*bs+2,b.y*bs+2,bs-4,bs-4,4);ctx.fill()});return cv}
function rotShape(bl,d){const t=((d%360)+360)%360/90;let b=bl.map(x=>({...x}));for(let i=0;i<t;i++)b=b.map(x=>({x:3-x.y,y:x.x}));return b}

// ===== GAME 10: REVERSE =====
let revLv,revScore,revSeq,revInput,revShowing;
function initReverse(){revLv=1;revScore=0;revShowing=false;document.getElementById('rev-score').textContent='0점';document.getElementById('rev-level').textContent='Lv.1';initHearts('rev');revNew()}
function revNew(){revShowing=true;revInput=[];const len=revLv+2;revSeq=[];for(let i=0;i<len;i++)revSeq.push(~~(Math.random()*10));document.getElementById('rev-msg').textContent='숫자를 기억하세요!';document.getElementById('rev-input').innerHTML='';const d=document.getElementById('rev-display');d.innerHTML=revSeq.map(()=>'<div class="rev-num hidden">?</div>').join('');let i=0;const iv=setInterval(()=>{if(i>0&&d.children[i-1]){d.children[i-1].classList.add('hidden');d.children[i-1].textContent='?'}if(i<revSeq.length){d.children[i].classList.remove('hidden');d.children[i].textContent=revSeq[i];i++}else{clearInterval(iv);d.querySelectorAll('.rev-num').forEach(n=>{n.classList.add('hidden');n.textContent='?'});revShowing=false;document.getElementById('rev-msg').textContent='거꾸로 입력하세요!';document.getElementById('rev-input').innerHTML=revSeq.map(()=>'<div class="rev-slot"></div>').join('')}},800)}
function revPress(n){if(revShowing)return;const s=document.querySelectorAll('.rev-slot:not(.filled)');if(!s.length)return;s[0].textContent=n;s[0].classList.add('filled');revInput.push(n)}
function revDel(){if(revShowing||!revInput.length)return;revInput.pop();const f=document.querySelectorAll('.rev-slot.filled');if(f.length){const l=f[f.length-1];l.textContent='';l.classList.remove('filled')}}
function revSubmit(){if(revShowing||revInput.length!==revSeq.length)return;const rev=[...revSeq].reverse(),ok=revInput.every((n,i)=>n===rev[i]);document.querySelectorAll('.rev-slot').forEach((s,i)=>{s.classList.add(revInput[i]===rev[i]?'ok':'no')});if(ok){revLv++;revScore+=revLv*5;setScore('rev-score',revScore);document.getElementById('rev-level').textContent='Lv.'+revLv;toast('✓ 정답!');setTimeout(revNew,800)}else{curScore=revScore;if(loseHeart('rev'))return;setTimeout(revNew,800)}}

// ===== 11. NUMBER TOUCH =====
let ntNext,ntStart,ntTimer;
function initNumtouch(){ntNext=1;ntStart=null;ntTimer=null;document.getElementById('nt-score').textContent='0점';document.getElementById('nt-timer').textContent='0.0s';document.getElementById('nt-msg').textContent='1부터 순서대로 터치!';
const nums=Array.from({length:25},(_,i)=>i+1).sort(()=>Math.random()-.5);
document.getElementById('nt-grid').innerHTML=nums.map(n=>`<div class="nt-cell" onclick="ntTap(this,${n})">${n}</div>`).join('')}
function ntTap(el,n){if(n!==ntNext)return;if(!ntStart){ntStart=Date.now();ntTimer=setInterval(()=>{document.getElementById('nt-timer').textContent=((Date.now()-ntStart)/1000).toFixed(1)+'s'},100)}
el.classList.add('done');el.textContent='✓';ntNext++;
if(ntNext>25){clearInterval(ntTimer);const t=((Date.now()-ntStart)/1000).toFixed(1);const score=Math.max(0,Math.round(500-parseFloat(t)*8));setScore('nt-score',score);
showResult(score,'넘버 터치',[{val:t+'초',label:'소요 시간'}])}}

// ===== 12. RHYTHM MEMORY =====
let rhySeq,rhyIdx,rhyLv,rhyScore,rhyShowing;
let rhyCtx;
const RHY_FREQ=[262,330,392,523];// C4,E4,G4,C5
function rhyBeep(padIdx){
if(!rhyCtx)rhyCtx=new(window.AudioContext||window.webkitAudioContext)();
const o=rhyCtx.createOscillator(),g=rhyCtx.createGain();
o.type='sine';o.frequency.value=RHY_FREQ[padIdx];
g.gain.setValueAtTime(.3,rhyCtx.currentTime);g.gain.exponentialRampToValueAtTime(.01,rhyCtx.currentTime+.3);
o.connect(g);g.connect(rhyCtx.destination);o.start();o.stop(rhyCtx.currentTime+.3)}
function initRhythm(){rhyLv=1;rhyScore=0;rhyShowing=false;document.getElementById('rhy-score').textContent='0점';document.getElementById('rhy-level').textContent='Lv.1';initHearts('rhy');rhyNewRound()}
function rhyNewRound(){rhyShowing=true;rhyIdx=0;const len=rhyLv+2;rhySeq=Array.from({length:len},()=>~~(Math.random()*4));
document.getElementById('rhy-msg').textContent='패턴을 기억하세요!';
let i=0;const iv=setInterval(()=>{document.querySelectorAll('.rhy-pad').forEach(p=>p.classList.remove('lit'));
if(i<rhySeq.length){document.querySelector(`.rhy-pad[data-p="${rhySeq[i]}"]`).classList.add('lit');rhyBeep(rhySeq[i]);i++}else{clearInterval(iv);rhyShowing=false;document.getElementById('rhy-msg').textContent='같은 순서로 터치!'}},600)}
function rhyTap(p){if(rhyShowing)return;const pad=document.querySelector(`.rhy-pad[data-p="${p}"]`);pad.classList.add('lit');rhyBeep(p);setTimeout(()=>pad.classList.remove('lit'),200);
if(p===rhySeq[rhyIdx]){rhyIdx++;if(rhyIdx===rhySeq.length){rhyLv++;rhyScore+=rhyLv*10;setScore('rhy-score',rhyScore);document.getElementById('rhy-level').textContent='Lv.'+rhyLv;toast('✓ 정답!');setTimeout(rhyNewRound,800)}
}else{curScore=rhyScore;if(loseHeart('rhy'))return;setTimeout(rhyNewRound,800)}}

// ===== 13. RPS =====
let rpsScore,rpsTime,rpsTotal,rpsMode,rpsCur;
const RPS_HANDS=['바위','보','가위'],RPS_NAMES=['바위','보','가위'];
function initRps(){rpsScore=0;rpsTime=30;rpsTotal=0;document.getElementById('rps-score').textContent='0점';initHearts('rps');
document.getElementById('rps-timer').textContent='30s';document.getElementById('rps-timer').className='g-timer';
clearInterval(curTimer);curTimer=setInterval(()=>{rpsTime--;document.getElementById('rps-timer').textContent=rpsTime+'s';if(rpsTime<=10)document.getElementById('rps-timer').className='g-timer urgent';if(rpsTime<=0){clearInterval(curTimer);showResult(rpsScore,'두뇌 가위바위보',[{val:rpsTotal,label:'문제 수'}])}},1000);rpsGen()}
function rpsGen(){rpsCur=~~(Math.random()*3);rpsMode=Math.random()<.5?'win':'lose';
document.getElementById('rps-enemy').textContent=RPS_HANDS[rpsCur];
document.getElementById('rps-q').textContent=rpsMode==='win'?'◆ 이기는 것을 내세요!':'💀 지는 것을 내세요!';
document.getElementById('rps-q').style.color=rpsMode==='win'?'var(--ok)':'var(--no)';
document.querySelectorAll('.rps-btn').forEach(b=>{b.className='rps-btn';b.disabled=false})}
function rpsPick(p){rpsTotal++;const win=(p-rpsCur+3)%3===1,lose=(p-rpsCur+3)%3===2;
const correct=(rpsMode==='win'&&win)||(rpsMode==='lose'&&lose);
const btns=document.querySelectorAll('.rps-btn');btns.forEach((b,i)=>b.disabled=true);
btns[p].classList.add(correct?'ok':'no');
if(correct){rpsScore+=10;setScore('rps-score',rpsScore);toast('✓ 정답!')}
else{curScore=rpsScore;if(loseHeart('rps'))return}
setTimeout(rpsGen,600)}

// ===== 14. ODD ONE =====
let oddScore,oddTime,oddLv,oddSpawnTimer2,oddQTimer,oddQTime,oddQLimit;
const ODD_PAIRS=[['뎡','경'],['곰','공'],['달','닭'],['봄','볼'],['갈','잘'],['물','뭄'],['눈','논'],['밤','밥'],['손','존'],['말','맘'],['불','붉'],['곧','곤'],['답','닫'],['살','삼'],['풀','품'],['날','낫'],['굽','굿'],['집','짓'],['감','같'],['힘','험'],['돈','든'],['별','벌'],['꿈','꿀'],['삶','삼'],['빛','빗'],['숲','술'],['맛','맞'],['꽃','꼿'],['잎','잊'],['값','갑']];
function initOddone(){oddScore=0;oddTime=30;oddLv=1;document.getElementById('odd-score').textContent='0점';document.getElementById('odd-timer').textContent='30s';document.getElementById('odd-timer').className='g-timer';initHearts('odd');
clearInterval(curTimer);curTimer=setInterval(()=>{oddTime--;document.getElementById('odd-timer').textContent=oddTime+'s';if(oddTime<=10)document.getElementById('odd-timer').className='g-timer urgent';if(oddTime<=0){clearInterval(curTimer);clearInterval(oddQTimer);showResult(oddScore,'다른 그림 찾기',[{val:oddLv-1,label:'클리어 수'}])}},1000);oddGen()}
function oddGen(){const sz=oddLv<=2?4:oddLv<=5?5:6;
document.getElementById('odd-grid').style.gridTemplateColumns=`repeat(${sz},1fr)`;
const pair=ODD_PAIRS[~~(Math.random()*ODD_PAIRS.length)];
const main=pair[0],diff=pair[1];
const total=sz*sz,pos=~~(Math.random()*total);
const fs=sz<=4?24:sz<=5?20:17;
document.getElementById('odd-grid').innerHTML=Array.from({length:total},(_,i)=>{
return`<div class="odd-cell" onclick="oddPick(this,${i},${pos})" style="font-size:${fs}px;color:var(--text)">${i===pos?diff:main}</div>`}).join('');
oddQLimit=Math.max(2.0,4.0-oddLv*0.12);oddQTime=oddQLimit;clearInterval(oddQTimer);
const oddbar=document.getElementById('odd-qbar');if(oddbar){oddbar.style.transition='none';oddbar.style.width='100%';requestAnimationFrame(()=>{oddbar.style.transition=`width ${oddQLimit}s linear`;oddbar.style.width='0%'})}
oddQTimer=setInterval(()=>{oddQTime-=0.1;if(oddQTime<=0){clearInterval(oddQTimer);curScore=oddScore;if(loseHeart('odd'))return;setTimeout(oddGen,300)}},100)}
function oddPick(el,i,ans){if(i===ans){clearInterval(oddQTimer);el.classList.add('ok');const pct=oddQTime/oddQLimit;const bonus=pct>.75?5:pct>.5?3:1;oddScore+=10+oddLv*2+bonus;oddLv++;setScore('odd-score',oddScore);setTimeout(oddGen,400)}else{el.classList.add('no');oddScore=Math.max(0,oddScore-5);setScore('odd-score',oddScore)}}

// ===== 15. COMPARE =====
let cmpScore,cmpTime,cmpTotal,cmpA,cmpB,cmpMode,cmpQTimer,cmpQTime,cmpLastMode,cmpQLimit;
function initCompare(){cmpScore=0;cmpTime=30;cmpTotal=0;cmpLastMode=null;document.getElementById('cmp-score').textContent='0점';initHearts('cmp');
document.getElementById('cmp-timer').textContent='30s';document.getElementById('cmp-timer').className='g-timer';
clearInterval(curTimer);curTimer=setInterval(()=>{cmpTime--;document.getElementById('cmp-timer').textContent=cmpTime+'s';if(cmpTime<=10)document.getElementById('cmp-timer').className='g-timer urgent';if(cmpTime<=0){clearInterval(curTimer);clearInterval(cmpQTimer);showResult(cmpScore,'크다작다',[{val:cmpTotal,label:'문제 수'}])}},1000);cmpGen()}
function cmpGen(){const d=cmpTotal<5?10:cmpTotal<10?50:cmpTotal<20?200:500;
do{cmpA=~~(Math.random()*d)+1;cmpB=~~(Math.random()*d)+1}while(cmpA===cmpB);
// 70% chance to flip mode from last (more switching)
cmpMode=(cmpLastMode&&Math.random()<.7)?(cmpLastMode==='big'?'small':'big'):(Math.random()<.5?'big':'small');
cmpLastMode=cmpMode;
document.getElementById('cmp-q').textContent=cmpMode==='big'?'큰 수를 터치!':'작은 수를 터치!';
document.getElementById('cmp-q').style.color=cmpMode==='big'?'var(--p)':'var(--no)';
document.getElementById('cmp-a').textContent=cmpA;document.getElementById('cmp-b').textContent=cmpB;
document.getElementById('cmp-a').style.opacity='1';document.getElementById('cmp-b').style.opacity='1';
// Per-question countdown: 2s → 1s gradually
cmpQLimit=Math.max(1.0, 2.0 - cmpTotal*0.05);
cmpQTime=cmpQLimit;clearInterval(cmpQTimer);
const bar=document.getElementById('cmp-qbar');if(bar){bar.style.transition='none';bar.style.width='100%';requestAnimationFrame(()=>{bar.style.transition=`width ${cmpQLimit}s linear`;bar.style.width='0%'})}
cmpQTimer=setInterval(()=>{cmpQTime-=0.1;if(cmpQTime<=0){clearInterval(cmpQTimer);cmpTotal++;curScore=cmpScore;if(loseHeart('cmp'))return;setTimeout(cmpGen,300)}},100)}
function cmpPick(choice){clearInterval(cmpQTimer);cmpTotal++;
const pickedBig=(choice==='left'&&cmpA>cmpB)||(choice==='right'&&cmpB>cmpA);
const correct=(cmpMode==='big'&&pickedBig)||(cmpMode==='small'&&!pickedBig);
const picked=choice==='left'?'cmp-a':'cmp-b',other=choice==='left'?'cmp-b':'cmp-a';
if(correct){document.getElementById(other).style.opacity='.3';const pct=cmpQTime/cmpQLimit;const bonus=pct>.75?5:pct>.5?3:1;cmpScore+=10+bonus;setScore('cmp-score',cmpScore)}
else{document.getElementById(picked).style.opacity='.3';curScore=cmpScore;if(loseHeart('cmp'))return}
setTimeout(cmpGen,400)}

// ===== 16. BULB MEMORY =====
let bulbSeq,bulbIdx,bulbLv,bulbScore,bulbShowing;
function initBulb(){bulbLv=1;bulbScore=0;bulbShowing=false;document.getElementById('bulb-score').textContent='0점';document.getElementById('bulb-level').textContent='Lv.1';initHearts('bulb');
document.getElementById('bulb-grid').innerHTML=Array.from({length:9},(_,i)=>`<div class="bulb-item" onclick="bulbTap(${i})"></div>`).join('');bulbNewRound()}
function bulbNewRound(){bulbShowing=true;bulbIdx=0;const len=bulbLv+2;bulbSeq=Array.from({length:len},()=>~~(Math.random()*9));
document.getElementById('bulb-msg').textContent='전구 순서를 기억하세요!';
const items=document.querySelectorAll('.bulb-item');items.forEach(it=>it.classList.remove('on'));
let i=0;const iv=setInterval(()=>{items.forEach(it=>it.classList.remove('on'));
if(i<bulbSeq.length){items[bulbSeq[i]].classList.add('on');i++}else{clearInterval(iv);bulbShowing=false;document.getElementById('bulb-msg').textContent='같은 순서로 터치!'}},700)}
function bulbTap(n){if(bulbShowing)return;const items=document.querySelectorAll('.bulb-item');
items[n].classList.add('on');setTimeout(()=>items[n].classList.remove('on'),300);
if(n===bulbSeq[bulbIdx]){bulbIdx++;if(bulbIdx===bulbSeq.length){bulbLv++;bulbScore+=bulbLv*10;setScore('bulb-score',bulbScore);document.getElementById('bulb-level').textContent='Lv.'+bulbLv;toast('✓ 정답!');setTimeout(bulbNewRound,800)}
}else{curScore=bulbScore;if(loseHeart('bulb'))return;setTimeout(bulbNewRound,800)}}

// ===== 17. COLOR MIX =====
let cmxScore,cmxRound,cmxQTimer,cmxQTime,cmxQLimit;
const CMIX=[
  {a:{name:'빨강',hex:'#F04452'},b:{name:'파랑',hex:'#3182F6'},result:{name:'보라',hex:'#8B5CF6'},wrong:[{name:'초록',hex:'#1FC58E'},{name:'주황',hex:'#F97316'},{name:'갈색',hex:'#92400E'}]},
  {a:{name:'빨강',hex:'#F04452'},b:{name:'노랑',hex:'#FBBF24'},result:{name:'주황',hex:'#F97316'},wrong:[{name:'초록',hex:'#1FC58E'},{name:'보라',hex:'#8B5CF6'},{name:'갈색',hex:'#92400E'}]},
  {a:{name:'파랑',hex:'#3182F6'},b:{name:'노랑',hex:'#FBBF24'},result:{name:'초록',hex:'#1FC58E'},wrong:[{name:'보라',hex:'#8B5CF6'},{name:'주황',hex:'#F97316'},{name:'갈색',hex:'#92400E'}]},
  {a:{name:'빨강',hex:'#F04452'},b:{name:'초록',hex:'#1FC58E'},result:{name:'갈색',hex:'#92400E'},wrong:[{name:'보라',hex:'#8B5CF6'},{name:'주황',hex:'#F97316'},{name:'노랑',hex:'#FBBF24'}]},
  {a:{name:'빨강',hex:'#F04452'},b:{name:'흰색',hex:'#E5E5E5'},result:{name:'분홍',hex:'#FB7185'},wrong:[{name:'보라',hex:'#8B5CF6'},{name:'주황',hex:'#F97316'},{name:'갈색',hex:'#92400E'}]},
  {a:{name:'파랑',hex:'#3182F6'},b:{name:'흰색',hex:'#E5E5E5'},result:{name:'하늘',hex:'#7DD3FC'},wrong:[{name:'초록',hex:'#1FC58E'},{name:'보라',hex:'#8B5CF6'},{name:'분홍',hex:'#FB7185'}]},
  {a:{name:'검정',hex:'#333'},b:{name:'흰색',hex:'#E5E5E5'},result:{name:'회색',hex:'#9CA3AF'},wrong:[{name:'갈색',hex:'#92400E'},{name:'보라',hex:'#8B5CF6'},{name:'하늘',hex:'#7DD3FC'}]},
];
let cmxTime;
function initColormix(){cmxScore=0;cmxRound=0;cmxTime=30;document.getElementById('cmx-score').textContent='0점';initHearts('cmx');
document.getElementById('cmx-round').textContent='30s';
clearInterval(curTimer);curTimer=setInterval(()=>{cmxTime--;document.getElementById('cmx-round').textContent=cmxTime+'s';
if(cmxTime<=10)document.getElementById('cmx-round').className='g-timer urgent';
if(cmxTime<=0){clearInterval(curTimer);clearInterval(cmxQTimer);showResult(cmxScore,'색깔 조합',[])}},1000);cmxNext()}
function cmxNext(){cmxRound++;
document.getElementById('cmx-round').textContent=cmxRound+'/10';
const q=CMIX[~~(Math.random()*CMIX.length)];
const chip=(c,sz=40)=>`<span style="display:inline-block;width:${sz}px;height:${sz}px;border-radius:50%;background:${c.hex};vertical-align:middle;box-shadow:0 2px 6px ${c.hex}44"></span>`;
document.getElementById('cmx-q').innerHTML=`<div style="display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:8px">${chip(q.a,48)}<span style="font-size:28px;font-weight:800;color:var(--sub)">+</span>${chip(q.b,48)}</div><div style="font-size:15px;color:var(--sub)">${q.a.name} + ${q.b.name} = ?</div>`;
const opts=[q.result,...q.wrong.sort(()=>Math.random()-.5).slice(0,3)].sort(()=>Math.random()-.5);
document.getElementById('cmx-opts').innerHTML=opts.map(o=>`<div class="cmx-opt" data-name="${o.name}" onclick="cmxPick(this,'${o.name}','${q.result.name}')" style="background:var(--card)"><div>${chip(o,36)}</div><div style="font-size:13px;margin-top:6px;font-weight:600">${o.name}</div></div>`).join('');
cmxQLimit=Math.max(2.0,4.0-cmxRound*0.12);cmxQTime=cmxQLimit;clearInterval(cmxQTimer);
const cmxbar=document.getElementById('cmx-qbar');if(cmxbar){cmxbar.style.transition='none';cmxbar.style.width='100%';requestAnimationFrame(()=>{cmxbar.style.transition=`width ${cmxQLimit}s linear`;cmxbar.style.width='0%'})}
cmxQTimer=setInterval(()=>{cmxQTime-=0.1;if(cmxQTime<=0){clearInterval(cmxQTimer);curScore=cmxScore;if(loseHeart('cmx'))return;setTimeout(cmxNext,300)}},100)}
function cmxPick(el,picked,answer){if(el.classList.contains('ok')||el.classList.contains('no'))return;clearInterval(cmxQTimer);
if(picked===answer){el.classList.add('ok');const pct=cmxQTime/cmxQLimit;const bonus=pct>.75?5:pct>.5?3:1;cmxScore+=10+bonus;setScore('cmx-score',cmxScore)}
else{el.classList.add('no');document.querySelectorAll('.cmx-opt').forEach(o=>{if(o.dataset.name===answer)o.classList.add('ok')});curScore=cmxScore;if(loseHeart('cmx'))return}
setTimeout(cmxNext,800)}

// ===== 18. WORD COMPLETE =====
let wcScore,wcTime,wcTotal,wcQTimer,wcQTime,wcQLimit;
const WC_DB=[
  {word:'사__',full:'사과',hint:'빨간 과일',opts:['과','랑','람','울']},
  {word:'행_',full:'행복',hint:'기쁜 감정',opts:['복','운','사','동']},
  {word:'_늘',full:'하늘',hint:'머리 위에',opts:['하','바','그','저']},
  {word:'_다',full:'바다',hint:'넓고 푸른',opts:['바','나','아','가']},
  {word:'사_',full:'사랑',hint:'♥ 감정',opts:['랑','과','람','진']},
  {word:'_교',full:'학교',hint:'배우는 곳',opts:['학','교','성','사']},
  {word:'_화',full:'영화',hint:'극장에서 보는',opts:['영','전','문','동']},
  {word:'음_',full:'음악',hint:'🎵 소리 예술',opts:['악','식','료','산']},
  {word:'_구',full:'친구',hint:'함께 노는 사이',opts:['친','야','축','한']},
  {word:'_물',full:'동물',hint:'🐾 생명체',opts:['동','식','음','건']},
  {word:'_험',full:'모험',hint:'새로운 도전',opts:['모','위','경','시']},
  {word:'_장',full:'시장',hint:'물건 사는 곳',opts:['시','공','광','미']},
  {word:'_방',full:'부방',hint:'잠자는 곳',opts:['침','주','부','목']},
  {word:'_기',full:'용기',hint:'두려움을 이기는',opts:['용','전','공','운']},
  {word:'자_',full:'자유',hint:'구속 없는 상태',opts:['유','연','동','리']},
  {word:'_식',full:'지식',hint:'배워서 아는 것',opts:['지','음','의','상']},
  {word:'_실',full:'진실',hint:'거짓의 반대',opts:['진','현','교','빈']},
  {word:'평_',full:'평화',hint:'☮ 전쟁 없는',opts:['화','야','일','소']},
  {word:'_상',full:'이상',hint:'꿈꾸는 모습',opts:['이','사','현','비']},
  {word:'_래',full:'미래',hint:'앞으로 올 시간',opts:['미','노','거','과']},
];
function initWordcomp(){wcScore=0;wcTime=30;wcTotal=0;document.getElementById('wc-score').textContent='0점';initHearts('wc');
document.getElementById('wc-timer').textContent='30s';document.getElementById('wc-timer').className='g-timer';
clearInterval(curTimer);curTimer=setInterval(()=>{wcTime--;document.getElementById('wc-timer').textContent=wcTime+'s';if(wcTime<=10)document.getElementById('wc-timer').className='g-timer urgent';if(wcTime<=0){clearInterval(curTimer);clearInterval(wcQTimer);showResult(wcScore,'단어 완성',[{val:wcTotal,label:'문제 수'}])}},1000);wcGen()}
function wcGen(){const q=WC_DB[~~(Math.random()*WC_DB.length)];
document.getElementById('wc-word').textContent=q.word;
document.getElementById('wc-hint').textContent='힌트: '+q.hint;
const ans=q.opts[0];const opts=[...q.opts].sort(()=>Math.random()-.5);
document.getElementById('wc-opts').innerHTML=opts.map(o=>`<div class="wc-opt" onclick="wcPick(this,'${o}','${ans}','${q.full}')">${o}</div>`).join('');
wcQLimit=Math.max(1.5,3.0-wcTotal*0.06);wcQTime=wcQLimit;clearInterval(wcQTimer);
const wcbar=document.getElementById('wc-qbar');if(wcbar){wcbar.style.transition='none';wcbar.style.width='100%';requestAnimationFrame(()=>{wcbar.style.transition=`width ${wcQLimit}s linear`;wcbar.style.width='0%'})}
wcQTimer=setInterval(()=>{wcQTime-=0.1;if(wcQTime<=0){clearInterval(wcQTimer);wcTotal++;curScore=wcScore;if(loseHeart('wc'))return;setTimeout(wcGen,300)}},100)}
function wcPick(el,picked,answer,full){if(el.classList.contains('ok')||el.classList.contains('no'))return;clearInterval(wcQTimer);wcTotal++;
if(picked===answer){el.classList.add('ok');const pct=wcQTime/wcQLimit;const bonus=pct>.75?5:pct>.5?3:1;wcScore+=10+bonus;setScore('wc-score',wcScore);document.getElementById('wc-word').textContent=full}
else{el.classList.add('no');document.querySelectorAll('.wc-opt').forEach(o=>{if(o.textContent===answer)o.classList.add('ok')});document.getElementById('wc-word').textContent=full;curScore=wcScore;if(loseHeart('wc'))return}
setTimeout(wcGen,700)}

// ===== 19. TIMING =====
let tmScore,tmRound,tmAnim,tmPos,tmTarget,tmDir;
function initTiming(){tmScore=0;tmRound=0;document.getElementById('tm-score').textContent='0점';tmNext()}
function tmNext(){tmRound++;if(tmRound>10){showResult(tmScore,'타이밍',[]);return}
document.getElementById('tm-round').textContent=tmRound+'/10';
const barW=document.getElementById('tm-btn').parentElement.querySelector('.tm-bar')?.offsetWidth||280;
const tgtW=Math.max(30,80-tmRound*5);const tgtL=~~(Math.random()*(barW-tgtW));
tmTarget={l:tgtL,r:tgtL+tgtW};
document.getElementById('tm-target').style.cssText=`left:${tgtL}px;width:${tgtW}px`;
tmPos=0;tmDir=1;const speed=2+tmRound*0.5;
document.getElementById('tm-cursor').style.left='0px';
document.getElementById('tm-msg').textContent=`${tmRound}/10 — 목표에 멈추세요!`;
cancelAnimationFrame(tmAnim);
function tick(){const bar=document.querySelector('.tm-bar');if(!bar)return;const bw=bar.offsetWidth;
tmPos+=tmDir*speed;if(tmPos>=bw||tmPos<=0)tmDir*=-1;tmPos=Math.max(0,Math.min(bw,tmPos));
document.getElementById('tm-cursor').style.left=tmPos+'px';tmAnim=requestAnimationFrame(tick)}
tmAnim=requestAnimationFrame(tick)}
function tmStop(){cancelAnimationFrame(tmAnim);
const hit=tmPos>=tmTarget.l&&tmPos<=tmTarget.r;
const dist=hit?0:Math.min(Math.abs(tmPos-tmTarget.l),Math.abs(tmPos-tmTarget.r));
const pts=hit?15:Math.max(0,10-~~(dist/10));
tmScore+=pts;setScore('tm-score',tmScore);
toast(hit?'정확!':pts>5?'근접!':'아깝!');
setTimeout(tmNext,800)}

// ===== 20. MATCH PAIR =====
let mpScore,mpTime,mpPairs,mpSel,mpMatched;
const MP_DB=[
  ['학교:배움터','산:높은 땅','강:흐르는 물','해:바다','풍:바람'],
  ['화:불','수:물','목:나무','금:쇠','토:흙'],
  ['일:하나','이:둘','삼:셋','사:넷','오:다섯'],
  ['춘:봄','하:여름','추:가을','동:겨울','야:밤'],
  ['천:하늘','지:땅','인:사람','산:뫼','해:바다'],
  ['대:크다','소:작다','장:길다','단:짧다','고:높다'],
  ['동:동쪽','서:서쪽','남:남쪽','북:북쪽','중:가운데'],
  ['생:살다','사:죽다','래:오다','거:가다','식:먹다'],
];
function initMatchpair(){mpScore=0;mpTime=30;mpMatched=[];mpSel=null;
document.getElementById('mp-score').textContent='0점';document.getElementById('mp-timer').textContent='30s';document.getElementById('mp-timer').className='g-timer';
clearInterval(curTimer);curTimer=setInterval(()=>{mpTime--;document.getElementById('mp-timer').textContent=mpTime+'s';if(mpTime<=10)document.getElementById('mp-timer').className='g-timer urgent';if(mpTime<=0){clearInterval(curTimer);showResult(mpScore,'짝 맞추기',[{val:mpMatched.length,label:'맞춘 수'}])}},1000);mpGen()}
function mpGen(){mpSel=null;mpMatched=[];const set=MP_DB[~~(Math.random()*MP_DB.length)];
mpPairs=set.map(s=>{const[k,v]=s.split(':');return{k,v}}).sort(()=>Math.random()-.5).slice(0,5);
const left=[...mpPairs].sort(()=>Math.random()-.5);
const right=[...mpPairs].sort(()=>Math.random()-.5);
document.getElementById('mp-left').innerHTML=left.map(p=>`<div class="mp-item" data-k="${p.k}" onclick="mpTap(this,'left','${p.k}')">${p.k}</div>`).join('');
document.getElementById('mp-right').innerHTML=right.map(p=>`<div class="mp-item" data-v="${p.k}" onclick="mpTap(this,'right','${p.k}')">${p.v}</div>`).join('')}
function mpTap(el,side,key){if(el.classList.contains('ok'))return;
document.querySelectorAll(`.mp-item.sel`).forEach(e=>{if(e.parentElement===el.parentElement)e.classList.remove('sel')});
el.classList.add('sel');
const otherSide=side==='left'?'right':'left';
const otherSel=document.querySelector(`#mp-${otherSide} .mp-item.sel`);
if(!otherSel)return;
const leftKey=side==='left'?key:otherSel.dataset.k;
const rightKey=side==='right'?key:otherSel.dataset.v;
if(leftKey===rightKey){el.classList.remove('sel');el.classList.add('ok');otherSel.classList.remove('sel');otherSel.classList.add('ok');
mpScore+=15;mpMatched.push(leftKey);setScore('mp-score',mpScore);toast('✓ 맞음!');
if(mpMatched.length>=5){mpScore+=Math.max(0,mpTime*2);setScore('mp-score',mpScore);setTimeout(mpGen,600)}}
else{el.classList.add('no');otherSel.classList.add('no');setTimeout(()=>{el.classList.remove('sel','no');otherSel.classList.remove('sel','no')},500)}}

// ===== 21. HEAD COUNT =====
let hcScore,hcRound,hcCount,hcAnim;
let hcTime;
function initHeadcount(){hcScore=0;hcRound=0;document.getElementById('hc-score').textContent='0점';
document.getElementById('hc-round').textContent='Lv.1';document.getElementById('hc-round').className='g-timer';
initHearts('hc');hcNext()}
const HC_CHAR='<img src="char-40.png" style="width:100%;height:100%">';
function hcNext(){hcRound++;
document.getElementById('hc-round').textContent='Lv.'+hcRound;
hcCount=0;const steps=3+Math.min(hcRound,7);const events=[];
for(let i=0;i<steps;i++){
const canExit=hcCount>0&&Math.random()<.4;
if(canExit){events.push(-1);hcCount--}else{events.push(1);hcCount++}
}
document.getElementById('hc-log').textContent='';document.getElementById('hc-opts').innerHTML='';
document.getElementById('hc-msg').textContent='지켜보세요...';
document.getElementById('hc-counter').textContent='';
const stage=document.getElementById('hc-stage');
stage.querySelectorAll('.hc-person').forEach(p=>p.remove());
let i=0;hcAnim=setInterval(()=>{
if(i<events.length){const e=events[i];const p=document.createElement('div');
p.className='hc-person';p.innerHTML=HC_CHAR;
stage.appendChild(p);
if(e>0){p.classList.add('enter');document.getElementById('hc-log').textContent='입장';document.getElementById('hc-log').style.color='var(--ok)'}
else{p.classList.add('exit');document.getElementById('hc-log').textContent='퇴장';document.getElementById('hc-log').style.color='var(--no)'}
setTimeout(()=>p.remove(),750);
i++}else{clearInterval(hcAnim);
document.getElementById('hc-log').textContent='';document.getElementById('hc-msg').textContent='건물 안에 몇 명?';
document.getElementById('hc-counter').textContent='?';
const opts=[];for(let n=Math.max(0,hcCount-2);opts.length<5;n++)opts.push(n);
if(!opts.includes(hcCount))opts[~~(Math.random()*5)]=hcCount;
document.getElementById('hc-opts').innerHTML=opts.map(n=>`<div class="hc-opt" onclick="hcPick(this,${n},${hcCount})">${n}</div>`).join('')}
},900)}
function hcPick(el,n,ans){if(el.classList.contains('ok')||el.classList.contains('no'))return;
document.querySelectorAll('.hc-opt').forEach(o=>o.style.pointerEvents='none');
if(n===ans){el.classList.add('ok');hcScore+=10+hcRound*2;setScore('hc-score',hcScore);toast('정답!');setTimeout(hcNext,800)}
else{el.classList.add('no');document.querySelectorAll('.hc-opt').forEach(o=>{if(+o.textContent===ans)o.classList.add('ok')});
curScore=hcScore;if(loseHeart('hc'))return;setTimeout(hcNext,800)}}

// ===== 22. PYRAMID =====
let pyrScore,pyrRound,pyrAnswer,pyrGrid;
let pyrTime;
function initPyramid(){pyrScore=0;pyrRound=0;pyrTime=30;document.getElementById('pyr-score').textContent='0점';initHearts('pyr');
document.getElementById('pyr-round').textContent='30s';
clearInterval(curTimer);curTimer=setInterval(()=>{pyrTime--;document.getElementById('pyr-round').textContent=pyrTime+'s';
if(pyrTime<=10)document.getElementById('pyr-round').className='g-timer urgent';
if(pyrTime<=0){clearInterval(curTimer);showResult(pyrScore,'피라미드 연산',[])}},1000);pyrNext()}
function pyrNext(){pyrRound++;
document.getElementById('pyr-round').textContent=pyrRound+'/10';
const sz=pyrRound<=3?3:pyrRound<=7?4:5;
const base=Array.from({length:sz},()=>1+~~(Math.random()*(pyrRound<=3?9:pyrRound<=6?15:20)));
const rows=[base];for(let r=1;r<sz;r++){const prev=rows[r-1];rows.push(prev.slice(0,-1).map((v,i)=>v+prev[i+1]))}
rows.reverse();
const blankR=~~(Math.random()*(rows.length-1));const blankC=~~(Math.random()*rows[blankR].length);
pyrAnswer=rows[blankR][blankC];
const el=document.getElementById('pyr-grid');el.innerHTML='';
rows.forEach((row,r)=>{const rowEl=document.createElement('div');rowEl.className='pyr-row';
row.forEach((v,c)=>{const cell=document.createElement('div');
if(r===blankR&&c===blankC){cell.className='pyr-cell blank';cell.textContent='?';cell.id='pyr-blank'}
else{cell.className='pyr-cell fixed';cell.textContent=v}
rowEl.appendChild(cell)});el.appendChild(rowEl)});
const opts=new Set([pyrAnswer]);while(opts.size<4){opts.add(pyrAnswer+~~(Math.random()*7)-3)}
const optArr=[...opts].sort(()=>Math.random()-.5);
const inp=document.createElement('div');inp.className='pyr-input';
optArr.forEach(v=>{const b=document.createElement('button');b.className='pyr-btn';b.textContent=v;b.onclick=()=>pyrPick(v);inp.appendChild(b)});
el.appendChild(inp)}
function pyrPick(v){const blank=document.getElementById('pyr-blank');if(!blank)return;
blank.textContent=v;
if(v===pyrAnswer){blank.classList.remove('blank');blank.style.borderColor='var(--ok)';blank.style.background='var(--ok-bg)';
pyrScore+=10;setScore('pyr-score',pyrScore);toast('정답!')}
else{blank.style.borderColor='var(--no)';blank.style.background='var(--no-bg)';
setTimeout(()=>{blank.textContent=pyrAnswer;blank.style.borderColor='var(--ok)';blank.style.background='var(--ok-bg)'},400);
curScore=pyrScore;if(loseHeart('pyr'))return}
setTimeout(pyrNext,900)}

// ===== 23. MAX NUMBER =====
let mxScore,mxTime,mxLv,mxQTimer,mxQTime,mxQLimit;
function initMaxnum(){mxScore=0;mxTime=30;mxLv=1;document.getElementById('mx-score').textContent='0점';initHearts('mn');
document.getElementById('mx-timer').textContent='30s';document.getElementById('mx-timer').className='g-timer';
clearInterval(curTimer);curTimer=setInterval(()=>{mxTime--;document.getElementById('mx-timer').textContent=mxTime+'s';
if(mxTime<=10)document.getElementById('mx-timer').className='g-timer urgent';
if(mxTime<=0){clearInterval(curTimer);clearInterval(mxQTimer);showResult(mxScore,'수 찾기',[{val:mxLv-1,label:'클리어'}])}},1000);mxGen()}
function mxGen(){const range=mxLv<=3?50:mxLv<=6?200:999;
const nums=Array.from({length:16},()=>~~(Math.random()*range)+1);
const max=Math.max(...nums);const mode=Math.random()<.5?'max':'min';const target=mode==='max'?max:Math.min(...nums);
document.getElementById('mx-msg').textContent=mode==='max'?'가장 큰 수를 터치!':'가장 작은 수를 터치!';
document.getElementById('mx-grid').innerHTML=nums.map((n,i)=>`<div class="mx-cell" onclick="mxPick(this,${n},${target})">${n}</div>`).join('');
mxQLimit=Math.max(1.5,3.5-mxLv*0.1);mxQTime=mxQLimit;clearInterval(mxQTimer);
const mxbar=document.getElementById('mn-qbar');if(mxbar){mxbar.style.transition='none';mxbar.style.width='100%';requestAnimationFrame(()=>{mxbar.style.transition=`width ${mxQLimit}s linear`;mxbar.style.width='0%'})}
mxQTimer=setInterval(()=>{mxQTime-=0.1;if(mxQTime<=0){clearInterval(mxQTimer);curScore=mxScore;if(loseHeart('mn'))return;setTimeout(mxGen,300)}},100)}
function mxPick(el,n,target){if(n===target){clearInterval(mxQTimer);el.classList.add('ok');const pct=mxQTime/mxQLimit;const bonus=pct>.75?5:pct>.5?3:1;mxScore+=10+mxLv+bonus;mxLv++;
setScore('mx-score',mxScore);setTimeout(mxGen,400)}
else{el.classList.add('no');mxScore=Math.max(0,mxScore-3);setScore('mx-score',mxScore)}}

// ===== 24. SIGN FINDER =====
let sfScore,sfTime,sfTotal,sfQTimer,sfQTime,sfQLimit;
function initSignfind(){sfScore=0;sfTime=30;sfTotal=0;document.getElementById('sf-score').textContent='0점';initHearts('sf');
document.getElementById('sf-timer').textContent='30s';document.getElementById('sf-timer').className='g-timer';
clearInterval(curTimer);curTimer=setInterval(()=>{sfTime--;document.getElementById('sf-timer').textContent=sfTime+'s';
if(sfTime<=10)document.getElementById('sf-timer').className='g-timer urgent';
if(sfTime<=0){clearInterval(curTimer);clearInterval(sfQTimer);showResult(sfScore,'부호 찾기',[{val:sfTotal,label:'문제 수'}])}},1000);sfGen()}
function sfGen(){const ops=['+','-','×','÷'];const op=ops[~~(Math.random()*4)];
const range=sfTotal<5?20:sfTotal<10?50:99;
let a,b,r;
if(op==='+'){a=1+~~(Math.random()*range);b=1+~~(Math.random()*range);r=a+b}
else if(op==='-'){a=2+~~(Math.random()*range);b=1+~~(Math.random()*a);r=a-b}
else if(op==='×'){const mx=sfTotal<5?9:12;a=2+~~(Math.random()*mx);b=2+~~(Math.random()*mx);r=a*b}
else{const mx=sfTotal<5?9:12;b=2+~~(Math.random()*mx);r=2+~~(Math.random()*mx);a=b*r}
document.getElementById('sf-eq').textContent=a+' ? '+b+' = '+r;
document.getElementById('sf-opts').innerHTML=ops.map(o=>`<div class="sf-opt" onclick="sfPick(this,'${o}','${op}')">${o}</div>`).join('');
sfQLimit=Math.max(1.5,3.0-sfTotal*0.06);sfQTime=sfQLimit;clearInterval(sfQTimer);
const sfbar=document.getElementById('sf-qbar');if(sfbar){sfbar.style.transition='none';sfbar.style.width='100%';requestAnimationFrame(()=>{sfbar.style.transition=`width ${sfQLimit}s linear`;sfbar.style.width='0%'})}
sfQTimer=setInterval(()=>{sfQTime-=0.1;if(sfQTime<=0){clearInterval(sfQTimer);sfTotal++;curScore=sfScore;if(loseHeart('sf'))return;setTimeout(sfGen,300)}},100)}
function sfPick(el,picked,answer){if(el.classList.contains('ok')||el.classList.contains('no'))return;clearInterval(sfQTimer);sfTotal++;
if(picked===answer){el.classList.add('ok');const pct=sfQTime/sfQLimit;const bonus=pct>.75?5:pct>.5?3:1;sfScore+=10+bonus;setScore('sf-score',sfScore)}
else{el.classList.add('no');document.querySelectorAll('.sf-opt').forEach(o=>{if(o.textContent===answer)o.classList.add('ok')});
curScore=sfScore;if(loseHeart('sf'))return}
setTimeout(sfGen,500)}

// ===== 25. COIN COUNT =====
let ccScore,ccTime,ccTotal;
const COINS=[{val:10,color:'#B87333',label:'10'},{val:50,color:'#C0C0C0',label:'50'},{val:100,color:'#FFD700',label:'100'},{val:500,color:'#E8E8E8',label:'500'}];
function initCoincount(){ccScore=0;ccTime=30;ccTotal=0;document.getElementById('cc-score').textContent='0점';initHearts('cc');
document.getElementById('cc-timer').textContent='30s';document.getElementById('cc-timer').className='g-timer';
clearInterval(curTimer);curTimer=setInterval(()=>{ccTime--;document.getElementById('cc-timer').textContent=ccTime+'s';
if(ccTime<=10)document.getElementById('cc-timer').className='g-timer urgent';
if(ccTime<=0){clearInterval(curTimer);showResult(ccScore,'동전 세기',[{val:ccTotal,label:'문제 수'}])}},1000);ccGen()}
function ccGen(){const count=Math.min(10,3+~~(ccTotal/3)+~~(Math.random()*2));const coins=Array.from({length:count},()=>COINS[~~(Math.random()*4)]);
const total=coins.reduce((s,c)=>s+c.val,0);
document.getElementById('cc-coins').innerHTML=coins.map(c=>`<div class="cc-coin" style="background:${c.color}">${c.label}원</div>`).join('');
const opts=new Set([total]);while(opts.size<4){opts.add(total+~~(Math.random()*201)-100)}
opts.delete(total-total);if(opts.size<4)opts.add(total+50);
const optArr=[...opts].filter(v=>v>0).slice(0,4).sort(()=>Math.random()-.5);
if(!optArr.includes(total)){optArr[0]=total;optArr.sort(()=>Math.random()-.5)}
document.getElementById('cc-opts').innerHTML=optArr.map(v=>`<div class="cc-opt" onclick="ccPick(this,${v},${total})">${v}원</div>`).join('')}
function ccPick(el,v,ans){if(el.classList.contains('ok')||el.classList.contains('no'))return;ccTotal++;
if(v===ans){el.classList.add('ok');ccScore+=10;setScore('cc-score',ccScore);toast('정답!')}
else{el.classList.add('no');document.querySelectorAll('.cc-opt').forEach(o=>{if(o.textContent===ans+'원')o.classList.add('ok')});
curScore=ccScore;if(loseHeart('cc'))return}
setTimeout(ccGen,700)}

// ===== 26. CLOCK =====
let clkScore,clkRound,clkTime,clkQTimer,clkQTime,clkQLimit;
function initClock(){clkScore=0;clkRound=0;clkTime=30;document.getElementById('clk-score').textContent='0점';initHearts('clk');
document.getElementById('clk-round').textContent='30s';document.getElementById('clk-round').className='g-timer';
clearInterval(curTimer);curTimer=setInterval(()=>{clkTime--;document.getElementById('clk-round').textContent=clkTime+'s';
if(clkTime<=10)document.getElementById('clk-round').className='g-timer urgent';
if(clkTime<=0){clearInterval(curTimer);clearInterval(clkQTimer);showResult(clkScore,'시계 읽기',[])}},1000);clkNext()}
function clkNext(){clkRound++;
const h=~~(Math.random()*12)+1,m=[0,5,10,15,20,25,30,35,40,45,50,55][~~(Math.random()*12)];
const cv=document.getElementById('clk-canvas'),ctx=cv.getContext('2d'),cx=120,cy=120,r=95;
ctx.clearRect(0,0,240,240);
ctx.beginPath();ctx.arc(cx,cy,r,0,Math.PI*2);ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--card').trim()||'#fff';ctx.fill();ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--border').trim()||'#ddd';ctx.lineWidth=3;ctx.stroke();
for(let i=1;i<=12;i++){const a=(i/12)*Math.PI*2-Math.PI/2;ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--text').trim()||'#333';ctx.font='bold 16px Pretendard,sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(i,cx+Math.cos(a)*75,cy+Math.sin(a)*75)}
for(let i=0;i<60;i++){const a=(i/60)*Math.PI*2;const inner=i%5===0?82:87;ctx.beginPath();ctx.moveTo(cx+Math.cos(a)*inner,cy+Math.sin(a)*inner);ctx.lineTo(cx+Math.cos(a)*90,cy+Math.sin(a)*90);ctx.strokeStyle=i%5===0?'var(--text,#333)':'var(--border,#ccc)';ctx.lineWidth=i%5===0?2:1;ctx.stroke()}
const ha=(h%12+m/60)/12*Math.PI*2-Math.PI/2;ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(cx+Math.cos(ha)*50,cy+Math.sin(ha)*50);ctx.strokeStyle='var(--text,#333)';ctx.lineWidth=4;ctx.lineCap='round';ctx.stroke();
const ma=m/60*Math.PI*2-Math.PI/2;ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(cx+Math.cos(ma)*70,cy+Math.sin(ma)*70);ctx.strokeStyle='var(--p,#3182F6)';ctx.lineWidth=3;ctx.stroke();
ctx.beginPath();ctx.arc(cx,cy,4,0,Math.PI*2);ctx.fillStyle='var(--text,#333)';ctx.fill();
const answer=h+':'+(m<10?'0':'')+m;const opts=new Set([answer]);
while(opts.size<4){const rh=~~(Math.random()*12)+1,rm=[0,5,10,15,20,25,30,35,40,45,50,55][~~(Math.random()*12)];opts.add(rh+':'+(rm<10?'0':'')+rm)}
document.getElementById('clk-opts').innerHTML=[...opts].sort(()=>Math.random()-.5).map(o=>`<div class="clk-opt" onclick="clkPick(this,'${o}','${answer}')">${o}</div>`).join('');
// Per-round timer: 5s → 2.5s
clkQLimit=Math.max(2.5, 5.0 - clkRound*0.15);
clkQTime=clkQLimit;clearInterval(clkQTimer);
const qbar=document.getElementById('clk-qbar');if(qbar){qbar.style.transition='none';qbar.style.width='100%';requestAnimationFrame(()=>{qbar.style.transition=`width ${clkQLimit}s linear`;qbar.style.width='0%'})}
clkQTimer=setInterval(()=>{clkQTime-=0.1;if(clkQTime<=0){clearInterval(clkQTimer);curScore=clkScore;if(loseHeart('clk'))return;setTimeout(clkNext,300)}},100)}
function clkPick(el,v,ans){if(el.classList.contains('ok')||el.classList.contains('no'))return;
clearInterval(clkQTimer);
if(v===ans){el.classList.add('ok');const pct=clkQTime/clkQLimit;const bonus=pct>.75?5:pct>.5?3:1;clkScore+=10+bonus;setScore('clk-score',clkScore)}
else{el.classList.add('no');document.querySelectorAll('.clk-opt').forEach(o=>{if(o.textContent===ans)o.classList.add('ok')});
curScore=clkScore;if(loseHeart('clk'))return}
setTimeout(clkNext,800)}

// ===== 27. WORD MEMORY =====
let wmScore,wmLv,wmWords,wmShowing;
const WM_POOL=['사과','바나나','포도','수박','딸기','오렌지','복숭아','키위','멜론','체리','자두','감','귤','배','밤','호두','잣','살구','망고','파인애플',
'강아지','고양이','토끼','거북이','사자','호랑이','코끼리','기린','펭귄','독수리','돌고래','나비','잠자리','벌','개미','다람쥐','여우','늑대','곰','원숭이',
'학교','병원','공원','시장','도서관','미술관','극장','식당','카페','서점','은행','약국','우체국','경찰서','소방서','공항','기차역','항구','놀이터','수영장'];
function initWordmem(){wmScore=0;wmLv=1;wmShowing=false;document.getElementById('wm-score').textContent='0점';document.getElementById('wm-level').textContent='Lv.1';initHearts('wm');wmNewRound()}
function wmNewRound(){wmShowing=true;const count=wmLv+2;
wmWords=[];const pool=[...WM_POOL].sort(()=>Math.random()-.5);
for(let i=0;i<count&&i<pool.length;i++)wmWords.push(pool[i]);
document.getElementById('wm-msg').textContent='단어를 기억하세요!';
document.getElementById('wm-opts').innerHTML='';
let i=0;const display=document.getElementById('wm-display');
display.innerHTML=`<div class="wm-word">${wmWords[0]}</div>`;
const iv=setInterval(()=>{i++;if(i<wmWords.length){display.innerHTML=`<div class="wm-word">${wmWords[i]}</div>`}
else{clearInterval(iv);wmShowing=false;wmAsk()}},1200)}
let wmFound,wmTarget;
function wmAsk(){document.getElementById('wm-display').innerHTML='';
const count=wmWords.length;
const decoyCount=Math.min(count+1,WM_POOL.length-count);
const decoy=WM_POOL.filter(w=>!wmWords.includes(w)).sort(()=>Math.random()-.5).slice(0,decoyCount);
const opts=[...wmWords,...decoy].sort(()=>Math.random()-.5);
wmFound=0;wmTarget=wmWords.length;
document.getElementById('wm-msg').textContent=`있었던 단어를 모두 고르세요 (${wmFound}/${wmTarget})`;
document.getElementById('wm-opts').innerHTML=opts.map(w=>`<div class="wm-opt" onclick="wmPick(this,'${w}',${wmWords.includes(w)})">${w}</div>`).join('')}
function wmPick(el,w,correct){if(el.classList.contains('ok')||el.classList.contains('no'))return;
if(correct){el.classList.add('ok');wmFound++;wmScore+=10;setScore('wm-score',wmScore);
document.getElementById('wm-msg').textContent=`있었던 단어를 모두 고르세요 (${wmFound}/${wmTarget})`;
if(wmFound>=wmTarget){wmLv++;wmScore+=wmLv*5;setScore('wm-score',wmScore);
document.getElementById('wm-level').textContent='Lv.'+wmLv;toast('완벽!');setTimeout(wmNewRound,800)}}
else{el.classList.add('no');curScore=wmScore;if(loseHeart('wm'))return}}

// ===== 28. BLOCK COUNT =====
let bcScore,bcRound;
let bcTime,bcTick;
function initBlockcount(){bcScore=0;bcRound=0;bcTime=30;document.getElementById('bc-score').textContent='0점';initHearts('bc');
document.getElementById('bc-round').textContent='30s';
clearInterval(bcTick);bcTick=setInterval(()=>{bcTime--;document.getElementById('bc-round').textContent=bcTime+'s';
if(bcTime<=0){clearInterval(bcTick);showResult(bcScore,'블록 세기',[]);}},1000);bcNext()}
function bcNext(){bcRound++;if(bcTime<=0)return;
const maxH=bcRound<=3?4:bcRound<=6?5:6;const cols=bcRound<=3?3:bcRound<=6?4:5;
const grid=[[]];let total=0;
for(let c=0;c<cols;c++){const h=1+~~(Math.random()*maxH);grid[0][c]=h;total+=h}
const cv=document.getElementById('bc-canvas'),ctx=cv.getContext('2d');
cv.width=280;cv.height=220;ctx.clearRect(0,0,280,220);
const bw=Math.min(50,Math.floor((260-cols*6)/cols)),gap=6;
const totalW=cols*bw+(cols-1)*gap;const startX=(280-totalW)/2;const baseY=210;const bh=32;
const hues=[210,150,35,340,270,100];
for(let c=0;c<cols;c++){const h=grid[0][c];const hue=hues[c%6];
for(let k=0;k<h;k++){const x=startX+c*(bw+gap),y=baseY-(k+1)*bh;
ctx.fillStyle=`hsl(${hue},55%,62%)`;ctx.beginPath();ctx.roundRect(x,y,bw,bh-2,4);ctx.fill();
ctx.fillStyle=`hsl(${hue},55%,72%)`;ctx.fillRect(x+2,y+2,bw-4,6);
ctx.strokeStyle='rgba(0,0,0,.1)';ctx.lineWidth=1;ctx.beginPath();ctx.roundRect(x,y,bw,bh-2,4);ctx.stroke()}}
const opts=new Set([total]);while(opts.size<5){opts.add(total+~~(Math.random()*7)-3)}
const optArr=[...opts].filter(v=>v>0).slice(0,5).sort((a,b)=>a-b);
if(!optArr.includes(total)){optArr[0]=total;optArr.sort((a,b)=>a-b)}
document.getElementById('bc-opts').innerHTML=optArr.map(n=>`<div class="bc-opt" onclick="bcPick(this,${n},${total})">${n}</div>`).join('')}
function bcPick(el,n,ans){if(el.classList.contains('ok')||el.classList.contains('no'))return;
document.querySelectorAll('.bc-opt').forEach(o=>o.style.pointerEvents='none');
if(n===ans){el.classList.add('ok');bcScore+=10;setScore('bc-score',bcScore);toast('정답!')}
else{el.classList.add('no');document.querySelectorAll('.bc-opt').forEach(o=>{if(+o.textContent===ans)o.classList.add('ok')})}
setTimeout(bcNext,600)}

// ===== 29. FLANKER =====
let fkScore,fkTime,fkAns;
function initFlanker(){fkScore=0;fkTime=30;document.getElementById('fk-score').textContent='0점';initHearts('fk');
document.getElementById('fk-timer').textContent='30s';document.getElementById('fk-timer').className='g-timer';
clearInterval(curTimer);curTimer=setInterval(()=>{fkTime--;document.getElementById('fk-timer').textContent=fkTime+'s';
if(fkTime<=10)document.getElementById('fk-timer').className='g-timer urgent';
if(fkTime<=0){clearInterval(curTimer);showResult(fkScore,'방향 맞추기',[])}},1000);fkGen()}
let fkLevel=0;
function fkGen(){const dirs=['←','→','↑','↓'];
const useDirs=fkLevel<5?['←','→']:fkLevel<10?['←','→','↑']:dirs;
const dir=useDirs[~~(Math.random()*useDirs.length)];
let distract;do{distract=useDirs[~~(Math.random()*useDirs.length)]}while(distract===dir);
const sideCount=fkLevel<3?2:fkLevel<7?3:4;
const birdSvg=(d)=>{const rot=d==='→'?0:d==='←'?180:d==='↑'?-90:90;
return `<svg viewBox="0 0 50 30" style="width:50px;height:30px;transform:rotate(${rot}deg)" fill="var(--text)" stroke="none">
<polygon points="50,15 40,12 40,0 35,10 5,10 0,0 5,15 0,30 5,20 35,20 40,30 40,18"/>
</svg>`};
const sides=Array(sideCount).fill(birdSvg(distract)).join('');
document.getElementById('fk-display').innerHTML=sides+birdSvg(dir)+sides;
fkAns=dir==='←'?'left':dir==='→'?'right':dir==='↑'?'up':'down';fkLevel++}
function fkPick(d){if(d===fkAns){fkScore+=10;setScore('fk-score',fkScore);toast('정답!')}
else{curScore=fkScore;if(loseHeart('fk'))return}
setTimeout(fkGen,300)}

// ===== 30. MEMGRID =====
let mgScore,mgLv,mgCells,mgPhase;
function initMemgrid(){mgScore=0;mgLv=1;document.getElementById('mg-score').textContent='0점';document.getElementById('mg-level').textContent='Lv.1';initHearts('mg');mgRound()}
function mgRound(){mgPhase='show';const size=mgLv<=2?3:mgLv<=5?4:5;const count=mgLv+2;
document.getElementById('mg-msg').textContent='칸을 기억하세요!';
const total=size*size;mgCells=[];while(mgCells.length<count){const r=~~(Math.random()*total);if(!mgCells.includes(r))mgCells.push(r)}
const g=document.getElementById('mg-grid');g.style.gridTemplateColumns=`repeat(${size},50px)`;
g.innerHTML=Array.from({length:total},(_,i)=>`<div class="mg-cell" data-i="${i}" style="width:50px;height:50px;border-radius:8px;background:${mgCells.includes(i)?'var(--p)':'var(--border)'};cursor:pointer;transition:background .2s"></div>`).join('');
setTimeout(()=>{if(mgPhase!=='show')return;mgPhase='input';document.getElementById('mg-msg').textContent='기억한 칸을 터치하세요!';
g.querySelectorAll('.mg-cell').forEach(c=>{c.style.background='var(--border)';c.onclick=()=>mgTap(c)})},1200+count*200)}
function mgTap(c){if(mgPhase!=='input')return;const i=+c.dataset.i;
if(mgCells.includes(i)){c.style.background='var(--ok)';c.onclick=null;mgCells=mgCells.filter(x=>x!==i);mgScore+=10;
setScore('mg-score',mgScore);
if(mgCells.length===0){mgLv++;document.getElementById('mg-level').textContent='Lv.'+mgLv;toast('레벨 업!');setTimeout(mgRound,500)}}
else{c.style.background='var(--no)';curScore=mgScore;if(loseHeart('mg'))return;setTimeout(mgRound,800)}}

// ===== 31. NBACK =====
let nbScore,nbRound,nbPrev,nbCur,nbAnswered;
const NB_ITEMS=['A','B','C','D','E','1','2','3','4','5'];
let nbTime;
function initNback(){nbScore=0;nbRound=0;nbPrev=null;nbAnswered=false;nbTime=30;
document.getElementById('nb-score').textContent='0점';document.getElementById('nb-round').textContent='30s';
clearInterval(curTimer);curTimer=setInterval(()=>{nbTime--;document.getElementById('nb-round').textContent=nbTime+'s';
if(nbTime<=10)document.getElementById('nb-round').className='g-timer urgent';
if(nbTime<=0){clearInterval(curTimer);showResult(nbScore,'같거나 다르거나',[])}},1000);nbNext()}
function nbNext(){nbRound++;nbAnswered=false;
const same=nbPrev!==null&&Math.random()<.35;
nbCur=same?nbPrev:NB_ITEMS.filter(x=>x!==nbPrev)[~~(Math.random()*(NB_ITEMS.length-1))];
document.getElementById('nb-card').textContent=nbCur;
document.getElementById('nb-card').style.borderColor='var(--border)';
if(nbPrev===null){document.getElementById('nb-msg').textContent='첫 번째 카드를 기억하세요!';setTimeout(()=>{nbAnswered=true;nbPrev=nbCur;setTimeout(nbNext,400)},1000);return}
document.getElementById('nb-msg').textContent='이전 카드와 같으면 O, 다르면 X'}
function nbPick(isSame){if(nbAnswered)return;nbAnswered=true;
const correct=(nbPrev!==null&&isSame&&nbCur===nbPrev)||(!isSame&&(nbPrev===null||nbCur!==nbPrev));
if(correct){nbScore+=10;setScore('nb-score',nbScore);
document.getElementById('nb-card').style.borderColor='var(--ok)';toast('정답!')}
else{nbScore=Math.max(0,nbScore-5);setScore('nb-score',nbScore);document.getElementById('nb-card').style.borderColor='var(--no)';toast('-5점')}
nbPrev=nbCur;setTimeout(nbNext,600)}

// ===== 32. SCRAMBLE =====
let scScore,scTime;
const SC_WORDS=[
// 2글자 (80)
'사과','포도','수박','딸기','기차','버스','학교','병원','공원','피자','치킨','라면','축구','야구','농구','배구','음악','미술','과학','수학','토끼','바다','여행','안경','모자','구름','나비','시계','우산','거울','창문','의자','연필','지구','우주','가방','신발','양말','장갑','모래','바람','이슬','노을','저녁','아침','점심','책상','칠판','분필','공책','가위','풀칠','색연','도장','상자','열쇠','자물','편지','봉투','우표','택배','선물','꽃병','화분','잔디','나무','숲길','계단','지붕','벽돌','타일','기둥','울타','다리','터널','항구','등대','파도','조개',
// 3글자 (100)
'바나나','오렌지','자동차','비행기','도서관','우체국','컴퓨터','전화기','냉장고','세탁기','거북이','코끼리','원숭이','고양이','강아지','햄버거','테니스','선인장','소방차','경찰차','구급차','초콜릿','운동장','수영장','놀이터','호랑이','미술관','박물관','수족관','고구마','감자탕','해바라기','사탕수수','김치찌개','된장찌개','비빔밥','떡볶이','잡채밥','삼겹살','불고기','갈비탕','설렁탕','냉면집','칼국수','만두국','주먹밥','김밥집','라면집','카페인','에너지','비타민','단백질','탄수화물','지방산','아미노산','산소통','이산화탄소','헬리콥터','잠수함','요트선','돛단배','스케이트','스키장','볼링장','당구장','탁구공','배드민턴','마라톤','트라이','철인삼','축구장','농구장','야구장','테니스장','골프장','수영복','운동화','등산화','장화신','슬리퍼','샌들신','목도리','귀마개','손난로','핫초코','아메리카노','카푸치노','에스프레소','라떼아트','밀크티','녹차라떼','딸기쥬스','오렌지쥬스','포도쥬스','망고쥬스','레모네이드','탄산수','생수통','보리차','옥수수차',
// 4글자 (70)
'텔레비전','백화점','유치원생','초등학생','고등학생','운동선수','프로그래머','디자이너','피아니스트','바이올린','아이스크림','미끄럼틀','카멜레온','크리스마스','발렌타인','스마트폰','인스타그램','에스컬레이터','롤러코스터','트램펄린','회전목마','관람차','대관람차','워터파크','놀이공원','동물원','식물원','천문대','전망대','도서관','수영장','체육관','볼링장','노래방','영화관','음악실','과학실','미술실','컴퓨터실','운동장','강당','교무실','보건실','급식실','도서실','상담실','방송실','주차장','엘리베이터','에어컨','선풍기','가습기','제습기','공기청정기','전자레인지','식기세척기','건조기','청소기','다리미','믹서기','토스터','커피머신','정수기','냉온수기','안마의자','러닝머신','자전거','킥보드','오토바이',
// 5글자+ (50)
'할로윈파티','올림픽경기','월드컵축구','블루투스','해돋이','무지개','태블릿','노트북','헤드폰','인터넷','유튜브','롤러블레이드','스노보드','스카이다이빙','번지점프','패러글라이딩','카약타기','서핑보드','윈드서핑','제트스키','수상스키','스쿠버다이빙','열기구타기','행글라이더','경비행기','드론촬영','인공지능','가상현실','증강현실','사물인터넷','빅데이터','클라우드','블록체인','메타버스','자율주행','전기자동차','수소자동차','태양광발전','풍력발전','지열발전','원자력발전','재활용센터','정수처리장','하수처리장','기상관측소','천문관측소','해양연구소','우주정거장','인공위성','화성탐사선'];
let scLevel,scQTimer,scQTime,scQLimit;
function initScramble(){scScore=0;scTime=30;scLevel=0;document.getElementById('sc-score').textContent='0점';
document.getElementById('sc-timer').textContent='30s';document.getElementById('sc-timer').className='g-timer';
initHearts('sc');
clearInterval(curTimer);curTimer=setInterval(()=>{scTime--;document.getElementById('sc-timer').textContent=scTime+'s';
if(scTime<=10)document.getElementById('sc-timer').className='g-timer urgent';
if(scTime<=0){clearInterval(curTimer);clearInterval(scQTimer);showResult(scScore,'글자 섞기',[])}},1000);scGen()}
function scGen(){const minLen=scLevel<4?2:scLevel<8?3:scLevel<14?4:5;
const pool=SC_WORDS.filter(w=>w.length>=minLen);
const word=pool[~~(Math.random()*pool.length)];scLevel++;
const chars=[...word];const shuffled=[...chars].sort(()=>Math.random()-.5);
if(shuffled.join('')===word)shuffled.reverse();
document.getElementById('sc-scrambled').innerHTML=shuffled.map(c=>`<span style="background:var(--card);border-radius:8px;padding:8px 14px;box-shadow:var(--shadow)">${c}</span>`).join('');
const sameLen=SC_WORDS.filter(w=>w.length===word.length&&w!==word);
const diffLen=SC_WORDS.filter(w=>w!==word&&w.length!==word.length);
const decoys=[...sameLen].sort(()=>Math.random()-.5).slice(0,3);
while(decoys.length<3&&diffLen.length){const idx=~~(Math.random()*diffLen.length);decoys.push(diffLen.splice(idx,1)[0])}
const opts=[word,...decoys].sort(()=>Math.random()-.5);
document.getElementById('sc-opts').innerHTML=opts.map(o=>`<div class="sf-opt" onclick="scPick(this,'${o}','${word}')">${o}</div>`).join('');
// Per-question timer: 3s → 1.5s
scQLimit=Math.max(1.5, 3.0 - scLevel*0.08);
scQTime=scQLimit;clearInterval(scQTimer);
const bar=document.getElementById('sc-qbar');if(bar){bar.style.transition='none';bar.style.width='100%';requestAnimationFrame(()=>{bar.style.transition=`width ${scQLimit}s linear`;bar.style.width='0%'})}
scQTimer=setInterval(()=>{scQTime-=0.1;if(scQTime<=0){clearInterval(scQTimer);curScore=scScore;if(loseHeart('sc'))return;setTimeout(scGen,300)}},100)}
function scPick(el,picked,ans){if(el.classList.contains('ok')||el.classList.contains('no'))return;
clearInterval(scQTimer);
if(picked===ans){el.classList.add('ok');const pct=scQTime/scQLimit;const bonus=pct>.75?5:pct>.5?3:1;scScore+=10+bonus;setScore('sc-score',scScore)}
else{el.classList.add('no');document.querySelectorAll('#sc-opts .sf-opt').forEach(o=>{if(o.textContent===ans)o.classList.add('ok')});curScore=scScore;if(loseHeart('sc'))return}
setTimeout(scGen,500)}

// ===== 33. SERIAL =====
let srScore,srTime,srNum,srSub;
function initSerial(){srScore=0;srTime=30;srNum=100;srSub=3+~~(Math.random()*6);
document.getElementById('sr-score').textContent='0점';document.getElementById('sr-timer').textContent='30s';document.getElementById('sr-timer').className='g-timer';
clearInterval(curTimer);curTimer=setInterval(()=>{srTime--;document.getElementById('sr-timer').textContent=srTime+'s';
if(srTime<=10)document.getElementById('sr-timer').className='g-timer urgent';
if(srTime<=0){clearInterval(curTimer);showResult(srScore,'연속 빼기',[])}},1000);srGen()}
function srGen(){document.getElementById('sr-q').textContent=`−${srSub}을(를) 계속 빼세요`;
document.getElementById('sr-num').textContent=srNum;
const ans=srNum-srSub;const opts=new Set([ans]);
while(opts.size<6){opts.add(ans+~~(Math.random()*7)-3)}
const arr=[...opts].filter(v=>v>=0).slice(0,6);if(!arr.includes(ans)){arr[0]=ans}
arr.sort((a,b)=>a-b);
document.getElementById('sr-opts').innerHTML=arr.map(n=>`<div class="bc-opt" onclick="srPick(this,${n},${ans})">${n}</div>`).join('')}
function srPick(el,n,ans){if(el.classList.contains('ok')||el.classList.contains('no'))return;
document.querySelectorAll('#sr-opts .bc-opt').forEach(o=>o.style.pointerEvents='none');
if(n===ans){el.classList.add('ok');srScore+=10;srNum=ans;setScore('sr-score',srScore);toast('정답!');
if(srNum<=0){srNum=100;srSub=3+~~(Math.random()*6);srScore+=20;toast('+20 보너스! 새 시작')}}
else{el.classList.add('no');document.querySelectorAll('#sr-opts .bc-opt').forEach(o=>{if(+o.textContent===ans)o.classList.add('ok')})}
setTimeout(srGen,500)}

// ===== 34. LEFTRIGHT =====
let lrScore,lrTime,lrAns,lrTotal=0,lrQTimer,lrQTime,lrQLimit;
function initLeftright(){lrScore=0;lrTime=30;document.getElementById('lr-score').textContent='0점';initHearts('lr');
document.getElementById('lr-timer').textContent='30s';document.getElementById('lr-timer').className='g-timer';
clearInterval(curTimer);curTimer=setInterval(()=>{lrTime--;document.getElementById('lr-timer').textContent=lrTime+'s';
if(lrTime<=10)document.getElementById('lr-timer').className='g-timer urgent';
if(lrTime<=0){clearInterval(curTimer);showResult(lrScore,'좌우 판단',[])}},1000);lrGen()}
function lrGen(){const isLeft=Math.random()<.5;const rot=[0,90,180,270][~~(Math.random()*4)];
const isPalm=Math.random()<.5;
lrAns=isLeft?'left':'right';
const hand=document.getElementById('lr-hand');
// 1인칭 시점 (내 손을 내가 봄)
// 오른손 손바닥: 엄지 오른쪽 | 오른손 손등: 엄지 왼쪽
// 왼손 손바닥: 엄지 왼쪽   | 왼손 손등: 엄지 오른쪽
// Base SVG: 엄지 왼쪽 → 오른손 손등 = 그대로, 오른손 손바닥 = flip
const flipX=isPalm?!isLeft:isLeft;
const detail=isPalm?
`<path d="M30 55c10 3 20 3 30 0" stroke="var(--sub)" stroke-width="1" opacity=".5"/><path d="M28 65c12 2 22 2 32 0" stroke="var(--sub)" stroke-width="1" opacity=".5"/>`:
`<path d="M32 22c0 1.5 1 2.5 2.5 2.5" stroke="var(--sub)" stroke-width="1.5"/><path d="M42 18c0 1.5 1 2.5 2.5 2.5" stroke="var(--sub)" stroke-width="1.5"/><path d="M52 20c0 1.5 1 2.5 2.5 2.5" stroke="var(--sub)" stroke-width="1.5"/><path d="M62 26c0 1.5 1 2.5 2.5 2.5" stroke="var(--sub)" stroke-width="1.5"/>`;
const thumbColor='var(--text)';
hand.innerHTML=`<div style="display:inline-block;position:relative"><svg viewBox="0 0 80 100" fill="none" stroke="var(--text)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="width:140px;height:175px;transform:rotate(${rot}deg) ${flipX?'scaleX(-1)':''}">
<path d="M25 90c-8 0-12-5-12-14V42"/><path d="M60 90c8 0 10-6 10-14V38"/><path d="M25 90h35"/>
<path d="M25 42V20c0-3 2-5 5-5s5 2 5 5v22"/><path d="M35 40V16c0-3 2-5 5-5s5 2 5 5v24"/>
<path d="M45 42V18c0-3 2-5 5-5s5 2 5 5v24"/><path d="M55 44V24c0-3 2-5 5-5s5 2 5 5v20"/>
<path d="M25 55c-4 0-10-2-15-2c-4 0-6 2-6 5s2 5 6 5c5 0 11 0 15 0" stroke-width="3" fill="${thumbColor}" fill-opacity=".2" stroke="${thumbColor}"/>
${detail}</svg>
<div style="position:absolute;bottom:-8px;left:50%;transform:translateX(-50%);font-size:12px;font-weight:700;color:var(--sub);white-space:nowrap;background:var(--bg);padding:2px 10px;border-radius:var(--r-full)">${isPalm?'손바닥':'손등'}</div></div>`;
document.getElementById('lr-msg').textContent=rot===0?'이 손은?':'돌아간 이 손은?'}
function lrPick(d){if(d===lrAns){lrScore+=10;setScore('lr-score',lrScore);toast('정답!')}
else{curScore=lrScore;if(loseHeart('lr'))return}
setTimeout(lrGen,300)}

// ===== 35. CALCCOMP =====
let cc2Score,cc2Time,cc2ValA,cc2ValB;
function initCalccomp(){cc2Score=0;cc2Time=30;document.getElementById('cc2-score').textContent='0점';initHearts('cc2');
document.getElementById('cc2-timer').textContent='30s';document.getElementById('cc2-timer').className='g-timer';
clearInterval(curTimer);curTimer=setInterval(()=>{cc2Time--;document.getElementById('cc2-timer').textContent=cc2Time+'s';
if(cc2Time<=10)document.getElementById('cc2-timer').className='g-timer urgent';
if(cc2Time<=0){clearInterval(curTimer);showResult(cc2Score,'계산 비교',[])}},1000);cc2Gen()}
function cc2Gen(){function mkExpr(){const ops=['+','-','×'];const op=ops[~~(Math.random()*3)];
let a=2+~~(Math.random()*15),b=2+~~(Math.random()*15),val;
if(op==='×'){a=2+~~(Math.random()*9);b=2+~~(Math.random()*9);val=a*b}
else if(op==='-'){if(b>a)[a,b]=[b,a];val=a-b}else{val=a+b}
return {text:a+' '+op+' '+b,val}}
const exA=mkExpr(),exB=mkExpr();
if(exA.val===exB.val)exB.val++;
cc2ValA=exA.val;cc2ValB=exB.val;
document.getElementById('cc2-a').textContent=exA.text;document.getElementById('cc2-b').textContent=exB.text;
document.getElementById('cc2-a').style.borderColor='var(--border)';document.getElementById('cc2-b').style.borderColor='var(--border)'}
function cc2Pick(side){const correct=(side==='left'&&cc2ValA>cc2ValB)||(side==='right'&&cc2ValB>cc2ValA);
const el=document.getElementById(side==='left'?'cc2-a':'cc2-b');
if(correct){el.style.borderColor='var(--ok)';cc2Score+=10;setScore('cc2-score',cc2Score);toast('정답!')}
else{el.style.borderColor='var(--no)';curScore=cc2Score;if(loseHeart('cc2'))return}
setTimeout(cc2Gen,400)}

// ===== 36. FLASH =====
let flScore,flLv,flAnswer;
function initFlash(){flScore=0;flLv=1;document.getElementById('fl-score').textContent='0점';document.getElementById('fl-level').textContent='Lv.1';initHearts('fl');flRound()}
function flRound(){const len=Math.floor(flLv/2)+3;flAnswer='';for(let i=0;i<len;i++)flAnswer+=~~(Math.random()*10);
document.getElementById('fl-msg').textContent='숫자를 기억하세요!';
const flD=document.getElementById('fl-display');flD.textContent=flAnswer;flD.style.fontSize=(len<=5?56:len<=7?42:len<=9?32:24)+'px';document.getElementById('fl-input').innerHTML='';
const showTime=800+len*150;
setTimeout(()=>{
document.getElementById('fl-msg').textContent='무슨 숫자였을까요?';
const keys=[1,2,3,4,5,6,7,8,9,'←',0,'OK'];
document.getElementById('fl-input').innerHTML=`<div class="numpad" style="grid-template-columns:repeat(4,1fr)">${[1,2,3,4,5,6,7,8,9,0].map(k=>`<button class="nbtn" onclick="flKey('${k}')">${k}</button>`).join('')}<button class="nbtn del" onclick="flKey('DEL')">⌫</button><button class="nbtn go" onclick="flKey('OK')">확인</button></div>`;
window._flInput='';window._flLen=len;flUpdateDisplay()},showTime)}
function flUpdateDisplay(){const len=window._flLen;const inp=window._flInput;
let txt='';for(let i=0;i<len;i++){txt+=i<inp.length?inp[i]:'_'}
const d=document.getElementById('fl-display');
d.innerHTML=txt.split('').map((c,i)=>`<span style="display:inline-block;width:36px;text-align:center;${i<inp.length?'color:var(--p)':'color:var(--sub);opacity:.4'}">${c}</span>`).join('')}
function flKey(k){if(k==='←'){window._flInput=window._flInput.slice(0,-1);flUpdateDisplay()}
else if(k==='OK'){if(window._flInput===flAnswer){flScore+=10+flLv*5;flLv++;
setScore('fl-score',flScore);document.getElementById('fl-level').textContent='Lv.'+flLv;toast('정답!')}
else{document.getElementById('fl-display').textContent=flAnswer;document.getElementById('fl-display').style.color='var(--no)';curScore=flScore;if(loseHeart('fl')){return}setTimeout(()=>{document.getElementById('fl-display').style.color='';flRound()},800);return}
setTimeout(flRound,500);return}
else if(window._flInput.length<window._flLen){window._flInput+=k;flUpdateDisplay();
if(window._flInput.length===window._flLen){setTimeout(()=>flKey('OK'),300)}}}

// ===== 37. SORT =====
let stScore,stTime,stCatA,stCatB,stItems,stAns;
const SORT_CATS=[
{name:'과일',items:['사과','배','포도','수박','딸기','복숭아','감','귤']},
{name:'동물',items:['강아지','고양이','토끼','코끼리','사자','호랑이','곰','여우']},
{name:'색깔',items:['빨강','파랑','노랑','초록','보라','주황','분홍','하양']},
{name:'나라',items:['한국','일본','미국','영국','프랑스','중국','독일','호주']},
{name:'음식',items:['김치','불고기','피자','햄버거','라면','초밥','파스타','떡볶이']},
{name:'악기',items:['피아노','기타','바이올린','드럼','플루트','첼로','하프','트럼펫']},
{name:'스포츠',items:['축구','야구','농구','테니스','수영','골프','탁구','배구']},
{name:'탈것',items:['자동차','버스','기차','비행기','배','자전거','택시','오토바이']}];
function initSort(){stScore=0;stTime=30;document.getElementById('st-score').textContent='0점';
document.getElementById('st-timer').textContent='30s';document.getElementById('st-timer').className='g-timer';
const pair=[...SORT_CATS].sort(()=>Math.random()-.5).slice(0,2);stCatA=pair[0];stCatB=pair[1];
document.getElementById('st-cat1').textContent=stCatA.name;document.getElementById('st-cat2').textContent=stCatB.name;
document.getElementById('st-btn1').textContent=stCatA.name;document.getElementById('st-btn2').textContent=stCatB.name;
clearInterval(curTimer);curTimer=setInterval(()=>{stTime--;document.getElementById('st-timer').textContent=stTime+'s';
if(stTime<=10)document.getElementById('st-timer').className='g-timer urgent';
if(stTime<=0){clearInterval(curTimer);showResult(stScore,'카테고리 분류',[])}},1000);stGen()}
function stGen(){stAns=Math.random()<.5?0:1;
const cat=stAns===0?stCatA:stCatB;
document.getElementById('st-word').textContent=cat.items[~~(Math.random()*cat.items.length)]}
let stCombo=0,stSwaps=0;
function stPick(idx){if(idx===stAns){stCombo++;stScore+=10+(stCombo>=5?10:0);setScore('st-score',stScore);
if(stCombo>=8&&stSwaps<3){stSwaps++;const pair=[...SORT_CATS].sort(()=>Math.random()-.5).slice(0,2);stCatA=pair[0];stCatB=pair[1];
document.getElementById('st-cat1').textContent=stCatA.name;document.getElementById('st-cat2').textContent=stCatB.name;
document.getElementById('st-btn1').textContent=stCatA.name;document.getElementById('st-btn2').textContent=stCatB.name;
stCombo=0;toast('카테고리 변경!')}}
else{stCombo=0;stScore=Math.max(0,stScore-5);setScore('st-score',stScore)}
setTimeout(stGen,250)}

// ===== 38. MIRROR =====
let mrScore,mrTime,mrAns;
const MR_CHARS='가나다라마바사아자차카타파하거너더러머버서어저커터퍼허고노도로모보소오조코토포호구누두루무부수우주쿠투푸후'.split('');
function initMirror(){mrScore=0;mrTime=30;document.getElementById('mr-score').textContent='0점';initHearts('mr');
document.getElementById('mr-timer').textContent='30s';document.getElementById('mr-timer').className='g-timer';
clearInterval(curTimer);curTimer=setInterval(()=>{mrTime--;document.getElementById('mr-timer').textContent=mrTime+'s';
if(mrTime<=10)document.getElementById('mr-timer').className='g-timer urgent';
if(mrTime<=0){clearInterval(curTimer);showResult(mrScore,'거울 문자',[])}},1000);mrGen()}
let mrLevel=0;
function mrGen(){mrAns=MR_CHARS[~~(Math.random()*MR_CHARS.length)];
const ch=document.getElementById('mr-char');ch.textContent=mrAns;
const transforms=['scaleX(-1)','scaleY(-1)','scaleX(-1) scaleY(-1)','rotate(180deg)','scaleX(-1) rotate(90deg)'];
const maxT=mrLevel<3?1:mrLevel<6?3:5;
ch.style.transform=transforms[~~(Math.random()*maxT)];mrLevel++;
const opts=new Set([mrAns]);while(opts.size<4){opts.add(MR_CHARS[~~(Math.random()*MR_CHARS.length)])}
document.getElementById('mr-opts').innerHTML=[...opts].sort(()=>Math.random()-.5).map(c=>
`<div class="bc-opt" onclick="mrPick(this,'${c}')" style="font-size:24px;padding:16px">${c}</div>`).join('')}
function mrPick(el,c){if(el.classList.contains('ok')||el.classList.contains('no'))return;
if(c===mrAns){el.classList.add('ok');mrScore+=10;setScore('mr-score',mrScore);toast('정답!')}
else{el.classList.add('no');document.querySelectorAll('#mr-opts .bc-opt').forEach(o=>{if(o.textContent===mrAns)o.classList.add('ok')});
curScore=mrScore;if(loseHeart('mr'))return}
setTimeout(mrGen,400)}

// ===== INIT =====
renderHome();
</script>
</body>
</html>
